<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="WordPress Plugin - File Manager 任意文件上传漏洞一、漏洞简介FileManager是一个WordPress插件，由于函数处理不严谨，可构造恶意请求包上传任意文件。漏洞主要因为FileManager插件中的elFinder库的调用未进行严格访问控制触发，导致可以被直接利用 二、漏洞影响免费版受影响版本：V6.0-V6.8 Pro版受影响版本：V7.6-V7.0 三、复">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Wordpress/Wordpress%20%E6%8F%92%E4%BB%B6%E6%BC%8F%E6%B4%9E/WordPress%20Plugin%20-%20File%20Manager%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="WordPress Plugin - File Manager 任意文件上传漏洞一、漏洞简介FileManager是一个WordPress插件，由于函数处理不严谨，可构造恶意请求包上传任意文件。漏洞主要因为FileManager插件中的elFinder库的调用未进行严格访问控制触发，导致可以被直接利用 二、漏洞影响免费版受影响版本：V6.0-V6.8 Pro版受影响版本：V7.6-V7.0 三、复">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId25.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId26.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId27.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId28.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId29.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId30.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId31.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId32.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId33.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId34.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId35.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId36.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId37.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId38.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId39.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId40.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId41.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId42.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId43.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId44.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId45.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId46.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId47.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId48.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId49.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId51.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId52.png">
<meta property="article:published_time" content="2022-07-08T06:26:07.104Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.401Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId25.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Wordpress/Wordpress 插件漏洞/WordPress Plugin - File Manager 任意文件上传漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Wordpress/Wordpress%20%E6%8F%92%E4%BB%B6%E6%BC%8F%E6%B4%9E/WordPress%20Plugin%20-%20File%20Manager%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:26:07.104Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="WordPress-Plugin-File-Manager-任意文件上传漏洞"><a href="#WordPress-Plugin-File-Manager-任意文件上传漏洞" class="headerlink" title="WordPress Plugin - File Manager 任意文件上传漏洞"></a>WordPress Plugin - File Manager 任意文件上传漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>File<br>Manager是一个WordPress插件，由于函数处理不严谨，可构造恶意请求包上传任意文件。漏洞主要因为File<br>Manager插件中的elFinder库的调用未进行严格访问控制触发，导致可以被直接利用</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>免费版受影响版本：V6.0-V6.8</p>
<p>Pro版受影响版本：V7.6-V7.0</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>漏洞点位于file<br>manager的connector.minimal.php文件，具体路径在<code>wordpress\wp-content\plugins\wp-file-manager\lib\php\connector.minimal.php</code></p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId25.png" alt="1.png"></p>
<p>首先实例化一个<code>elFinderConnector</code>对象，然后调用它的<code>run()</code>方法，跟进run();</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId26.png" alt="2.png"></p>
<p>如果HTTP请求的方法是<code>POST</code>，会把<code>POST</code>和<code>GET</code>请求的数据保存到<code>$src</code>，然后判断<code>POST</code>传的参数。如果不传入<code>targets</code>，就不会进入前几个判断，之后会把<code>POST</code>请求传的<code>cmd</code>变量赋给<code>$cmd</code>，然后调用<code>commandExists()</code>检测传入的<code>$cmd</code>是否存在。</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId27.png" alt="3.png"></p>
<p>然后利用<code>commandArgsList()</code>函数获取<code>$cmd</code>对应的命令参数列表，漏洞利用需要上传文件，这里只关注<code>$cmd</code>为<code>upload</code>的情况。</p>
<pre><code>public function commandArgsList($cmd)
&#123;
        if ($this-&gt;commandExists($cmd)) &#123;
            $list = $this-&gt;commands[$cmd];
            $list[&#39;reqid&#39;] = false;
        &#125; else &#123;
            $list = array();
        &#125;
        return $list;
&#125;
/*upload对应的数组如下:
&#39;upload&#39; =&gt; array(
    &#39;target&#39; =&gt; true, &#39;FILES&#39; =&gt; true, &#39;mimes&#39; =&gt; false, &#39;html&#39; =&gt; false, &#39;upload&#39; =&gt; false, 
    &#39;name&#39; =&gt; false, &#39;upload_path&#39; =&gt; false, &#39;chunk&#39; =&gt; false, &#39;cid&#39; =&gt; false, &#39;node&#39; =&gt; false, 
    &#39;renames&#39; =&gt; false, &#39;hashes&#39; =&gt; false, &#39;suffix&#39; =&gt; false, &#39;mtime&#39; =&gt; false, &#39;overwrite&#39; =&gt; false, 
    &#39;contentSaveId&#39; =&gt; false)
    */
</code></pre>
<p>循环遍历，将<code>POST</code>传入的参数保存到<code>$args</code>数组中，然后调用<code>input_filter()</code>函数对<code>$args</code>进行简单的过滤，</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId28.png" alt="4.png"></p>
<p>替换掉<code>%00</code>，并且做<code>stripslashes()</code>处理。然后将通过表单上传的文件<code>$_FILES</code>存到<code>$args[&#39;FILE&#39;]</code>中。然后调用<code>exec()</code>函数，跟进</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId29.png" alt="5.png"></p>
<p>前面会进行一些判断，最后进入到<code>$this-&gt;$cmd($args)</code>调用<code>upload()</code>函数，跟进</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId30.png" alt="6.png"></p>
<p>首先将<code>POST</code>传入的<code>target</code>赋给<code>$target</code>变量，然后调用<code>volume()</code>函数，</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId31.png" alt="7.png"></p>
<p>可以看到<code>$this-&gt;volume</code>数组含有两项，一项是<code>l1_</code>，一项是<code>t1_</code>，<code>volume()</code>函数定义如果传入的<code>$hash</code>以<code>l1_</code>或<code>t1_</code>开头，返回<code>$this-&gt;volume</code>数组对应的值，否则返回false。在<code>upload</code>函数中会检测<code>$volume</code>，如果其为false，程序会报错结束，所以<code>POST</code>传入的<code>target</code>必须以它们两个为前缀。继续分析upload()函数。依次取出<code>$args</code>数组中的值赋给相应的变量，这里要求<code>$args[&#39;FILES&#39;][&#39;upload&#39;]</code>也就是<code>$_FILES[&#39;upload&#39;]</code>为数组，才能将其赋给<code>$files</code>变量，这就需要上传文件时上传一个文件数组。接下来其他的如<code>html、upload_path、chunk、cid、mtime</code>等参数可以不传。之后遍历<code>$files[&#39;name&#39;]</code>也就是<code>$_FILES[&#39;upload&#39;][&#39;name&#39;]</code>，如果文件上传成功，将<code>$_FILES[&#39;upload&#39;][&#39;name&#39;]</code>赋给<code>$tmpname</code>，然后调用<code>fopen()</code>打开上传的临时文件，将指针保存在<code>$fp</code>。在不传入<code>upload_path</code>时<code>$thash</code>等于<code>$target</code>，所以<code>$_target</code>为<code>$target</code>为我们<code>POST</code>传入的<code>target</code>变量。之后调用了<code>$volume-&gt;upload()</code>函数，第一个参数为之前打开文件的指针，第二个参数为<code>POST</code>传入的<code>target</code>变量，第三个参数为上传的文件名，第四个参数为空的数组。跟进<code>elFinderVolumeDriver</code>的<code>upload()</code></p>
<pre><code>public function upload($fp, $dst, $name, $tmpname, $hashes = array())
&#123;
        if ($this-&gt;commandDisabled(&#39;upload&#39;)) &#123;
            return $this-&gt;setError(elFinder::ERROR_PERM_DENIED);
        &#125;

        if (($dir = $this-&gt;dir($dst)) == false) &#123;
            return $this-&gt;setError(elFinder::ERROR_TRGDIR_NOT_FOUND, &#39;#&#39; . $dst);
        &#125;

        if (empty($dir[&#39;write&#39;])) &#123;
            return $this-&gt;setError(elFinder::ERROR_PERM_DENIED);
        &#125;

        if (!$this-&gt;nameAccepted($name, false)) &#123;
            return $this-&gt;setError(elFinder::ERROR_INVALID_NAME);
        &#125;

        $mimeByName = &#39;&#39;;
        if ($this-&gt;mimeDetect === &#39;internal&#39;) &#123;
            $mime = $this-&gt;mimetype($tmpname, $name);
        &#125; else &#123;
            $mime = $this-&gt;mimetype($tmpname, $name);
            $mimeByName = $this-&gt;mimetype($name, true);
            if ($mime === &#39;unknown&#39;) &#123;
                $mime = $mimeByName;
            &#125;
        &#125;

        if (!$this-&gt;allowPutMime($mime) || ($mimeByName &amp;&amp; !$this-&gt;allowPutMime($mimeByName))) &#123;
            return $this-&gt;setError(elFinder::ERROR_UPLOAD_FILE_MIME, &#39;(&#39; . $mime . &#39;)&#39;);
        &#125;

        $tmpsize = (int)sprintf(&#39;%u&#39;, filesize($tmpname));
        if ($this-&gt;uploadMaxSize &gt; 0 &amp;&amp; $tmpsize &gt; $this-&gt;uploadMaxSize) &#123;
            return $this-&gt;setError(elFinder::ERROR_UPLOAD_FILE_SIZE);
        &#125;

        $dstpath = $this-&gt;decode($dst);
        if (isset($hashes[$name])) &#123;
            $test = $this-&gt;decode($hashes[$name]);
            $file = $this-&gt;stat($test);
        &#125; else &#123;
            $test = $this-&gt;joinPathCE($dstpath, $name);
            $file = $this-&gt;isNameExists($test);
        &#125;

        $this-&gt;clearcache();

        if ($file &amp;&amp; $file[&#39;name&#39;] === $name) &#123; // file exists and check filename for item ID based filesystem
            if ($this-&gt;uploadOverwrite) &#123;
                if (!$file[&#39;write&#39;]) &#123;
                    return $this-&gt;setError(elFinder::ERROR_PERM_DENIED);
                &#125; elseif ($file[&#39;mime&#39;] == &#39;directory&#39;) &#123;
                    return $this-&gt;setError(elFinder::ERROR_NOT_REPLACE, $name);
                &#125;
                $this-&gt;remove($test);
            &#125; else &#123;
                $name = $this-&gt;uniqueName($dstpath, $name, &#39;-&#39;, false);
            &#125;
        &#125;

        $stat = array(
            &#39;mime&#39; =&gt; $mime,
            &#39;width&#39; =&gt; 0,
            &#39;height&#39; =&gt; 0,
            &#39;size&#39; =&gt; $tmpsize);

        // $w = $h = 0;
        if (strpos($mime, &#39;image&#39;) === 0 &amp;&amp; ($s = getimagesize($tmpname))) &#123;
            $stat[&#39;width&#39;] = $s[0];
            $stat[&#39;height&#39;] = $s[1];
        &#125;
        // $this-&gt;clearcache();
        if (($path = $this-&gt;saveCE($fp, $dstpath, $name, $stat)) == false) &#123;
            return false;
        &#125;

        $stat = $this-&gt;stat($path);
        // Try get URL
        if (empty($stat[&#39;url&#39;]) &amp;&amp; ($url = $this-&gt;getContentUrl($stat[&#39;hash&#39;]))) &#123;
            $stat[&#39;url&#39;] = $url;
        &#125;

        return $stat;
&#125;
</code></pre>
<p>首先进入<code>commandDisabled()</code>函数，返回false。</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId32.png" alt="8.png"></p>
<p>然后进入<code>dir()</code>函数，参数为<code>$dst</code>即<code>POST</code>传入的<code>target</code>值。</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId33.png" alt="9.png"></p>
<p>调用了file函数，</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId34.png" alt="10.png"></p>
<p>跟进<code>decode()</code>函数</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId35.png" alt="11.png"></p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId36.png" alt="12.png"></p>
<p><code>decode()</code>函数首先判断是否以<code>$this-&gt;id</code>开头，然后截取出<code>l1_</code>后面的内容，之后进行base64解密，uncrypt函数如上，未作操作。然后更换分隔符，之后调用<code>abspathCE()</code>函数，从注释中可以看出，<code>abspathCE()</code>函数会先判断<code>$path</code>是否等于分隔符<code>\</code>,如果等于，返回<code>$this-&gt;root</code>，否则返回<code>$this-&gt;root</code>拼接<code>$path</code>。看下对应的<code>abspathCE()</code>函数。</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId37.png" alt="13.png"></p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId38.png" alt="14.png"></p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId39.png" alt="15.png"></p>
<blockquote>
<p>ps：POST传入target前缀不同的区别</p>
</blockquote>
<ul>
<li>前缀为<code>l1_</code>时，<code>$this-&gt;root</code><br>  为<code>C:\Users\admin\phpstudy_pro\WWW\wordpress\wp-content\plugins\wp-file-manager\lib\files</code></li>
</ul>
<blockquote>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId40.png" alt="16.png">{width=”5.833333333333333in”<br>height=”2.864215879265092in”}</p>
</blockquote>
<ul>
<li>前缀为<code>t1_</code>时，<code>$this-&gt;disabled[]</code>包含<code>upload</code>，程序会报错结束，<code>$this-&gt;root</code><br>  为<code>C:\Users\admin\phpstudy_pro\WWW\wordpress\wp-content\plugins\wp-file-manager\lib\files\.trash</code></li>
</ul>
<blockquote>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId41.png" alt="17.png">{width=”5.833333333333333in”<br>height=”4.630450568678915in”}</p>
</blockquote>
<p>继续分析程序流程，<code>decode()</code>函数会返回<code>C:\Users\admin\phpstudy_pro\WWW\wordpress\wp-content\plugins\wp-file-manager\lib\files</code>,然后调用<code>stat()</code>函数。</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId42.png" alt="18.png"></p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId43.png" alt="19.png"></p>
<p>stat()函数返回的<code>$ret</code>为</p>
<pre><code>Array
(
    [isowner] =&gt; 
    [ts] =&gt; 1589423646
    [mime] =&gt; directory
    [read] =&gt; 1
    [write] =&gt; 1
    [size] =&gt; 0
    [hash] =&gt; l1_Lw
    [name] =&gt; files
    [rootRev] =&gt; 
    [options] =&gt; Array
        (
            [path] =&gt; 
            [url] =&gt; /wordpress/wp-content/plugins/wp-file-manager/lib/php/../files/
            [tmbUrl] =&gt; /wordpress/wp-content/plugins/wp-file-manager/lib/php/../files/.tmb/
            [disabled] =&gt; Array
                (
                    [0] =&gt; chmod
                )

            [separator] =&gt;                 [copyOverwrite] =&gt; 1
            [uploadOverwrite] =&gt; 1
            [uploadMaxSize] =&gt; 9223372036854775807
            [uploadMaxConn] =&gt; 3
            [uploadMime] =&gt; Array
                (
                    [firstOrder] =&gt; deny
                    [allow] =&gt; Array
                        (
                            [0] =&gt; all
                        )

                    [deny] =&gt; Array
                        (
                            [0] =&gt; all
                        )

                )

            [dispInlineRegex] =&gt; ^(?:(?:video|audio)|image/(?!.+\+xml)|application/(?:ogg|x-mpegURL|dash\+xml)|(?:text/plain|application/pdf)$)
            [jpgQuality] =&gt; 100
            [archivers] =&gt; Array
                (
                    [create] =&gt; Array
                        (
                            [0] =&gt; application/x-tar
                            [1] =&gt; application/zip
                        )

                    [extract] =&gt; Array
                        (
                            [0] =&gt; application/x-tar
                            [1] =&gt; application/zip
                        )

                    [createext] =&gt; Array
                        (
                            [application/x-tar] =&gt; tar
                            [application/zip] =&gt; zip
                        )

                )

            [uiCmdMap] =&gt; Array
                (
                )

            [syncChkAsTs] =&gt; 1
            [syncMinMs] =&gt; 10000
            [i18nFolderName] =&gt; 0
            [tmbCrop] =&gt; 1
            [tmbReqCustomData] =&gt; 
            [substituteImg] =&gt; 1
            [onetimeUrl] =&gt; 1
            [trashHash] =&gt; t1_Lw
            [csscls] =&gt; elfinder-navbar-root-local
        )

    [volumeid] =&gt; l1_
    [locked] =&gt; 1
    [isroot] =&gt; 1
    [phash] =&gt; 
)
</code></pre>
<p>返回<code>dir()</code>函数，然后在返回到<code>upload()</code>函数，将返回值赋给<code>upload()</code>函数中的<code>$dir</code>变量，</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId44.png" alt="20.png"></p>
<p>然后进行<code>mime</code>的判断，程序识别上传的php脚本的<code>mime</code>为<code>text/x-php</code>，跟进<code>allowPutMime()</code>函数，</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId45.png" alt="21.png"></p>
<p>从程序自带的注释中可以看出如果<code>uploadOrder</code>数组为<code>array(&#39;deny&#39;,&#39;allow&#39;)</code>，则默认允许上传<code>$mime</code>类型的文件。然后获取文件的大小，若文件大小不合法报错结束程序，之后<code>decode()</code>处理<code>$dst</code>(<code>POST</code><strong>传入的</strong><code>target</code><strong>值</strong>)返回结果赋给<code>$dstpath</code>，因为<code>$hash</code>为空数组，所以会调用<code>joinPathCE()</code>将<code>$dstpath</code>和<code>$name</code>(<strong>上传文件的文件名</strong>)拼接，然后检查文件是否存在。</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId46.png" alt="22.png"></p>
<p>最后调用<code>$this-&gt;saveCE()</code></p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId47.png" alt="23.png"></p>
<p>跟进<code>_save()</code>。</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId48.png" alt="24.png"></p>
<p>本地是利用Windows系统分析，<code>$path</code>为<code>C:\Users\admin\phpstudy_pro\WWW\wordpress\wp-content\plugins\wp-file-manager\lib\files\shell.php</code>;<code>$uri</code>为<code>C:\Windows\phpxxxx.tmp</code>，最后会调用<code>copy()</code>将上传的文件复制到<code>\wordpress\wp-content\plugins\wp-file-manager\lib\files\shell.php</code>，即完成了任意文件上传。</p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId49.png" alt="25.png"></p>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId51.png" alt="26.png"></p>
<p>访问<code>https://www.0-sec.org/wordpress/wp-content/plugins/wp-file-manager/lib/files/shell.php</code></p>
<p><img src="/resource/WordPressPlugin-FileManager%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId52.png" alt="27.png"></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Wordpress/Wordpress%20%E6%8F%92%E4%BB%B6%E6%BC%8F%E6%B4%9E/WordPress%20Plugin%20-%20File%20Manager%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qya100lgy8v17f5bfjhx" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Wordpress/Wordpress%20%E6%8F%92%E4%BB%B6%E6%BC%8F%E6%B4%9E/WordPress%20Plugin%20-%20Google%20Review%20Slider%206.1%20SQL%20Injection%20/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Wordpress/Wordpress%20%E6%8F%92%E4%BB%B6%E6%BC%8F%E6%B4%9E/WordPress%20Plugin%20-%20Easy%20WP%20SMTP%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%20/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>