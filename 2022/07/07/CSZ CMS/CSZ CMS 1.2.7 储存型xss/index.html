<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="CSZ CMS 1.2.7 储存型xss一、漏洞简介拥有访问私有消息的未授权用户可以向管理面板嵌入Javascript代码。 二、漏洞影响CSZ CMS 1.2.7 三、复现过程漏洞分析查看数据库中的email_logs可知，将访问的user-agent存储到了数据库中1.png 我们首先观察路由，漏洞点在&#x2F;member&#x2F;insertpm页面，查看控制器，找到cszcms&#x2F;controllers&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/CSZ%20CMS/CSZ%20CMS%201.2.7%20%E5%82%A8%E5%AD%98%E5%9E%8Bxss/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="CSZ CMS 1.2.7 储存型xss一、漏洞简介拥有访问私有消息的未授权用户可以向管理面板嵌入Javascript代码。 二、漏洞影响CSZ CMS 1.2.7 三、复现过程漏洞分析查看数据库中的email_logs可知，将访问的user-agent存储到了数据库中1.png 我们首先观察路由，漏洞点在&#x2F;member&#x2F;insertpm页面，查看控制器，找到cszcms&#x2F;controllers&#x2F;">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-08T06:25:54.413Z">
<meta property="article:modified_time" content="2021-04-21T01:23:46.000Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-CSZ CMS/CSZ CMS 1.2.7 储存型xss" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/CSZ%20CMS/CSZ%20CMS%201.2.7%20%E5%82%A8%E5%AD%98%E5%9E%8Bxss/" class="article-date">
  <time datetime="2022-07-08T06:25:54.413Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="CSZ-CMS-1-2-7-储存型xss"><a href="#CSZ-CMS-1-2-7-储存型xss" class="headerlink" title="CSZ CMS 1.2.7 储存型xss"></a>CSZ CMS 1.2.7 储存型xss</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>拥有访问私有消息的未授权用户可以向管理面板嵌入Javascript代码。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>CSZ CMS 1.2.7</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>查看数据库中的email_logs可知，将访问的user-agent存储到了数据库中1.png</p>
<p>我们首先观察路由，漏洞点在/member/insertpm页面，查看控制器，找到cszcms/controllers/Member.php</p>
<p>2.png找到insertpm方法：</p>
<p>3.png关注点在下半部分：</p>
<p>$this-&gt;input-&gt;post即是调用的system/core/Input.php的post方法：</p>
<p>4.png当$xss_clean的参数设置为true，则会进行xss过滤，这也是为什么发送信息处并没有出现xss</p>
<p>继续看，$this-&gt;Csz_auth_model-&gt;send_pm方法位于cszcms/models/Csz_auth_model.php中的send_pm():</p>
<pre><code>/**
     * Send multiple Private Messages
     * Send multiple private messages to another users
     * 
     * @param array $receiver_ids Array of User ids of private message receiver 
     * @param string $title Title/subject
     * @param string $message Message
     * @param int $sender_id User id of private message sender
     * @param string $re_message Reply the original message
     * 
     * @return array/bool Array with User ID&#39;s as key and TRUE or a specific error message OR FALSE if sender doesn&#39;t exist
     */
    public function send_pm($receiver_ids, $title, $message, $sender_id = &#39;&#39;, $re_message = &#39;&#39;) &#123;
        if (!$sender_id) &#123;
            $sender_id = $this-&gt;session-&gt;userdata(&#39;user_admin_id&#39;);
        &#125;
        if ($sender_id &amp;&amp; (!$this-&gt;is_useractive($sender_id))) &#123;
            return FALSE;
        &#125;else&#123;
            if ($receiver_ids &amp;&amp; is_numeric($receiver_ids) &amp;&amp; $sender_id != $receiver_ids) &#123;
                if($re_message)&#123; 
                    $message = &#39;&#123;[&#39; . str_replace(&quot;\r\n&quot; . &quot;\r\n&quot;, &quot;\r\n&quot;, $re_message) . &quot;]&#125; &quot; . &quot;\r\n&quot; . &quot;\r\n&quot; . $message;
                &#125;
                $data = array(
                    &#39;sender_id&#39; =&gt; $sender_id,
                    &#39;receiver_id&#39; =&gt; $receiver_ids,
                    &#39;title&#39; =&gt; $title,
                    &#39;message&#39; =&gt; $message,
                    &#39;date_sent&#39; =&gt; date(&#39;Y-m-d H:i:s&#39;)
                );
                $this-&gt;db-&gt;insert(&#39;user_pms&#39;, $data);
                $sender_user = $this-&gt;Csz_admin_model-&gt;getUser($sender_id);
                $receive_user = $this-&gt;Csz_admin_model-&gt;getUser($receiver_ids);
                if($receive_user-&gt;pm_sendmail == &#39;1&#39;)&#123;
                    $config = $this-&gt;Csz_model-&gt;load_config();
                    $message_html = &#39;Dear &#39; . $receive_user-&gt;name . &#39;,&lt;br&gt;&lt;br&gt;&#39; . $message . &#39;&lt;br&gt;&lt;br&gt;Best Regards,&lt;br&gt;&#39;.$sender_user-&gt;name;
                    @$this-&gt;Csz_model-&gt;sendEmail($receive_user-&gt;email, &#39;[PM] &#39; . $title . &#39; (&#39;.$config-&gt;site_name.&#39;)&#39;, $message_html, $sender_user-&gt;email, $sender_user-&gt;name);
                &#125;
                return TRUE;
            &#125;else&#123;
                return FALSE;
            &#125;
        &#125;
    &#125;
</code></pre>
<p>调用了@$this-&gt;Csz_model-&gt;sendEmail方法，位于cszcms/models/Csz_model.php，我们继续跟进：</p>
<pre><code>public function sendEmail($to_email, $subject, $message, $from_email, $from_name = &#39;&#39;, $bcc = &#39;&#39;, $reply_to = &#39;&#39;, $alt_message = &#39;&#39;, $attach_file = array(), $save_log = TRUE) &#123;
        $this-&gt;load-&gt;library(&#39;email&#39;);
        $load_conf = $this-&gt;load_config();
        $protocal = $load_conf-&gt;email_protocal;
        if (!$protocal) &#123;
            $protocal = &#39;mail&#39;;
        &#125;
        $config = array();
        $config[&#39;useragent&#39;] = $this-&gt;Csz_admin_model-&gt;cszGenerateMeta();
        $config[&#39;protocol&#39;] = $protocal;  /* mail, sendmail, smtp */
        if ($protocal == &#39;smtp&#39;) &#123;
            $config[&#39;smtp_host&#39;] = $load_conf-&gt;smtp_host;
            $config[&#39;smtp_user&#39;] = $load_conf-&gt;smtp_user;
            $config[&#39;smtp_pass&#39;] = $load_conf-&gt;smtp_pass;
            $config[&#39;smtp_port&#39;] = $load_conf-&gt;smtp_port;
        &#125; else if ($protocal == &#39;sendmail&#39; &amp;&amp; $load_conf-&gt;sendmail_path) &#123;
            $config[&#39;mailpath&#39;] = $load_conf-&gt;sendmail_path;
        &#125;
        $config[&#39;mailtype&#39;] = &#39;html&#39;;
        $config[&#39;charset&#39;] = &#39;utf-8&#39;;
        $config[&#39;wordwrap&#39;] = TRUE;
        $this-&gt;email-&gt;initialize($config);
        $this-&gt;email-&gt;set_newline(&quot;\r\n&quot;);
        $this-&gt;email-&gt;from($from_email, $from_name); // change it to yours
        $this-&gt;email-&gt;to($to_email); // change it to yours
        $this-&gt;email-&gt;subject($subject);
        $this-&gt;email-&gt;message($message);
        if ($bcc) &#123;
            $this-&gt;email-&gt;bcc($bcc);
        &#125;
        if($reply_to)&#123;
            $this-&gt;email-&gt;reply_to($reply_to);
        &#125;
        if ($alt_message) &#123;
            $this-&gt;email-&gt;set_alt_message($alt_message);
        &#125;
        if (is_array($attach_file) &amp;&amp; !empty($attach_file)) &#123;
            foreach ($attach_file as $value) &#123;
                $this-&gt;email-&gt;attach($value, &#39;attachment&#39;);
            &#125;
        &#125;
        if ($this-&gt;email-&gt;send()) &#123;
            $result = &#39;success&#39;;
        &#125; else &#123;
            $result = $this-&gt;email-&gt;print_debugger(FALSE);
        &#125;
        if($save_log === TRUE &amp;&amp; $load_conf-&gt;email_logs == 1)&#123;
            $data = array(
                &#39;to_email&#39; =&gt; $to_email,
                &#39;from_email&#39; =&gt; $from_email,
                &#39;from_name&#39; =&gt; $from_name,
                &#39;subject&#39; =&gt; $subject,
                &#39;message&#39; =&gt; $message,
                &#39;email_result&#39; =&gt; $result,
            );
            $this-&gt;db-&gt;set(&#39;user_agent&#39;, $this-&gt;input-&gt;user_agent(), TRUE);
            $this-&gt;db-&gt;set(&#39;ip_address&#39;, $this-&gt;input-&gt;ip_address(), TRUE);
            $this-&gt;db-&gt;set(&#39;timestamp_create&#39;, $this-&gt;timeNow(), TRUE);
            $this-&gt;db-&gt;insert(&#39;email_logs&#39;, $data);
            $this-&gt;db-&gt;cache_delete_all();
            unset($data);
        &#125;
        unset($to_email, $subject, $message, $from_email, $from_name, $bcc, $reply_to, $alt_message, $attach_file, $save_log, $config, $load_conf, $protocal);
        return $result;
    &#125;
</code></pre>
<p>关键就在于后面的数据库操作：</p>
<pre><code>$this-&gt;db-&gt;set(&#39;user_agent&#39;, $this-&gt;input-&gt;user_agent(), TRUE);
        $this-&gt;db-&gt;set(&#39;ip_address&#39;, $this-&gt;input-&gt;ip_address(), TRUE);
        $this-&gt;db-&gt;set(&#39;timestamp_create&#39;, $this-&gt;timeNow(), TRUE);
        $this-&gt;db-&gt;insert(&#39;email_logs&#39;, $data);
        $this-&gt;db-&gt;cache_delete_all();
</code></pre>
<p>$this-&gt;db-&gt;set方法位于：system/database/DB_query_builder.php：</p>
<pre><code>/**
 * The &quot;set&quot; function.
 *
 * Allows key/value pairs to be set for inserting or updating
 *
 * @param   mixed
 * @param   string
 * @param   bool
 * @return  CI_DB_query_builder
 */
public function set($key, $value = &#39;&#39;, $escape = NULL)
&#123;
    $key = $this-&gt;_object_to_array($key);

    if ( ! is_array($key))
    &#123;
        $key = array($key =&gt; $value);
    &#125;

    is_bool($escape) OR $escape = $this-&gt;_protect_identifiers;

    foreach ($key as $k =&gt; $v)
    &#123;
        $this-&gt;qb_set[$this-&gt;protect_identifiers($k, FALSE, $escape)] = ($escape)
            ? $this-&gt;escape($v) : $v;
    &#125;

    return $this;
&#125;
</code></pre>
<p>简单理解即为插入或更新值作初始化</p>
<p>继续，$this-&gt;input-&gt;user_agent()位于：system/core/Input.php，其具体实现如下：</p>
<pre><code>/**
 * Fetch User Agent string
 *
 * @return  string|null User Agent string or NULL if it doesn&#39;t exist
 */
public function user_agent($xss_clean = NULL)
&#123;
    return $this-&gt;_fetch_from_array($_SERVER, &#39;HTTP_USER_AGENT&#39;, $xss_clean);
&#125;
</code></pre>
<p>这里的xss过滤操作默认是null，也就是没有过滤</p>
<p>这就是问题所在，我们即可以通过篡改user_agent的值实现xss，往下看，<code>$this-&gt;db-&gt;insert(&#39;email_logs&#39;, $data)</code>即向emali_logs表插入数据，<code>$this-&gt;db-&gt;insert</code>实现如下（system/core/Input.php）：</p>
<pre><code>/**
     * Insert
     *
     * Compiles an insert string and runs the query
     *
     * @param   string  the table to insert data into
     * @param   array   an associative array of insert values
     * @param   bool    $escape Whether to escape values and identifiers
     * @return  bool    TRUE on success, FALSE on failure
     */
    public function insert($table = &#39;&#39;, $set = NULL, $escape = NULL)
    &#123;
        if ($set !== NULL)
        &#123;
            $this-&gt;set($set, &#39;&#39;, $escape);
        &#125;

        if ($this-&gt;_validate_insert($table) === FALSE)
        &#123;
            return FALSE;
        &#125;

        $sql = $this-&gt;_insert(
            $this-&gt;protect_identifiers(
                $this-&gt;qb_from[0], TRUE, $escape, FALSE
            ),
            array_keys($this-&gt;qb_set),
            array_values($this-&gt;qb_set)
        );

        $this-&gt;_reset_write();
        return $this-&gt;query($sql);
    &#125;
</code></pre>
<p>依然没有任何过滤</p>
<p>然而，关于为什么登入后台即会弹窗，搜索一番后发现，开发者直接将其echo出来（cszcms/views/admin/home.php）：</p>
<p>5.png</p>
<p>6.png</p>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>新建一个用户1.png</p>
<p>点击inbox发送私信，选定管理员用户</p>
<p>2.png修改User-Agent为<code>alert(1)</code>3.png</p>
<p>管理员登陆后台即触发xss4.png</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7730/#toc-6">https://xz.aliyun.com/t/7730\#toc-6</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/CSZ%20CMS/CSZ%20CMS%201.2.7%20%E5%82%A8%E5%AD%98%E5%9E%8Bxss/" data-id="cl5c2qnjs0045y8v1fiol1dkv" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/CSZ%20CMS/%EF%BC%88CVE-2019-13086%EF%BC%89CSZ%20CMS%201.2.2%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/CouchDB/%EF%BC%88CVE-2017-12636%EF%BC%89Couchdb%20%E4%BB%BB%E6%84%8F%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>