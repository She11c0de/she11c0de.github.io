<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2020-6949）HashBrown CMS postUser 函数存在提权漏洞一、漏洞简介HashBrown CMS是一套开源的无头内容管理系统（CMS）。 HashBrown CMS1.3.3及之前版本中的’postUser’函数存在提权漏洞。攻击者可利用该漏洞修改管理员账户的哈希密码或重置该账户。 二、漏洞影响HashBrown CMS 1.3.3及之前版本 三、复现过程在读和部">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Hashbrown%20CMS/%EF%BC%88CVE-2020-6949%EF%BC%89HashBrown%20CMS%20postUser%20%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2020-6949）HashBrown CMS postUser 函数存在提权漏洞一、漏洞简介HashBrown CMS是一套开源的无头内容管理系统（CMS）。 HashBrown CMS1.3.3及之前版本中的’postUser’函数存在提权漏洞。攻击者可利用该漏洞修改管理员账户的哈希密码或重置该账户。 二、漏洞影响HashBrown CMS 1.3.3及之前版本 三、复现过程在读和部">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId24.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId25.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId26.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId27.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId28.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId29.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId30.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId31.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId32.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId33.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId34.png">
<meta property="article:published_time" content="2022-07-08T06:25:57.236Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.673Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId24.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Hashbrown CMS/（CVE-2020-6949）HashBrown CMS postUser 函数存在提权漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Hashbrown%20CMS/%EF%BC%88CVE-2020-6949%EF%BC%89HashBrown%20CMS%20postUser%20%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:25:57.236Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2020-6949）HashBrown-CMS-postUser-函数存在提权漏洞"><a href="#（CVE-2020-6949）HashBrown-CMS-postUser-函数存在提权漏洞" class="headerlink" title="（CVE-2020-6949）HashBrown CMS postUser 函数存在提权漏洞"></a>（CVE-2020-6949）HashBrown CMS postUser 函数存在提权漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>HashBrown CMS是一套开源的无头内容管理系统（CMS）。 HashBrown CMS<br>1.3.3及之前版本中的’postUser’函数存在提权漏洞。攻击者可利用该漏洞修改管理员账户的哈希密码或重置该账户。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>HashBrown CMS 1.3.3及之前版本</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>在读和部分此cms的源码后，希望对用户管理方面做个审计。这款CMS<br>的用户分为两种，一种是admin 权限用户，<br>可以创建和设置别的用户的属性，比如参管理那些项目，用户名密码设置等等。另外一种是editor<br>账户，其能管理哪些项目是由admin 设置的，editor<br>账户只能修改自己的用户名和密码。如下图这里的三个账户，admin 和 aaaa<br>是admin 用户，bbbb 是editor 账户</p>
<p><img src="/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId24.png"></p>
<p>由于该CMS 不提供用户注册和找回密码的功能，<br>所以没有太多的地方可以去尝试突破，我就尝试聚焦有没有办法把editor<br>账户提权成admin 账户，那editor<br>账户只有一个地方可以修改自己的密码和其他属性。</p>
<p><img src="/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId25.png"></p>
<p>随意做个修改后在burpsuit 截取请求如下。</p>
<pre><code>POST http://10.200.159.166:8080/api/users/44019b092718ccde HTTP/1.1
Host: 10.200.159.166:8080
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/json; charset=utf-8
Content-Length: 159
Cookie: token=2e10b7f6b3cc8fbf81452d980029d6e843ac5760


&#123;&quot;id&quot;:&quot;44019b092718ccde&quot;,&quot;viewedBy&quot;:&quot;&quot;,&quot;viewedOn&quot;:null,&quot;isAdmin&quot;:false,&quot;isCurrent&quot;:false,&quot;username&quot;:&quot;bbbb&quot;,&quot;fullName&quot;:&quot;bbbb&quot;,&quot;email&quot;:&quot;&quot;,&quot;theme&quot;:&quot;&quot;,&quot;scopes&quot;:&#123;&#125;&#125;
</code></pre>
<p>Grep 定位到文件Server/Controller/UserController.js</p>
<pre><code>root@SIN-Ubuntu-A:~/hashbrown-cms/hashbrown-cms-1.3.1/src# grep /api/users/ * -r

Server/Controller/UserController.js:        app.get(&#39;/api/users/:id&#39;, this.middleware(&#123;needsAdmin: true, setProject: false&#125;), this.getUser);

Server/Controller/UserController.js:        app.post(&#39;/api/users/first&#39;, this.createFirstAdmin);

Server/Controller/UserController.js:        app.post(&#39;/api/users/new&#39;, this.middleware(&#123;setProject: false, needsAdmin: true&#125;), this.createUser);

Server/Controller/UserController.js:        app.post(&#39;/api/users/:id&#39;, this.middleware(&#123;setProject: false&#125;), this.postUser);

Server/Controller/UserController.js:        app.delete(&#39;/api/users/:id&#39;, this.middleware(&#123;setProject: false, needsAdmin: true&#125;), this.deleteUser);
</code></pre>
<p>其中的postUser function, 其中可看到该函数在151行会对cookie 里面的token<br>进行验证，在153 行获取user 的scope。Scope 这里指的就是是不是admin<br>用户，可以管理那些项目。但是这里有个要注意的地方148行的req.params.id<br>是post 内容里面json id字段的值，但是155行的user.id 是url<br>末段的id值。对于editor<br>用户来说应该永远一直，因为editor只能修改自己账户。Admin<br>用户有可能不一样，因为admin<br>用户是可修改其他账户的。我们可以看到156到159行是做了安全性检察的，如果当前user<br>id 获取的属性没有users 的scope（不是admin<br>权限账户），那就用数据库里面的属性覆盖当前post提交内容的isAdmin 和scopes<br>两个内容，保证不会让editor 自己提权到admin 账户。到此没有看到对其他post<br>提交内容做检察。之后168行用查询id的方式对响应的条目做修改。</p>
<p><img src="/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId26.png"></p>
<p>此时如果我们在数据库中查看的话可以有个更清晰的认识，如果第一个条目是aaaa账户，isadmin设置为true，第二个是admin账户，第三个是bbbb账户，每个账户password<br>字段包含hash，salt 和token字段。</p>
<p><img src="/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId27.png"></p>
<p>这里我产生了一个想法，如果我是bbbb账户，提交修改自己账户请求的时候写入的是aaaa账户的id会发生什么样的事情呢？但是做这件事之前我们要先确定bbbb账户有没有办法得到aaaa账户的id。在阅读/Server/Controller/UserController.js源码后确实是可以的。如下31行，发送get<br>请求到API可以获取到当前项目的所有用户，包括所有的admin 账户。而项目id<br>等是当管理员赋予editor权限后，登录后从请求中就可以拿到的。</p>
<p><img src="/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId28.png"></p>
<p>发送请求得到账户的信息。</p>
<p><img src="/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId29.png"></p>
<p>那接下来我们就可以篡改bbbb发送修改自己账户的请求，但是post提交的id是aaaa账户。如下图保持了url最后一段是bbbb自己的id，post<br>提交的id是aaaa 账户，显示200 ok。</p>
<p><img src="/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId30.png"></p>
<p>此时如果查看数据库会看到确实aaaa和bbbb 条目的id一样，但是bbbb<br>的内容并没有实际的改变，只是换了一个id。对别的账户也没有任何的修改。</p>
<p><img src="/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId31.png"></p>
<p>但其实如果我们再深一步就会发现这有利用的点。在之前的源码中168行HashBrown.Service.UserService.updateUserById(id,<br>properties);<br>使用了查询匹配id做修改的方式。我们追踪这个函数。在文件Server/Service/UserService.js中看到mergeOne的数据库操作方式。这意味这如果aaaa和bbbb有相同的id，但是aaaa<br>在数据库的前面位置，如果bbbb提出对这个id<br>的修改，修改会被接受但是写入aaaa的条目。</p>
<p><img src="/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId32.png"></p>
<p>接下来我们来做测试,提交的ID全部改成aaaa账户的id，因为现在原始的bbbb的id已经不存在了。还提交了aaaa<br>的fullname 和password 字段修改其密码是和bbbb同样的内容。</p>
<p><img src="/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId33.png"></p>
<p>结果如下，可以看到aaaa的条目修改后接受了fullname，和password，isadmin和scopes<br>继承了bbbb的内容，这是因为前面源码中的156到159行的作用。</p>
<p><img src="/resource/(CVE-2020-6949)HashBrownCMSpostUser%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId34.png"></p>
<p>到此为止，我们虽然不能将bbbb账户自己提升成admin，但是可以去修改别的账户的关键参数包括密码，这无疑是一个用户权限的漏洞。经过相似的分析修改username<br>可以达到类似的效果。随后我提交此漏洞，开发人员征求了我的意见以后保证无法修改成同样的id或者username<br>来规避了这个问题。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MjM5MDYxODkyMA==&amp;mid=2651345793&amp;idx=1&amp;sn=02381bb3dbd4679b12be4628d665e815&amp;chksm=bdbef7c68ac97ed063e8df46a42e2a111dfd52f108f6b267f8dfc183b6b0ed3f87b6af757487&amp;mpshare=1&amp;scene=1&amp;srcid=&amp;sharer_sharetime=1582514363054&amp;sharer_shareid=346bf064ccfaeb680ec3e1af3a4fc9a8&amp;key=019d47c25aa835ac2d58a398c473737e01644761ca991f7009ada9eb1ef69e4dd41b2008c27db720006e0858455f920d0801d9feae53aa4314f05d6e310a7290ae2b93e17343c13f6a9f2ce360254195&amp;ascene=1&amp;uin=MTU0OTU5NDkzMA==&amp;devicetype=Windows+10&amp;version=62080079&amp;lang=zh_CN&amp;exportkey=AZc+xZJwp8CueCtaKThWQrI=&amp;pass_ticket=l4uNHDrGwGqrS+mJVv56i4FzemghweUeBbN1BEETCGd3TqEDSTcwvRMSxogubM8j">https://mp.weixin.qq.com/s?__biz=MjM5MDYxODkyMA==&amp;mid=2651345793&amp;idx=1&amp;sn=02381bb3dbd4679b12be4628d665e815&amp;chksm=bdbef7c68ac97ed063e8df46a42e2a111dfd52f108f6b267f8dfc183b6b0ed3f87b6af757487&amp;mpshare=1&amp;scene=1&amp;srcid=&amp;sharer_sharetime=1582514363054&amp;sharer_shareid=346bf064ccfaeb680ec3e1af3a4fc9a8&amp;key=019d47c25aa835ac2d58a398c473737e01644761ca991f7009ada9eb1ef69e4dd41b2008c27db720006e0858455f920d0801d9feae53aa4314f05d6e310a7290ae2b93e17343c13f6a9f2ce360254195&amp;ascene=1&amp;uin=MTU0OTU5NDkzMA%3D%3D&amp;devicetype=Windows+10&amp;version=62080079&amp;lang=zh_CN&amp;exportkey=AZc%2BxZJwp8CueCtaKThWQrI%3D&amp;pass_ticket=l4uNHDrGwGqrS%2BmJVv56i4FzemghweUeBbN1BEETCGd3TqEDSTcwvRMSxogubM8j</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Hashbrown%20CMS/%EF%BC%88CVE-2020-6949%EF%BC%89HashBrown%20CMS%20postUser%20%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qqno008oy8v1d2wwd2j8" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Heybbs/Heybbs%201.2%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Hashbrown%20CMS/%EF%BC%88CVE-2020-6948%EF%BC%89HashBrown%20CMS%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>