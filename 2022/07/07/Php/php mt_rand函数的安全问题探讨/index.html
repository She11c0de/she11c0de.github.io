<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="php mt_rand函数的安全问题探讨mt_rand() 函数的安全性问题php -r &#39;echo getrandmax().&quot;\n&quot;.mt_getrandmax().&quot;\n&quot;; echo (pow(2,31)-1).&quot;\n&quot;;&#39;   在我的 linux 64 位系统中,rand() 和 mt_rand()产生的最大随机">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/Php/php%20mt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="php mt_rand函数的安全问题探讨mt_rand() 函数的安全性问题php -r &#39;echo getrandmax().&quot;\n&quot;.mt_getrandmax().&quot;\n&quot;; echo (pow(2,31)-1).&quot;\n&quot;;&#39;   在我的 linux 64 位系统中,rand() 和 mt_rand()产生的最大随机">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://she11c0de.github.io/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId22.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId24.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId25.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId26.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId27.png">
<meta property="og:image" content="https://she11c0de.github.io/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId29.png">
<meta property="article:published_time" content="2022-07-08T06:26:01.291Z">
<meta property="article:modified_time" content="2022-07-08T07:24:51.404Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://she11c0de.github.io/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId22.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Php/php mt_rand函数的安全问题探讨" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Php/php%20mt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/" class="article-date">
  <time datetime="2022-07-08T06:26:01.291Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="php-mt-rand函数的安全问题探讨"><a href="#php-mt-rand函数的安全问题探讨" class="headerlink" title="php mt_rand函数的安全问题探讨"></a>php mt_rand函数的安全问题探讨</h1><h2 id="mt-rand-函数的安全性问题"><a href="#mt-rand-函数的安全性问题" class="headerlink" title="mt_rand() 函数的安全性问题"></a>mt_rand() 函数的安全性问题</h2><pre><code>php -r &#39;echo getrandmax().&quot;\n&quot;.mt_getrandmax().&quot;\n&quot;; echo (pow(2,31)-1).&quot;\n&quot;;&#39;
</code></pre>
<p><img src="/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId22.png"></p>
<p>在我的 linux 64 位系统中,rand() 和 mt_rand()<br>产生的最大随机数都是2147483647, 正好是 2^31-1 ,<br>也就是说随机播种的种子也是在这个范围中,0 – 2147483647<br>的这个范围是允许我们进行爆破的. 但是用 php爆破比较慢</p>
<p>这里放一个爆破poc的d地址</p>
<p>php_mt_seed爆破程序 <a target="_blank" rel="noopener" href="https://github.com/ianxtianxt/php-mt_rand">https://github.com/ianxtianxt/php-mt_rand</a></p>
<p>下面演示一下它的用法:</p>
<p><img src="/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId24.png"></p>
<p>在例子中,我没有自己播种种子,而是让php自动去播种一个种子并产生一个随机数,然后用<br>php_mt_seed<br>这个工具把产生的随机数作为参数,去爆破种子,最后的得到了四个结果.<br>经过验证,四个结果都是对的.都会产生这样的一个随机数.</p>
<p>但是还有一个疑问,就是 php manual 中说,自动播种种子是指:在每次调用<br>mt_rand()函数之前都播种一次种子呢,还是多次调用<br>mt_rand()函数之前,只播种一次种子呢,这对于我们能否猜到产生的随机数序列至关重要.</p>
<p>看下面的测试:</p>
<p><img src="/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId25.png"></p>
<p>在测试中,在没有进行手工播种的情况下产生两个连续的随机数,然后去爆破种子,得到了四个可能种子,经过测试发现其中一个种子产生的随机数序列和预期的相同,所以可以猜想在php中产生一系列的随机数时,只进行了一次播种!</p>
<p>那请考虑下面代码的安全性:</p>
<pre><code>&lt;?php
function wp_generate_password($length = 12, $special_chars = true) &#123;
  $chars = &#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;;
  if ( $special_chars )
  $chars .= &#39;!@#$%^&amp;*()&#39;;

  $password = &#39;&#39;;
  for ( $i = 0; $i &lt; $length; $i++ )
  $password .= substr($chars, mt_rand(0, strlen($chars) - 1), 1);
  return $password;
&#125;
$key = wp_generate_password(16, false);
echo &quot;[*] This is a key for public:&quot;.$key.&quot;\n&quot;;

$private = wp_generate_password(10,false);
echo &quot;[*] Create a private key which you don&#39;t know:&quot;.$private.&quot;\n&quot;;
?&gt;
</code></pre>
<p>我们是否可以根据公开的key,猜到 $private 呢?</p>
<p>运行一次上面的代码:</p>
<pre><code>njctf$ php mtRand.php
[*] This is a key for public:uS66FDD9LCR62UV3
[*] Create a private key which you don\&#39;t know:t3JSUHzYAv
</code></pre>
<p>下面演示破解过程,首先获得public key在每一位在字符串中的位置:</p>
<pre><code>&lt;?php
$str = &quot;uS66FDD9LCR62UV3&quot;;
$randStr = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;;

for($i=0;$i&lt;strlen($str);$i++)&#123;
   $pos = strpos($randStr,$str[$i]);
   echo $pos.&quot; &quot;.$pos.&quot; &quot;.&quot;0 &quot;.(strlen($randStr)-1).&quot; &quot;;
   //整理成方便 php_mt_seed 测试的格式
  //php_mt_seed VALUE_OR_MATCH_MIN [MATCH_MAX [RANGE_MIN RANGE_MAX]]
&#125;
echo &quot;\n&quot;;
?&gt;
</code></pre>
<p>然后用 php_mt_seed 进行破解,这个需要的时间还是挺长的,几分钟左右.</p>
<p><img src="/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId26.png"></p>
<p>已经成功的破解了一个seed,下面看这个seed对不对:</p>
<pre><code>&lt;?php
function wp_generate_password($length = 12, $special_chars = true) &#123;
  $chars = &#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;;
  if ( $special_chars )
  $chars .= &#39;!@#$%^&amp;*()&#39;;

  $password = &#39;&#39;;
  for ( $i = 0; $i &lt; $length; $i++ )
  $password .= substr($chars, mt_rand(0, strlen($chars) - 1), 1);
  return $password;
&#125;
mt_srand(4030923041); //手工添加了这个种子
$key = wp_generate_password(16, false);
echo &quot;[*] This is a key for public:&quot;.$key.&quot;\n&quot;;
$private = wp_generate_password(10,false);
echo &quot;[*] Create a private key which you don&#39;t know:&quot;.$private.&quot;\n&quot;;
?&gt;
</code></pre>
<p>跟刚才的结果一模一样 :</p>
<p><img src="/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId27.png"></p>
<p>这样就说明了,我们只需要拿到public key,就可以预测到private key 的值了.</p>
<p>但是在有的一些环境中，public key可能在private<br>key之后产生，但是知道private key的位数 怎么预测private key呢？<br>强大的php_mt_seed_4.0,支持一些统配的写法，把未知的都写成参数 0 0 0 0<br>就可以了php_mt_seed详细的使用说明。它就会跳过前面的mt_rand()的一些输出，直接匹配后面的：</p>
<p>下面测试我们获得了private key，来猜测public key的情况。</p>
<pre><code>&lt;?php
 # mtRand.php
$str = &quot;t3JSUHzYAv&quot;;
$randStr = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;;

for($i=0;$i&lt;strlen($str);$i++)&#123;
   $pos = strpos($randStr,$str[$i]);
   echo $pos.&quot; &quot;.$pos.&quot; &quot;.&quot;0 &quot;.(strlen($randStr)-1).&quot; &quot;;
   //整理成方便 php_mt_seed 测试的格式
  //php_mt_seed VALUE_OR_MATCH_MIN [MATCH_MAX [RANGE_MIN RANGE_MAX]]
&#125;
echo &quot;\n&quot;;
?&gt;
</code></pre>
<p>下面就开始破解：</p>
<pre><code>➜  Desktop echo  $(python -c &quot;print &#39;0 &#39;*64&quot;) $(php mtRand.php) | xargs   ~/script/php_mt_seed-4.0/php_mt_seed
Pattern: SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62
Version: 3.0.7 to 5.2.0
Found 0, trying 0xfc000000 - 0xffffffff, speed 65.2 Mseeds/s
Version: 5.2.1+
Found 0, trying 0xf0000000 - 0xf1ffffff, speed 5.5 Mseeds/s
seed = 0xf0430121 = 4030923041 (PHP 5.2.1 to 7.0.x; HHVM)
Found 1, trying 0xfe000000 - 0xffffffff, speed 5.5 Mseeds/s
Found 1
</code></pre>
<p>可以看到破解得到的seed和之前的一样。</p>
<p>接下来看一个 njctf中的一个例子,只贴部分关键代码:</p>
<pre><code>&lt;?php
function random_str($length = &quot;32&quot;)
&#123;
    $set = array(&quot;a&quot;, &quot;A&quot;, &quot;b&quot;, &quot;B&quot;, &quot;c&quot;, &quot;C&quot;, &quot;d&quot;, &quot;D&quot;, &quot;e&quot;, &quot;E&quot;, &quot;f&quot;, &quot;F&quot;,
        &quot;g&quot;, &quot;G&quot;, &quot;h&quot;, &quot;H&quot;, &quot;i&quot;, &quot;I&quot;, &quot;j&quot;, &quot;J&quot;, &quot;k&quot;, &quot;K&quot;, &quot;l&quot;, &quot;L&quot;,
        &quot;m&quot;, &quot;M&quot;, &quot;n&quot;, &quot;N&quot;, &quot;o&quot;, &quot;O&quot;, &quot;p&quot;, &quot;P&quot;, &quot;q&quot;, &quot;Q&quot;, &quot;r&quot;, &quot;R&quot;,
        &quot;s&quot;, &quot;S&quot;, &quot;t&quot;, &quot;T&quot;, &quot;u&quot;, &quot;U&quot;, &quot;v&quot;, &quot;V&quot;, &quot;w&quot;, &quot;W&quot;, &quot;x&quot;, &quot;X&quot;,
        &quot;y&quot;, &quot;Y&quot;, &quot;z&quot;, &quot;Z&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;);
    $str = &#39;&#39;;
    for ($i = 1; $i &lt;= $length; ++$i) &#123;
        $ch = mt_rand(0, count($set) - 1);
        $str .= $set[$ch];
    &#125;
    return $str;
&#125;
session_start();

$seed = rand(0,999999999);
mt_srand($seed);
$ss = mt_rand();
$hash = md5(session_id() . $ss);
setcookie(&#39;SESSI0N&#39;, $hash, time() + 3600);

$filename = &#39;./uP1O4Ds/&#39; . random_str() . &#39;_&#39; . $_FILES[&#39;file-upload-field&#39;][&#39;name&#39;];
?&gt;
</code></pre>
<p>我们的目标是猜测出filename. 这里 $seed 是<br>rand(0,999999999)生成的,我们不知道,但是$hash = md5(session_id() .<br>$ss);我们却是知道的,在 cookie的SESSION中,当把cookie中的 PHPSESSID<br>设为空的时候,session_id()就也是空了,通过结hash,就可以获得 mt_rand()<br>产生的第一个随机数,然后用<br>php_mt_seed这工工具爆破种子,就可以直接算出文件名了.</p>
<p>rand() 函数的安全性问题 rand() 函数在产生随机数的时候没有调用<br>srand(),则产生的随机数是有规律可询的.<br>具体的说明请看这里<a target="_blank" rel="noopener" href="http://www.sjoerdlangkemper.nl/2016/02/11/cracking-php-rand/">http://www.sjoerdlangkemper.nl/2016/02/11/cracking-php-rand/</a><br>产生的随机数可以用下面这个公式预测 : state[i] = state[i-3] +<br>state[i-31] (一般预测值可能比实际值要差1) 写下面测试代码,验证一下:</p>
<pre><code>&lt;?php
$randStr = array();
for($i=0;$i&lt;50;$i++)&#123;  //先产生 32个随机数
    $randStr[$i]=rand(0,30);
    if($i&gt;=31) &#123;
        echo  &quot;$randStr[$i]=(&quot;.$randStr[$i-31].&quot;+&quot;.$randStr[$i-3].&quot;) mod 31&quot;.&quot;\n&quot;;
    &#125;
&#125;
?&gt;
</code></pre>
<p>看一下结果:</p>
<p><img src="/resource/phpmt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/media/rId29.png"></p>
<p>发现预测的值,基本都是对的,这样就可以根据之前生成的随机数,预</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Php/php%20mt_rand%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8/" data-id="cl5c2qtr900dhy8v1779k74xc" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/Php/Php%20XDebug%20%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95%E6%BC%8F%E6%B4%9E/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/PbootCMS/%EF%BC%88CVE-2018-16357%EF%BC%89PbootCMS%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>